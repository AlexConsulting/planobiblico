<!DOCTYPE html>
<html lang="pt" class="">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Plano de Leitura B√≠blica</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <script src="https://cdn.tailwindcss.com"></script>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/lipis/flag-icon-css@1.0/css/flag-icon.min.css"/>
  
  <script type="module" src="https://unpkg.com/lucide@0.259.0/dist/lucide.esm.js"></script>
  <script nomodule src="https://unpkg.com/lucide@0.259.0/dist/lucide.js"></script>

  <script>
    tailwind.config = {
      darkMode: 'class', // Ativa o modo escuro baseado na classe 'dark'
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', 'sans-serif'],
          },
          colors: {
            // Usamos Indigo como primary para consist√™ncia
            'primary': {
              500: '#4f46e5', // Indigo padr√£o
              600: '#4338ca', // Indigo mais escuro para hover
            },
            // NOVO: Cor para o destaque META
            'meta': {
                500: '#10b981', // Emerald
                600: '#059669',
            }
          }
        }
      }
    }
  </script>

  <style>
    /* pequeno polimento */
    .plan-button:active, #idiomaToggle:active, #btnTema:active, #btnMeta:active { transform: scale(.995); }
    /* transi√ß√£o suave para a barra de progresso */
    #progressoBar { transition: width 350ms ease; }
    
    /* Estilo para o destaque META (Contorno) */
    #btnMeta:active { 
        box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.5); /* Contorno suave Esmeralda */
    }

    /* Destaque visual para o dia atual no grid de leitura */
    .today-highlight {
        border: 2px dashed #3b82f6 !important; /* Cor azul suave */
        background-color: #eff6ff !important; /* Azul-50 claro */
        transform: scale(1.01);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
    }
    .dark .today-highlight {
        --tw-bg-opacity: 1; 
        background-color: rgb(30 41 59 / var(--tw-bg-opacity)) !important; /* slate-800 */
        border-color: #60a5fa !important; /* Blue-400 light */
    }

    /* Destaque visual para o dia META (Pr√≥ximo Dia Pendente) */
    .next-day-highlight {
        border: 3px solid #10b981 !important; /* Esmeralda para "Meta" */
        background-color: #f0fdf4 !important; /* Esmeralda-50 claro */
        transform: scale(1.02);
        box-shadow: 0 4px 16px rgba(16, 185, 129, 0.3);
    }
    .dark .next-day-highlight {
        --tw-bg-opacity: 1; 
        background-color: rgb(6 78 59 / var(--tw-bg-opacity)) !important; /* Emerald-900 */
        border-color: #34d399 !important; /* Emerald-400 light */
    }
  </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-screen flex flex-col font-sans">

  <header class="p-4 sm:p-6 bg-white dark:bg-gray-800 shadow-sm border-b border-gray-100 dark:border-gray-700">
    <div class="max-w-7xl mx-auto flex items-center justify-between gap-4">
      <div class="flex items-center gap-3">
        <div class="rounded-xl bg-primary-500 text-white w-10 h-10 flex items-center justify-center text-xl font-extrabold shadow-md">B</div>
        <div>
          <h1 id="tituloApp" class="text-xl font-bold">üìÖ Plano de Leitura B√≠blica</h1>
          <p id="subtituloApp" class="text-sm text-gray-600 dark:text-gray-400">Escolha um plano e comece hoje</p>
        </div>
      </div>

      <div class="flex items-center gap-2">
        <div id="idiomaDropdown" class="relative">
            <button id="idiomaToggle" class="px-3 py-2 rounded-xl bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 transition font-medium flex items-center justify-center gap-1" aria-label="Alterar idioma">
                <span id="currentFlag" class="flag-icon"></span>
            </button>

            <div id="idiomaMenu" class="absolute right-0 mt-2 w-20 bg-white dark:bg-gray-700 rounded-xl shadow-2xl py-1 z-10 hidden ring-1 ring-black ring-opacity-5 origin-top-right transition-all duration-150 transform scale-95 opacity-0">
                <button class="idioma-item w-full text-center px-4 py-2 text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-600 flex items-center justify-center" data-lang="pt">
                    <span class="flag-icon flag-icon-br"></span>
                </button>
                <button class="idioma-item w-full text-center px-4 py-2 text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-600 flex items-center justify-center" data-lang="en">
                    <span class="flag-icon flag-icon-us"></span>
                </button>
                <button class="idioma-item w-full text-center px-4 py-2 text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-600 flex items-center justify-center" data-lang="es">
                    <span class="flag-icon flag-icon-es"></span>
                </button>
            </div>
        </div>
        
        <button id="btnMeta" class="p-2 px-3 rounded-xl bg-meta-500 text-white hover:bg-meta-600 transition flex items-center justify-center font-semibold text-sm shadow-md shadow-meta-500/30" aria-label="Ir para a meta de leitura">
          üìÖ <span id="btnMetaText" class="ml-1 hidden sm:inline">META</span>
        </button>

        <button id="btnTema" class="p-2 px-3 rounded-xl bg-gray-200 dark:bg-gray-700 hover:scale-105 transition flex items-center justify-center font-semibold text-sm" aria-label="Alternar tema">
          <span id="themeStatusText">üåô</span>
        </button>
      </div>
    </div>
  </header>
  
  <main class="p-4 sm:p-6 flex-1 overflow-auto">
    
    <section id="paginaSelecao" class="pagina max-w-7xl mx-auto w-full">
      <h2 id="tituloSelecao" class="mt-8 mb-4 text-center text-xl font-bold text-gray-700 dark:text-gray-300">Escolha seu Plano de Leitura</h2>
      <p id="subtituloSelecao" class="text-center text-gray-500 dark:text-gray-400 mb-8">Seu plano ser√° salvo automaticamente.</p>
      
      <div id="gridPlanos" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mx-auto mt-4">
        </div>
    </section>

    <section id="paginaPlano" class="pagina max-w-7xl mx-auto w-full hidden-page">
      
      <div class="px-1 mt-0">
        <div class="flex items-center justify-between mb-2">
          <div class="text-base font-semibold" id="textoProgresso">Progresso: 0 / 365</div>
          <a href="#" id="trocarPlanoLink" class="text-sm text-primary-500 font-medium hover:text-primary-600 transition flex items-center">
            <span id="textoPlanoAtual">Plano: Tradicional</span>
            <i data-lucide="chevron-right" class="lucide w-4 h-4 ml-1"></i>
          </a>
        </div>
        <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-3.5 overflow-hidden">
          <div id="progressoBar" class="bg-primary-500 h-3.5 rounded-full" style="width:0%"></div>
        </div>
        
        <div class="mt-4 flex items-center justify-between px-1 border-b pb-3 border-gray-200 dark:border-gray-700">
            <button id="btnConfiguracao" class="text-sm text-gray-500 dark:text-gray-400 font-medium hover:text-primary-500 transition flex items-center">
                <i data-lucide="settings" class="lucide w-4 h-4 mr-1"></i>
                <span id="textoConfiguracao">Configura√ß√µes do Plano</span>
            </button>
            <span id="textoDataInicio" class="text-sm text-right text-gray-500 dark:text-gray-400">In√≠cio: N√£o definido</span>
        </div>

      </div>
      
      <div class="mt-8">
        <h2 class="text-xl font-bold mb-4 px-1">Selecione o M√™s</h2>
        <div id="meses" class="flex gap-2 overflow-x-auto pb-3 px-1 border-b border-gray-200 dark:border-gray-700"></div>
      </div>

      <div id="dias" class="mt-6 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 xl:grid-cols-7 gap-4 px-1">
        </div>
    </section>

  </main>
  
  <div id="modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50 p-4 transition-opacity duration-300" style="opacity:0;" aria-modal="true" role="dialog">
    <div id="modalContent" class="bg-white dark:bg-gray-800 p-6 rounded-3xl w-full max-w-md shadow-2xl scale-95 transition-transform duration-300">
      <div class="flex justify-between items-start">
        <div class="flex flex-col">
          <h3 id="modalTitulo" class="text-2xl font-extrabold text-primary-500"></h3>
          <p id="modalStatus" class="mt-1 text-sm text-red-600 dark:text-red-400 italic font-semibold hidden"></p> 
        </div>
        <button id="fecharModal" class="p-1 rounded-full text-gray-500 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition">
          <i data-lucide="x" class="lucide w-6 h-6"></i>
        </button>
      </div>

      <div id="modalCustomContent" class="mt-4 space-y-4 text-gray-700 dark:text-gray-200 border-t pt-4 border-gray-200 dark:border-gray-700">
        <ul id="modalLeituras" class="space-y-2"></ul>
        <div id="modalConfiguracao" class="hidden">
            <p id="modalMsg"></p>
            <input type="date" id="inputDataInicio" class="w-full mt-2 p-2 rounded-xl bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-center font-semibold hidden"/>
            <div class="mt-4 space-y-2">
                <button id="btnAcaoSecundaria" class="w-full px-4 py-3 rounded-xl bg-red-600 text-white font-semibold hover:bg-red-700 transition shadow-lg shadow-red-600/30">Apagar Tudo (Reset)</button>
            </div>
        </div>
      </div>
      
      <div id="modalBotoes" class="mt-6 flex gap-3">
        <button id="btnLido" class="flex-1 px-4 py-3 rounded-xl bg-primary-500 text-white font-semibold hover:bg-primary-600 transition shadow-lg shadow-primary-500/30">‚úî Marcar como lido</button>
        <button id="btnLerAgora" class="px-4 py-3 rounded-xl bg-blue-600 text-white font-semibold hover:bg-blue-700 transition shadow-lg shadow-blue-600/30">üìñ Ler agora</button>
        <button id="btnConfirmar" class="flex-1 px-4 py-3 rounded-xl bg-meta-500 text-white font-semibold hover:bg-meta-600 transition shadow-lg shadow-meta-500/30 hidden">Confirmar</button>
        <button id="btnCancelar" class="px-4 py-3 rounded-xl bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 font-semibold hover:bg-gray-300 dark:hover:bg-gray-600 transition hidden">Cancelar</button>
      </div>
    </div>
  </div>

  <footer class="mt-12 py-6 border-t border-gray-200 dark:border-gray-700 text-center text-sm text-gray-600 dark:text-gray-400">
    ¬© 2025 Alex Silva ‚Äî <em>Uso livre com atribui√ß√£o</em>
    <p class="text-xs mt-1">
        <a href="https://www.instagram.com/alexsilva_prof" target="_blank" class="text-primary-500 hover:underline">@alexsilva_prof</a>
    </p>
  </footer>

  <script>
  
  // ---------- CONFIG / TEXTS ----------
  const UI_TEXT = {
    pt: {
      titulo: 'Plano B√≠blico',
      subtitulo: 'Acompanhe seu progresso',
      // NOVO: Textos traduz√≠veis da p√°gina de sele√ß√£o
      titulo_selecao: 'Escolha seu Plano de Leitura',
      subtitulo_selecao: 'Seu plano ser√° salvo automaticamente.',
      link_trocar: 'Trocar Plano',
      ler_agora: 'Ler agora',
      planos: [
        { id: 'tradicional', title: 'Tradicional', desc: 'G√™nesis ‚Üí Apocalipse (padr√£o)' },
        { id: 'cronologico', title: 'Cronol√≥gico', desc: 'Ordem hist√≥rica aproximada' },
        { id: 'atnt', title: 'AT + NT', desc: 'Um trecho do AT e um do NT por dia' },
        { id: 'jesus', title: 'Um Ano com Jesus', desc: 'Evangelhos ‚Üí Atos ‚Üí Cartas ‚Üí Resto' },
        { id: 'umcap', title: '1 Cap√≠tulo/Dia', desc: '1 cap√≠tulo por dia (365 sele√ß√µes)' },
        { id: 'salmos', title: 'AT+NT+Salmos', desc: 'AT + NT + Salmo/Prov√©rbio di√°rio' }
      ],
      start: 'Dia de Leitura',
      marcar: '‚úî Marcar como lido',
      desmarcar: '‚ùå Desmarcar como lido', // NOVO: Texto para desmarcar
      concluido: 'Conclu√≠do', // NOVO: Texto para status
      fechar: 'Fechar',
      progresso: 'Progresso',
      plano: 'Plano',
      dia_leitura: 'Dia',
      lang_name: 'Portugu√™s',
      flag_code: 'br',
      meta: 'META',
      configuracao: 'Configura√ß√µes do Plano',
      data_inicio: 'In√≠cio',
      btn_iniciar: 'Definir Data de In√≠cio', 
      btn_iniciar_plano: 'Iniciar Plano', 
      plano_atual: 'Plano Atual', 
      btn_salvar: 'Salvar',
      reset_plano: 'Apagar Tudo (Reset)',
      reset_titulo: 'Confirma Limpeza?',
      reset_msg: 'Isso apagar√° **TODO** o seu progresso e plano salvos. Deseja continuar?',
      reset_confirmar: 'Sim, Apagar Tudo',
      cancelar: 'Cancelar',
      status_atraso: 'Voc√™ est√° **{dias} dias** atrasado.',
      status_emdia: 'Voc√™ est√° **em dia!** Dia de hoje √© o seu alvo.',
      status_adiantado: 'Voc√™ est√° **{dias} dias** adiantado. Parab√©ns!',
      nao_definido: 'N√£o definido',
      change_plan_titulo: 'Trocar Plano?', 
      change_plan_msg: 'Trocar de plano apagar√° todo o seu **progresso atual** e o **plano selecionado**. Deseja prosseguir?',
      change_plan_confirmar: 'Sim, Trocar Plano',
    },
    en: {
        titulo: 'Bible Plan',
        subtitulo: 'Track your progress',
        // NOVO: Textos traduz√≠veis da p√°gina de sele√ß√£o
        titulo_selecao: 'Choose Your Reading Plan',
        subtitulo_selecao: 'Your plan will be saved automatically.',
        link_trocar: 'Change Plan',
        ler_agora: 'Read now',
        planos: [
          { id: 'tradicional', title: 'Traditional', desc: 'Genesis ‚Üí Revelation (standard)' },
          { id: 'cronologico', title: 'Chronological', desc: 'Approx. historical order' },
          { id: 'atnt', title: 'OT + NT', desc: 'OT + NT passage per day' },
          { id: 'jesus', title: 'One Year with Jesus', desc: 'Gospels ‚Üí Acts ‚Üí Letters ‚Üí Rest' },
          { id: 'umcap', title: '1 Chapter/Day', desc: '1 chapter per day (365 picks)' },
          { id: 'salmos', title: 'OT+NT+Psalms', desc: 'OT + NT + Psalm/Proverb daily' }
        ],
        start: 'Reading Day',
        marcar: '‚úî Mark as read',
        desmarcar: '‚ùå Mark as unread', // NOVO: Texto para desmarcar
        concluido: 'Completed', // NOVO: Texto para status
        fechar: 'Close',
        progresso: 'Progress',
        plano: 'Plan',
        dia_leitura: 'Day',
        lang_name: 'English',
        flag_code: 'us',
        meta: 'GOAL',
        configuracao: 'Plan Settings',
        data_inicio: 'Start Date',
        btn_iniciar: 'Set Start Date',
        btn_iniciar_plano: 'Start Plan', 
        plano_atual: 'Current Plan', 
        btn_salvar: 'Save',
        reset_plano: 'Reset/Clear Plan',
        reset_titulo: 'Confirm Reset?',
        reset_msg: 'This will erase **ALL** your saved plan and progress. Do you wish to continue?',
        reset_confirmar: 'Yes, Erase All',
        cancelar: 'Cancel',
        status_atraso: 'You are **{dias} days** behind.',
        status_emdia: 'You are **on track!** Today is your goal.',
        status_adiantado: 'You are **{dias} days** ahead. Congratulations!',
        nao_definido: 'Not set',
        change_plan_titulo: 'Change Plan?', 
        change_plan_msg: 'Changing the plan will erase all your **current progress** and **selected plan**. Do you want to proceed?',
        change_plan_confirmar: 'Yes, Change Plan',
    },
    es: {
        titulo: 'Plan B√≠blico',
        subtitulo: 'Sigue tu progreso',
        // NOVO: Textos traduz√≠veis da p√°gina de sele√ß√£o
        titulo_selecao: 'Elige tu Plan de Lectura',
        subtitulo_selecao: 'Tu plan se guardar√° autom√°ticamente.',
        link_trocar: 'Cambiar Plan',
        ler_agora: 'Leer ahora',
        planos: [
          { id: 'tradicional', title: 'Tradicional', desc: 'G√©nesis ‚Üí Apocalipsis (est√°ndar)' },
          { id: 'cronologico', title: 'Cronol√≥gico', desc: 'Orden hist√≥rico aproximado' },
          { id: 'atnt', title: 'AT + NT', desc: 'Pasaje de AT y NT por d√≠a' },
          { id: 'jesus', title: 'Un A√±o con Jes√∫s', desc: 'Evangelios ‚Üí Hechos ‚Üí Cartas ‚Üí Resto' },
          { id: 'umcap', title: '1 Cap√≠tulo/D√≠a', desc: '1 cap√≠tulo por d√≠a (365 selecciones)' },
          { id: 'salmos', title: 'AT+NT+Salmos', desc: 'AT + NT + Salmo/Proverbio diario' }
        ],
        start: 'D√≠a de Lectura',
        marcar: '‚úî Marcar como le√≠do',
        desmarcar: '‚ùå Desmarcar como le√≠do', // NOVO: Texto para desmarcar
        concluido: 'Completado', // NOVO: Texto para status
        fechar: 'Cerrar',
        progresso: 'Progreso',
        plano: 'Plan',
        dia_leitura: 'Day',
        lang_name: 'Espa√±ol',
        flag_code: 'es',
        meta: 'META',
        configuracion: 'Configuraci√≥n del Plan',
        data_inicio: 'Fecha de Inicio',
        btn_iniciar: 'Establecer Fecha de Inicio',
        btn_iniciar_plano: 'Iniciar Plan', 
        plano_atual: 'Plan Actual', 
        btn_salvar: 'Guardar',
        reset_plano: 'Reiniciar/Borrar Plan',
        reset_titulo: '¬øConfirmar Borrado?',
        reset_msg: 'Esto borrar√° **TODO** tu progreso y plan guardados. ¬øDeseas continuar?',
        reset_confirmar: 'S√≠, Borrar Todo',
        cancelar: 'Cancelar',
        status_atraso: 'Est√°s **{dias} d√≠as** atrasado.',
        status_emdia: 'Est√°s **al d√≠a!** El d√≠a de hoy es tu meta.',
        status_adiantado: 'Est√°s **{dias} d√≠as** adelantado. ¬°Felicidades!',
        nao_definido: 'No definido',
        change_plan_titulo: '¬øCambiar Plan?', 
        change_plan_msg: 'Cambiar el plan borrar√° todo tu **progreso actual** y el **plan seleccionado**. ¬øQuieres continuar?',
        change_plan_confirmar: 'S√≠, Cambiar Plan',
    }
  };
  
  // (Constantes de Meses, Livros e Fun√ß√µes de Gera√ß√£o de Plano - MANTIDAS)
  const MONTHS = {
    pt: ["Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set","Out","Nov","Dez"],
    en: ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],
    es: ["Ene","Feb","Mar","Abr","Mai","Jun","Jul","Ago","Sep","Oct","Nov","Dic"]
  };
  const DAYS_PER_MONTH = [31,28,31,30,31,30,31,31,30,31,30,31];
  const BOOKS = [
    { key:'Genesis', ch:50, name:{pt:'G√™nesis', en:'Genesis', es:'G√©nesis'} },
    { key:'Exodus', ch:40, name:{pt:'√äxodo', en:'Exodus', es:'√âxodo'} },
    { key:'Leviticus', ch:27, name:{pt:'Lev√≠tico', en:'Leviticus', es:'Lev√≠tico'} },
    { key:'Numbers', ch:36, name:{pt:'N√∫meros', en:'Numbers', es:'N√∫meros'} },
    { key:'Deuteronomy', ch:34, name:{pt:'Deuteron√¥mio', en:'Deuteronomy', es:'Deuteronomio'} },
    { key:'Joshua', ch:24, name:{pt:'Josu√©', en:'Joshua', es:'Josu√©'} },
    { key:'Judges', ch:21, name:{pt:'Ju√≠zes', en:'Judges', es:'Jueces'} },
    { key:'Ruth', ch:4, name:{pt:'Rute', en:'Ruth', es:'Rut'} },
    { key:'1 Samuel', ch:31, name:{pt:'1 Samuel', en:'1 Samuel', es:'1 Samuel'} },
    { key:'2 Samuel', ch:24, name:{pt:'2 Samuel', en:'2 Samuel', es:'2 Samuel'} },
    { key:'1 Kings', ch:22, name:{pt:'1 Reis', en:'1 Kings', es:'1 Reyes'} },
    { key:'2 Kings', ch:25, name:{pt:'2 Reis', en:'2 Kings', es:'2 Reyes'} },
    { key:'1 Chronicles', ch:29, name:{pt:'1 Cr√¥nicas', en:'1 Chronicles', es:'1 Cr√≥nicas'} },
    { key:'2 Chronicles', ch:36, name:{pt:'2 Cr√¥nicas', en:'2 Chronicles', es:'2 Cr√≥nicas'} },
    { key:'Ezra', ch:10, name:{pt:'Esdras', en:'Ezra', es:'Esdras'} },
    { key:'Nehemiah', ch:13, name:{pt:'Neemias', en:'Nehemiah', es:'Nehem√≠as'} },
    { key:'Esther', ch:10, name:{pt:'Ester', en:'Esther', es:'Ester'} },
    { key:'Job', ch:42, name:{pt:'J√≥', en:'Job', es:'Job'} },
    { key:'Psalms', ch:150, name:{pt:'Salmos', en:'Psalms', es:'Salmos'} },
    { key:'Proverbs', ch:31, name:{pt:'Prov√©rbios', en:'Proverbs', es:'Proverbios'} },
    { key:'Ecclesiastes', ch:12, name:{pt:'Eclesiastes', en:'Ecclesiastes', es:'Eclesiast√©s'} },
    { key:'Song of Solomon', ch:8, name:{pt:'C√¢nticos', en:'Song of Solomon', es:'Cantar de los Cantares'} },
    { key:'Isaiah', ch:66, name:{pt:'Isa√≠as', en:'Isaiah', es:'Isa√≠as'} },
    { key:'Jeremiah', ch:52, name:{pt:'Jeremias', en:'Jeremiah', es:'Jerem√≠as'} },
    { key:'Lamentations', ch:5, name:{pt:'Lamenta√ß√µes', en:'Lamentations', es:'Lamentaciones'} },
    { key:'Ezekiel', ch:48, name:{pt:'Ezequiel', en:'Ezekiel', es:'Ezequiel'} },
    { key:'Daniel', ch:12, name:{pt:'Daniel', en:'Daniel', es:'Daniel'} },
    { key:'Hosea', ch:14, name:{pt:'Os√©ias', en:'Hosea', es:'Oseas'} },
    { key:'Joel', ch:3, name:{pt:'Joel', en:'Joel', es:'Joel'} },
    { key:'Amos', ch:9, name:{pt:'Am√≥s', en:'Amos', es:'Am√≥s'} },
    { key:'Obadiah', ch:1, name:{pt:'Obadias', en:'Obadiah', es:'Abd√≠as'} },
    { key:'Jonah', ch:4, name:{pt:'Jonas', en:'Jonah', es:'Jon√°s'} },
    { key:'Micah', ch:7, name:{pt:'Miqu√©ias', en:'Micah', es:'Miqueas'} },
    { key:'Nahum', ch:3, name:{pt:'Naum', en:'Nahum', es:'Nah√∫m'} },
    { key:'Habakkuk', ch:3, name:{pt:'Habacuque', en:'Habakkuk', es:'Habacuc'} },
    { key:'Zephaniah', ch:3, name:{pt:'Sofonias', en:'Zephaniah', es:'Sofon√≠as'} },
    { key:'Haggai', ch:2, name:{pt:'Ageu', en:'Haggai', es:'Ageo'} },
    { key:'Zechariah', ch:14, name:{pt:'Zacarias', en:'Zechariah', es:'Zacar√≠as'} },
    { key:'Malachi', ch:4, name:{pt:'Malaquias', en:'Malachi', es:'Malaqu√≠as'} },
    { key:'Matthew', ch:28, name:{pt:'Mateus', en:'Matthew', es:'Mateo'} },
    { key:'Mark', ch:16, name:{pt:'Marcos', en:'Mark', es:'Marcos'} },
    { key:'Luke', ch:24, name:{pt:'Lucas', en:'Luke', es:'Lucas'} },
    { key:'John', ch:21, name:{pt:'Jo√£o', en:'John', es:'Juan'} },
    { key:'Acts', ch:28, name:{pt:'Atos', en:'Acts', es:'Hechos'} },
    { key:'Romans', ch:16, name:{pt:'Romanos', en:'Romans', es:'Romanos'} },
    { key:'1 Corinthians', ch:16, name:{pt:'1 Cor√≠ntios', en:'1 Corinthians', es:'1 Corintios'} },
    { key:'2 Corinthians', ch:13, name:{pt:'2 Cor√≠ntios', en:'2 Corinthians', es:'2 Corintios'} },
    { key:'Galatians', ch:6, name:{pt:'G√°latas', en:'Galatians', es:'G√°latas'} },
    { key:'Ephesians', ch:6, name:{pt:'Ef√©sios', en:'Ephesians', es:'Efesios'} },
    { key:'Philippians', ch:4, name:{pt:'Filipenses', en:'Philippians', es:'Filipenses'} },
    { key:'Colossians', ch:4, name:{pt:'Colossenses', en:'Colossians', es:'Colosenses'} },
    { key:'1 Thessalonians', ch:5, name:{pt:'1 Tessalonicenses', en:'1 Thessalonians', es:'1 Tesalonicenses'} },
    { key:'2 Thessalonians', ch:3, name:{pt:'2 Tessalonicenses', en:'2 Thessalonians', es:'2 Tesalonicenses'} },
    { key:'1 Timothy', ch:6, name:{pt:'1 Tim√≥teo', en:'1 Timothy', es:'1 Timoteo'} },
    { key:'2 Timothy', ch:4, name:{pt:'2 Tim√≥teo', en:'2 Timothy', es:'2 Timoteo'} },
    { key:'Titus', ch:3, name:{pt:'Tito', en:'Titus', es:'Tito'} },
    { key:'Philemon', ch:1, name:{pt:'Filemom', en:'Philemon', es:'Filem√≥n'} },
    { key:'Hebrews', ch:13, name:{pt:'Hebreus', en:'Hebrews', es:'Hebreos'} },
    { key:'James', ch:5, name:{pt:'Tiago', en:'James', es:'Santiago'} },
    { key:'1 Peter', ch:5, name:{pt:'1 Pedro', en:'1 Peter', es:'1 Pedro'} },
    { key:'2 Peter', ch:3, name:{pt:'2 Pedro', en:'2 Peter', es:'2 Pedro'} },
    { key:'1 John', ch:5, name:{pt:'1 Jo√£o', en:'1 John', es:'1 Juan'} },
    { key:'2 John', ch:1, name:{pt:'2 Jo√£o', en:'2 John', es:'2 Juan'} },
    { key:'3 John', ch:1, name:{pt:'3 Jo√£o', en:'3 John', es:'3 Juan'} },
    { key:'Jude', ch:1, name:{pt:'Judas', en:'Jude', es:'Judas'} },
    { key:'Revelation', ch:22, name:{pt:'Apocalipse', en:'Revelation', es:'Apocalipsis'} }
  ];
  const FLAT = [];
  (function buildFlat(){
    for(const b of BOOKS){
      for(let c=1;c<=b.ch;c++) FLAT.push({ bookKey: b.key, chapter: c });
    }
  })();
  function bookName(bookKey, lang){
    const b = BOOKS.find(x=>x.key===bookKey);
    return b ? (b.name[lang] || b.name.pt) : bookKey;
  }
  function formatRefObj(obj, lang){
    return `${bookName(obj.bookKey, lang)} ${obj.chapter}`;
  }
  const CHRON_ORDER_KEYS = [ 
    'Genesis','Job','Exodus','Leviticus','Numbers','Deuteronomy','Joshua','Judges','Ruth',
    '1 Samuel','2 Samuel','1 Kings','2 Kings','1 Chronicles','2 Chronicles','Ezra','Nehemiah','Esther',
    'Isaiah','Hosea','Joel','Amos','Obadiah','Jonah','Micah','Nahum','Habakkuk','Zephaniah','Zechariah','Haggai','Malachi',
    'Psalms','Proverbs','Ecclesiastes','Song of Solomon',
    'Matthew','Mark','Luke','John','Acts','Romans','1 Corinthians','2 Corinthians','Galatians','Ephesians','Philippians','Colossians','1 Thessalonians','2 Thessalonians','1 Timothy','2 Timothy','Titus','Philemon','Hebrews','James','1 Peter','2 Peter','1 John','2 John','3 John','Jude','Revelation','Daniel','Jeremiah','Lamentations','Ezekiel'
  ];
  function genTradicional(lang){
    const total = FLAT.length; const perDay = total / 365; const plan = Array.from({length:365}, ()=>[]); let idx=0;
    for(let day=0; day<365; day++){
      const take = Math.max(1, Math.round(perDay));
      for(let t=0; t<take && idx<total; t++, idx++) plan[day].push(formatRefObj(FLAT[idx], lang));
    }
    while(idx<total) plan[plan.length-1].push(formatRefObj(FLAT[idx++], lang));
    return plan;
  }
  function genCronologico(lang){
    const arr = [];
    for(const k of CHRON_ORDER_KEYS){
      const book = BOOKS.find(b=>b.key===k);
      if(!book) continue;
      for(let c=1;c<=book.ch;c++) arr.push({bookKey: book.key, chapter: c});
    }
    for(const b of BOOKS) if(!CHRON_ORDER_KEYS.includes(b.key)) for(let c=1;c<=b.ch;c++) arr.push({bookKey: b.key, chapter: c});
    const total = arr.length; const perDay = total/365; const plan = Array.from({length:365},()=>[]); let idx=0;
    for(let d=0; d<365; d++){
      const take = Math.max(1, Math.round(perDay));
      for(let t=0;t<take && idx<total;t++,idx++) plan[d].push(formatRefObj(arr[idx], lang));
    }
    while(idx<total) plan[plan.length-1].push(formatRefObj(arr[idx++] , lang));
    return plan;
  }
  function genATNT(lang){
    const mattIndex = FLAT.findIndex(c=>c.bookKey==='Matthew');
    const ot = FLAT.slice(0, mattIndex); const nt = FLAT.slice(mattIndex);
    const otPer = ot.length/365; const ntPer = nt.length/365;
    const plan = Array.from({length:365},()=>[]); let i=0,j=0;
    for(let d=0; d<365; d++){
      const takeOT = Math.max(1, Math.round(otPer)); const takeNT = Math.max(1, Math.round(ntPer));
      for(let t=0;t<takeOT && i<ot.length;t++,i++) plan[d].push(formatRefObj(ot[i], lang));
      for(let t=0;t<takeNT && j<nt.length;t++,j++) plan[d].push(formatRefObj(nt[j], lang));
    }
    while(i<ot.length) plan[plan.length-1].push(formatRefObj(ot[i++], lang));
    while(j<nt.length) plan[plan.length-1].push(formatRefObj(nt[j++], lang));
    return plan;
  }
  function genJesusYear(lang){
    const order = ['Matthew','Mark','Luke','John','Acts','Romans','1 Corinthians','2 Corinthians','Galatians','Ephesians','Philippians','Colossians','1 Thessalonians','2 Thessalonians','1 Timothy','2 Timothy','Titus','Philemon','Hebrews','James','1 Peter','2 Peter','1 John','2 John','3 John','3 John','Jude','Revelation'];
    const arr = [];
    for(const name of order){
      const book = BOOKS.find(b=>b.key===name);
      if(!book) continue;
      for(let c=1;c<=book.ch;c++) arr.push({bookKey: book.key, chapter:c});
    }
    for(const b of BOOKS) if(!order.includes(b.key)) for(let c=1;c<=b.ch;c++) arr.push({bookKey: b.key, chapter:c});
    const total = arr.length; const perDay = total/365; const plan = Array.from({length:365},()=>[]); let idx=0;
    for(let d=0; d<365; d++){
      const take = Math.max(1, Math.round(perDay));
      for(let t=0;t<take && idx<total;t++,idx++) plan[d].push(formatRefObj(arr[idx], lang));
    }
    while(idx<total) plan[plan.length-1].push(formatRefObj(arr[idx++]));
    return plan;
  }
  function genUmCapitulo(lang){
    const plan = Array.from({length:365},()=>[]);
    for(let i=0;i<365;i++){
      if(i<FLAT.length) plan[i].push(formatRefObj(FLAT[i], lang)); else plan[i].push('‚Äî');
    }
    return plan;
  }
  function genComSalmos(lang){
    const mattIndex = FLAT.findIndex(c=>c.bookKey==='Matthew');
    const ot = FLAT.slice(0, mattIndex); const nt = FLAT.slice(mattIndex);
    const psStart = FLAT.findIndex(c=>c.bookKey==='Psalms'); const provStart = FLAT.findIndex(c=>c.bookKey==='Proverbs');
    const psCount = BOOKS.find(b=>b.key==='Psalms').ch; const provCount = BOOKS.find(b=>b.key==='Proverbs').ch;
    const otPer = ot.length/365; const ntPer = nt.length/365;
    const plan = Array.from({length:365},()=>[]); let i=0,j=0,p=psStart,pr=provStart,alt=true;
    for(let d=0; d<365; d++){
      const takeOT = Math.max(1, Math.round(otPer)); const takeNT = Math.max(1, Math.round(ntPer));
      for(let t=0;t<takeOT && i<ot.length;t++,i++) plan[d].push(formatRefObj(ot[i], lang));
      for(let t=0;t<takeNT && j<nt.length;t++,j++) plan[d].push(formatRefObj(nt[j], lang));
      if(alt && p < psStart + psCount) plan[d].push(formatRefObj(FLAT[p++], lang));
      else if(!alt && pr < provStart + provCount) plan[d].push(formatRefObj(FLAT[pr++], lang));
      else if(p < psStart + psCount) plan[d].push(formatRefObj(FLAT[p++], lang));
      else if(pr < provStart + provCount) plan[d].push(formatRefObj(FLAT[pr++], lang));
      alt = !alt;
    }
    while(i<ot.length) plan[plan.length-1].push(formatRefObj(ot[i++] , lang));
    while(j<nt.length) plan[plan.length-1].push(formatRefObj(nt[j++] , lang));
    return plan;
  }

  const PLAN_GENERATORS = { tradicional: genTradicional, cronologico: genCronologico, atnt: genATNT, jesus: genJesusYear, umcap: genUmCapitulo, salmos: genComSalmos };
  const CACHE = {};
  function getPlan(id, lang){
    const key = `${id}__${lang}`;
    if(!CACHE[key]) CACHE[key] = PLAN_GENERATORS[id](lang);
    return CACHE[key];
  }

  // ---------- UI & STATE ----------
  let state = {
    // Carrega o idioma, plano e DATA DE IN√çCIO do localStorage ou usa o padr√£o
    idioma: localStorage.getItem('bib_idioma') || 'pt',
    planoId: localStorage.getItem('bib_plano') || null, 
    // Data de In√≠cio do plano (YYYY-MM-DD string)
    startDate: localStorage.getItem('bib_startDate') || null, 
    selectedMonth: 1,
    selectedDayOfMonth: null,
  };
  
  // Calcula o dia do ano (1 a 365)
  function getDayOfYear(date) {
    const start = new Date(date.getFullYear(), 0, 0);
    const diff = date - start;
    const oneDay = 1000 * 60 * 60 * 24;
    return Math.floor(diff / oneDay);
  }

  function dayOfYearToMonthDay(n){
    let m=0; let day = n;
    while(m<12 && day > DAYS_PER_MONTH[m]){ day -= DAYS_PER_MONTH[m]; m++; }
    return { month: m+1, day: day };
  }
  function monthDayToDayOfYear(month, day){
    let s=0; for(let i=0;i<month-1;i++) s+=DAYS_PER_MONTH[i]; return s+day;
  }

  // Calcula o n√∫mero de dias decorridos desde a data de in√≠cio
  function getDaysSinceStart() {
    if (!state.startDate) return 0;
    // IMPORTANTE: Adiciona 'T00:00:00' para garantir que a data seja interpretada como local/UTC 00:00
    const start = new Date(state.startDate + 'T00:00:00'); 
    const today = new Date();
    today.setHours(0, 0, 0, 0); // Zera hora para c√°lculo correto
    
    // Calcula a diferen√ßa em milissegundos
    const diffTime = today - start;
    // Converte para dias (Arredonda para baixo para considerar o dia de in√≠cio como dia 1)
    const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
    
    // Retorna o dia do plano esperado (Dia 1, Dia 2...)
    return diffDays + 1; 
  }
  
  // Encontra o PRIMEIRO dia n√£o lido
  function findNextUnreadDay() {
      if (!state.planoId) return null;
      // Procura do dia 1 ao 365
      for (let day = 1; day <= 365; day++) {
          const key = `${state.planoId}_day_${day}`;
          if (!localStorage.getItem(key)) {
              return day; // Este √© o dia "META"
          }
      }
      return 365; // Se tudo estiver lido, sugere o √∫ltimo dia
  }

  // Alterna a visualiza√ß√£o entre as duas "p√°ginas"
  function showPage(pageId) {
      const selecao = document.getElementById('paginaSelecao');
      const plano = document.getElementById('paginaPlano');
      const texts = UI_TEXT[state.idioma];

      // Atualiza textos da p√°gina de sele√ß√£o
      document.getElementById('tituloSelecao').innerText = texts.titulo_selecao;
      document.getElementById('subtituloSelecao').innerText = texts.subtitulo_selecao;

      if (pageId === 'paginaPlano' && state.planoId) {
          // Exibir P√°gina do Plano
          selecao.classList.add('hidden'); 
          plano.classList.remove('hidden'); 
          
          document.getElementById('tituloApp').innerText = ` ${texts.titulo}`;
          document.getElementById('subtituloApp').innerText = texts.subtitulo;
          
          renderPlanGrid();
          renderMonths(); 
          renderDays(state.selectedMonth); 
          updateProgressUI();

      } else {
          // Exibir P√°gina de Sele√ß√£o
          plano.classList.add('hidden');
          selecao.classList.remove('hidden');
          
          document.getElementById('tituloApp').innerText = ` ${texts.titulo_selecao}`;
          document.getElementById('subtituloApp').innerText = texts.subtitulo_selecao;

          renderPlanGrid();
      }
      if(window.lucide) window.lucide.createIcons();
  }

  // NOVO: Fun√ß√£o para Iniciar/Selecionar um Plano (Chamada pelo bot√£o "Iniciar Plano")
  function startPlan(planId){
    state.planoId = planId; 
    localStorage.setItem('bib_plano', planId); 
    
    // Define a data de in√≠cio para hoje se ainda n√£o estiver definida (l√≥gica do bot√£o "Iniciar")
    if(!state.startDate) {
        const today = new Date().toISOString().split('T')[0];
        state.startDate = today;
        localStorage.setItem('bib_startDate', today);
    } 
    
    showPage('paginaPlano');
  }

  // NOVO: Fun√ß√£o para limpar o progresso e voltar √† sele√ß√£o (Chamada pelo modal de Aviso)
  function fullPlanChange(){
      if (!state.planoId) {
          showPage('paginaSelecao');
          return;
      }
      
      // 1. Limpar progresso do plano anterior (dias lidos)
      for(let day=1; day<=365; day++){
          localStorage.removeItem(`${state.planoId}_day_${day}`);
      }
      
      // 2. Limpar o ID do plano no estado e storage
      state.planoId = null;
      localStorage.removeItem('bib_plano');
      
      // 3. Navegar para a p√°gina de sele√ß√£o
      showPage('paginaSelecao');
  }


  // ---------- RENDER FUNCTIONS ----------
  function renderPlanGrid(){
    const container = document.getElementById('gridPlanos'); 
    if (!container) return; 
    
    container.innerHTML='';
    const texts = UI_TEXT[state.idioma].planos;
    const icons = ['calendar','clock','layers','heart','book-open','sun'];
    
    texts.forEach((p, idx)=>{
      const isSelected = state.planoId===p.id;
      const card = document.createElement('div');
      
      card.className='flex flex-col p-4 rounded-xl shadow-lg transition-all duration-200 text-center ' +
                    (isSelected ? 'bg-primary-500 text-white ring-4 ring-primary-500/50' : 'bg-white dark:bg-gray-800 hover:ring-2 hover:ring-primary-500');
      card.style.minHeight='160px'; // Aumentado para caber o bot√£o
      
      const iconColor = isSelected ? 'text-white' : 'text-primary-500';
      const descColor = isSelected ? 'text-indigo-200' : 'text-gray-500 dark:text-gray-400';
      const iconName = icons[idx] || 'book';
      
      let cardContent = `\
        <div class="mb-2"><i data-lucide="${iconName}" class="lucide w-8 h-8 ${iconColor}"></i></div>\
        <div class="text-base font-bold">${p.title}</div>\
        <div class="text-xs ${descColor} mt-1 flex-1">${p.desc}</div>`;
      
      // ** NOVO: Adiciona o bot√£o INICIAR ou o status de Plano Atual **
      if(!isSelected){
         // Bot√£o "Iniciar Plano" (o seu bot√£o iniciar na sele√ß√£o)
         cardContent += `<button type="button" class="mt-4 w-full px-4 py-2 rounded-lg font-bold transition bg-primary-500 text-white hover:bg-primary-600 shadow-md" data-plan-id="${p.id}">
             ${UI_TEXT[state.idioma].btn_iniciar_plano} 
         </button>`;
      } else {
         // Se j√° selecionado, mostra o status
         cardContent += `<div class="mt-4 w-full px-4 py-2 rounded-lg font-bold bg-meta-500 text-white shadow-md text-center">
             ${UI_TEXT[state.idioma].plano_atual}
         </div>`;
      }

      card.innerHTML = cardContent;
      
      // Adicionar listener ao bot√£o INICIAR
      const startButton = card.querySelector(`[data-plan-id="${p.id}"]`);
      if(startButton){
        startButton.onclick = () => startPlan(p.id);
      }
      
      container.appendChild(card);
    });
    if(window.lucide) window.lucide.createIcons();
  }

  function renderMonths(){
    // ... (Mantido o mesmo)
    const div = document.getElementById('meses'); 
    if (!div) return;
    
    div.innerHTML='';
    const months = MONTHS[state.idioma];
    months.forEach((m,i)=>{
      const isSelected = state.selectedMonth === i+1;
      const btn = document.createElement('button');
      btn.className = 'flex-shrink-0 px-4 py-2 rounded-full font-semibold transition ' + 
                      (isSelected ? 'bg-primary-500 text-white shadow-md' : 'bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600');
      btn.innerText = m;
      btn.onclick = ()=>{ state.selectedMonth = i+1; renderMonths(); renderDays(i+1); };
      div.appendChild(btn);
    });
    
    const currentMonthButton = document.querySelector(`#meses button:nth-child(${state.selectedMonth})`);
    if(currentMonthButton){
        // Scroll para o m√™s atual
        currentMonthButton.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
  }

  function renderDays(month){
    const container = document.getElementById('dias'); 
    if (!container || !state.planoId) return;

    container.innerHTML='';
    const daysInMonth = DAYS_PER_MONTH[month-1];
    const startDayOfYear = monthDayToDayOfYear(month,1);
    const plan = getPlan(state.planoId, state.idioma);
    
    // 1. Calcula os dias de refer√™ncia para destaque
    const today = new Date();
    const todayMonth = today.getMonth() + 1;
    const todayDayOfMonth = today.getDate();
    
    const nextUnreadDay = findNextUnreadDay(); // Dia 1-365 que √© a META
    const expectedDay = getDaysSinceStart(); // Dia 1-365 esperado pelo Start Date

    for(let d=1; d<=daysInMonth; d++){
      const dayOfYear = startDayOfYear + d -1; const idx = dayOfYear -1; const refs = plan[idx] || [];
      const key = `${state.planoId}_day_${dayOfYear}`; const lido = localStorage.getItem(key);
      const card = document.createElement('div');
      
      // 2. L√≥gica dos destaques
      const isToday = (month === todayMonth && d === todayDayOfMonth);
      const isMetaDay = (dayOfYear === nextUnreadDay);
      const isExpectedDay = state.startDate && (dayOfYear === expectedDay);
      
      let cardClasses = 'p-4 rounded-xl shadow-md border-t-2 cursor-pointer transition';
      
      if (lido) {
        // Se lido, cor de fundo mais suave
        cardClasses += ' border-primary-500 bg-gray-100 dark:bg-gray-700 opacity-90';
      } else if (isMetaDay) {
          cardClasses += ' next-day-highlight'; // META (Priorit√°rio)
      } else if (isToday) {
          cardClasses += ' today-highlight'; // HOJE
      } else {
          // Classes normais para dias passados/futuros
          cardClasses += ' border-gray-200 dark:border-gray-700 hover:shadow-lg hover:ring-1 hover:ring-primary-500' +
                         ' bg-white dark:bg-gray-800';
      }
      
      if (!lido && !isMetaDay && !isToday && isExpectedDay) {
         cardClasses += ' border-dashed border-yellow-500/50';
      }


      card.className = cardClasses;
      
      const preview = refs.slice(0,2).join(', ');
      
      let iconName = 'chevrons-right'; 
      let iconColor = isMetaDay ? 'text-meta-500' : 'text-gray-400 dark:text-gray-500';

      if (lido) {
        iconName = 'check-circle';
        iconColor = 'text-primary-500'; // Azul para Conclu√≠do
      } else if (isMetaDay) {
        iconName = 'target'; 
        iconColor = 'text-meta-600'; // Esmeralda para META
      } else if (isToday) {
        iconName = 'calendar-check';
        iconColor = 'text-blue-500'; // Azul para HOJE
      }


      card.innerHTML = `\
        <div class="flex justify-between items-start">\
          <div>\
            <h3 class="text-xl font-extrabold ${isMetaDay ? 'text-meta-600 dark:text-meta-400' : 'text-primary-500'}">${d}</h3>\
            <p class="text-xs ${isMetaDay ? 'text-meta-400 dark:text-meta-300' : 'text-gray-500 dark:text-gray-400'} font-medium mt-0.5">${formatDateSmall(month,d)}</p>\
          </div>\
          <div class="${iconColor} flex-shrink-0"><i data-lucide="${iconName}" class="lucide w-6 h-6"></i></div>\
        </div>\
        <p class="mt-3 text-sm font-medium ${isMetaDay ? 'text-gray-900 dark:text-gray-100' : 'text-gray-700 dark:text-gray-200'}">${preview}${refs.length>2? ' ...' : ''}</p>`;
      card.onclick = ()=> abrirModalForDay(dayOfYear);
      container.appendChild(card);
    }
    if(window.lucide) window.lucide.createIcons(); 
    updateProgressUI();
  }

  function formatDateSmall(month, day){ const months = MONTHS[state.idioma]; return `${months[month-1]} ${day}`; }
  
  // Fun√ß√£o auxiliar para formatar a data (AAAA-MM-DD) para exibi√ß√£o (DD/MM/AAAA)
  function formatDisplayDate(dateStr) {
    if (!dateStr) return 'N/A';
    const parts = dateStr.split('-');
    if (parts.length === 3) {
        return `${parts[2]}/${parts[1]}/${parts[0]}`;
    }
    return dateStr;
  }

  let modalCurrentDay = null;
  let modalMode = 'leitura'; // 'leitura' ou 'config' ou 'reset' ou 'change_plan_warning'
  const modalDiv = document.getElementById('modal');
  const modalContent = document.getElementById('modalContent');
  const modalLeituras = document.getElementById('modalLeituras');
  const modalConfiguracao = document.getElementById('modalConfiguracao');
  const modalBotoes = document.getElementById('modalBotoes');
  const modalStatus = document.getElementById('modalStatus'); // NOVO: Elemento de status
  const btnLido = document.getElementById('btnLido');
  const btnLerAgora = document.getElementById('btnLerAgora');
  const btnConfirmar = document.getElementById('btnConfirmar');
  const btnCancelar = document.getElementById('btnCancelar');
  const btnAcaoSecundaria = document.getElementById('btnAcaoSecundaria');
  const inputDataInicio = document.getElementById('inputDataInicio');


  // Fun√ß√£o principal para abrir o modal
  function abrirModal(mode){
    modalMode = mode;
    modalLeituras.classList.add('hidden');
    modalConfiguracao.classList.add('hidden');
    modalStatus.classList.add('hidden'); // Oculta o status por padr√£o
    btnLido.classList.add('hidden');
    btnLerAgora.classList.add('hidden');
    btnConfirmar.classList.add('hidden');
    btnCancelar.classList.add('hidden');
    btnAcaoSecundaria.classList.add('hidden');
    inputDataInicio.classList.add('hidden');
    document.getElementById('modalMsg').innerHTML = '';
    // Reseta a cor de fundo do modalContent para o padr√£o (para o caso de ser um dia lido)
    modalContent.classList.remove('bg-gray-100', 'dark:bg-gray-700'); 

    const texts = UI_TEXT[state.idioma];

    if (mode === 'leitura') {
        // Modo Leitura (chamado por abrirModalForDay)
        modalLeituras.classList.remove('hidden');
        btnLido.classList.remove('hidden');
        btnLerAgora.classList.remove('hidden');
        
        // Verifica se o dia atual est√° lido e atualiza o visual/texto
        updateModalReadingState(modalCurrentDay);

    } else if (mode === 'config') {
        // Modo Configura√ß√£o (Data de In√≠cio) - Cont√©m o bot√£o Reset/Limpeza
        modalConfiguracao.classList.remove('hidden');
        document.getElementById('modalTitulo').innerText = texts.configuracao;
        document.getElementById('modalMsg').innerText = texts.btn_iniciar + ':'; // Texto "Definir Data de In√≠cio:"
        
        inputDataInicio.value = state.startDate || new Date().toISOString().split('T')[0];
        inputDataInicio.classList.remove('hidden');
        
        btnConfirmar.innerText = texts.btn_salvar;
        btnConfirmar.classList.remove('hidden');
        btnCancelar.innerText = texts.cancelar;
        btnCancelar.classList.remove('hidden');
        
        // Bot√£o de Reset
        btnAcaoSecundaria.innerText = texts.reset_plano;
        btnAcaoSecundaria.classList.remove('hidden');
        btnAcaoSecundaria.onclick = () => { fecharModal(); abrirModal('reset_warning'); }; 
        btnConfirmar.onclick = handleModalConfirm; // A√ß√£o de Confirma√ß√£o √© Salvar
        btnCancelar.onclick = fecharModal;

    } else if (mode === 'reset_warning') {
        // Modo Aviso de Reset (Limpeza de Cache com Alerta)
        modalConfiguracao.classList.remove('hidden');
        document.getElementById('modalTitulo').innerText = texts.reset_titulo;
        document.getElementById('modalMsg').innerHTML = texts.reset_msg.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        
        btnConfirmar.innerText = texts.reset_confirmar;
        btnConfirmar.classList.remove('hidden');
        // A√á√ÉO DIRETA DE LIMPAR TUDO
        btnConfirmar.onclick = () => { fecharModal(); resetApp(); }; 
        
        btnCancelar.innerText = texts.cancelar;
        btnCancelar.classList.remove('hidden');
        btnCancelar.onclick = fecharModal;

    } else if (mode === 'change_plan_warning') {
        // NOVO: Modo Aviso de Troca de Plano
        modalConfiguracao.classList.remove('hidden');
        document.getElementById('modalTitulo').innerText = texts.change_plan_titulo;
        document.getElementById('modalMsg').innerHTML = texts.change_plan_msg.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        
        btnConfirmar.innerText = texts.change_plan_confirmar;
        btnConfirmar.classList.remove('hidden');
        // A√á√ÉO DIRETA DE TROCAR PLANO E RESETAR PROGRESSO
        btnConfirmar.onclick = () => { fecharModal(); fullPlanChange(); }; 
        
        btnCancelar.innerText = texts.cancelar;
        btnCancelar.classList.remove('hidden');
        btnCancelar.onclick = fecharModal;
    }
    
    // Configura√ß√£o visual do modal (Fade-in)
    modalDiv.classList.remove('hidden');
    setTimeout(()=>{
      modalDiv.style.opacity = '1';
      modalContent.classList.remove('scale-95');
    }, 10); 

    if(window.lucide) window.lucide.createIcons();
  }
  
  // NOVO: Fun√ß√£o para atualizar o estado visual do modal de leitura
  function updateModalReadingState(dayOfYear) {
      if (!state.planoId) return;
      const key = `${state.planoId}_day_${dayOfYear}`;
      const lido = localStorage.getItem(key);
      const texts = UI_TEXT[state.idioma];

      if (lido) {
          // Se lido: Muda o fundo do modal, exibe status e muda o bot√£o para desmarcar
          modalContent.classList.add('bg-gray-100', 'dark:bg-gray-700'); 
          modalStatus.innerText = texts.concluido;
          modalStatus.classList.remove('hidden');
          btnLido.innerText = texts.desmarcar;
          btnLido.classList.remove('bg-primary-500', 'hover:bg-primary-600');
          btnLido.classList.add('bg-red-600', 'hover:bg-red-700');
      } else {
          // Se n√£o lido: Remove o fundo cinza, oculta status e muda o bot√£o para marcar
          modalContent.classList.remove('bg-gray-100', 'dark:bg-gray-700'); 
          modalStatus.classList.add('hidden');
          btnLido.innerText = texts.marcar;
          btnLido.classList.remove('bg-red-600', 'hover:bg-red-700');
          btnLido.classList.add('bg-primary-500', 'hover:bg-primary-600');
      }
  }


  function abrirModalForDay(dayOfYear){
    if (!state.planoId) return;
    modalCurrentDay = dayOfYear;
    const plan = getPlan(state.planoId, state.idioma);
    const refs = plan[dayOfYear-1] || [];
    document.getElementById('modalTitulo').innerText = `${UI_TEXT[state.idioma].start} ‚Ä¢ ${UI_TEXT[state.idioma].dia_leitura} ${dayOfYear}`;
    
    modalLeituras.innerHTML = '';
    
    refs.forEach(r=>{
      const li = document.createElement('li'); li.className='text-base flex items-center p-2 rounded-lg bg-gray-50 dark:bg-gray-700';
      const icon = document.createElement('i'); icon.setAttribute('data-lucide', 'book-open'); icon.className='lucide w-4 h-4 mr-3 text-primary-500 flex-shrink-0';
      const span = document.createElement('span'); span.innerText = r;
      li.appendChild(icon);
      li.appendChild(span);
      modalLeituras.appendChild(li);
    });
    
    abrirModal('leitura');
    // Chama a fun√ß√£o para garantir o estado visual correto ap√≥s a abertura
    updateModalReadingState(dayOfYear); 
  }

  function fecharModal(){
    modalDiv.style.opacity = '0';
    modalContent.classList.add('scale-95');
    // Reinicia o onclick do bot√£o confirmar para o padr√£o (Salvar Data de In√≠cio)
    btnConfirmar.onclick = handleModalConfirm; 
    setTimeout(()=> modalDiv.classList.add('hidden'), 300); 
  }

  // L√≥gica para marcar/desmarcar
  document.getElementById('btnLido').addEventListener('click', ()=>{
    if(!modalCurrentDay) return; 
    const key = `${state.planoId}_day_${modalCurrentDay}`; 
    
    // Toggle (Marcar/Desmarcar)
    if(localStorage.getItem(key)) {
        localStorage.removeItem(key); // Desmarcar
    } else {
        localStorage.setItem(key,'1'); // Marcar
    }
    
    // Atualiza o estado do modal instantaneamente
    updateModalReadingState(modalCurrentDay);

    // Re-renderizar a grade de dias e o progresso
    const { month } = dayOfYearToMonthDay(modalCurrentDay);
    if (state.selectedMonth !== month) {
      state.selectedMonth = month;
      renderMonths();
    }
    renderDays(state.selectedMonth); 
    updateProgressUI();
  });

  // Listener para o bot√£o de Configura√ß√£o/Iniciar (na p√°gina do plano)
  document.getElementById('btnConfiguracao').addEventListener('click', () => {
      if (!state.planoId) return;
      btnConfirmar.onclick = handleModalConfirm; 
      abrirModal('config');
  });

  // A√ß√£o de Confirma√ß√£o (Salvar Data de In√≠cio)
  function handleModalConfirm() {
      if (modalMode === 'config') {
          const newDate = inputDataInicio.value;
          if (newDate) {
              // Salva a data de in√≠cio para a l√≥gica de atraso/adiantamento
              state.startDate = newDate;
              localStorage.setItem('bib_startDate', newDate);
              updateProgressUI(); // Atualiza UI com novo status
              renderDays(state.selectedMonth); // Re-renderiza para atualizar destaques
              fecharModal();
          }
      }
  }
  btnConfirmar.addEventListener('click', handleModalConfirm);
  btnCancelar.addEventListener('click', fecharModal);


  // Fun√ß√£o para Resetar o Aplicativo (Limpeza de Cache Total)
  function resetApp() {
      for(let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          if (key.startsWith('bib_') || key.includes('_day_')) { 
              localStorage.removeItem(key);
              i--; 
          }
      }
      state.idioma = 'pt';
      state.planoId = null;
      state.startDate = null;
      state.selectedMonth = 1;
      location.reload(); 
  }


  document.getElementById('btnLerAgora').addEventListener('click', ()=>{
    if(!modalCurrentDay || !state.planoId) return; 
    const plan = getPlan(state.planoId, state.idioma); 
    const refs = plan[modalCurrentDay-1] || [];
    if(refs.length===0) return;
    const joinForSearch = refs.map(r=> r.replace(/\s+/g,' ')).join(',');
    const version = state.idioma==='pt' ? 'NVI-PT' : state.idioma==='en' ? 'NIV' : 'NIV';
    const url = `https://www.biblegateway.com/passage/?search=${encodeURIComponent(joinForSearch)}&version=${version}`;
    window.open(url, '_blank');
  });
  
  document.getElementById('modal').addEventListener('click',(e)=>{ if(e.target.id==='modal') fecharModal(); });

  function updateProgressUI(){
    if (!state.planoId) return;
      
    const plan = getPlan(state.planoId, state.idioma);
    const total = plan.length; let read=0;
    for(let i=0;i<total;i++){ if(localStorage.getItem(`${state.planoId}_day_${i+1}`)) read++; }
    const pct = Math.round((read/total)*100);
    
    const progressoBar = document.getElementById('progressoBar');
    const textoProgresso = document.getElementById('textoProgresso');
    const textoPlanoAtual = document.getElementById('textoPlanoAtual');
    const textoDataInicio = document.getElementById('textoDataInicio');
    const btnMeta = document.getElementById('btnMeta');
    const btnConfiguracao = document.getElementById('btnConfiguracao'); 

    if (progressoBar) progressoBar.style.width = pct + '%';
    if (textoProgresso) textoProgresso.innerText = `${UI_TEXT[state.idioma].progresso}: ${read} / ${total}`;
    
    const planoEncontrado = UI_TEXT[state.idioma].planos.find(p=>p.id===state.planoId);
    const planName = planoEncontrado ? planoEncontrado.title : '---';
      
    const trocarPlanoLink = document.getElementById('trocarPlanoLink');
    if (trocarPlanoLink) trocarPlanoLink.querySelector('span').innerText = `${UI_TEXT[state.idioma].plano}: ${planName} ‚Ä¢ ${UI_TEXT[state.idioma].link_trocar}`;

    // Atualiza Data de In√≠cio e Status de Atraso/Bot√£o Configura√ß√£o
    if (textoDataInicio && btnConfiguracao) {
        if (state.startDate) {
            // L√≥gica de Atraso/Adiantamento
            const expectedDay = getDaysSinceStart();
            const nextUnreadDay = findNextUnreadDay();
            const diff = expectedDay - nextUnreadDay; // > 0: Atrasado, 0: Em dia, < 0: Adiantado

            let statusText = '';
            if (diff > 0) {
                statusText = UI_TEXT[state.idioma].status_atraso.replace('{dias}', diff);
            } else if (diff === 0) {
                statusText = UI_TEXT[state.idioma].status_emdia;
            } else {
                statusText = UI_TEXT[state.idioma].status_adiantado.replace('{dias}', Math.abs(diff));
            }
            
            // Texto principal da data
            const inicio = UI_TEXT[state.idioma].data_inicio;
            const dataFmt = formatDisplayDate(state.startDate);
            textoDataInicio.innerHTML = `${inicio}: <strong>${dataFmt}</strong><br><span class="text-xs text-gray-500 dark:text-gray-400">${statusText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')}</span>`;

            // Bot√£o: Configura√ß√µes do Plano
            btnConfiguracao.innerHTML = `<i data-lucide="settings" class="lucide w-4 h-4 mr-1"></i><span id="textoConfiguracao">${UI_TEXT[state.idioma].configuracao}</span>`;
            

            // Habilita o bot√£o META
            if(btnMeta) btnMeta.disabled = false;

        } else {
            // Texto: Data de In√≠cio n√£o definida
            textoDataInicio.innerText = `${UI_TEXT[state.idioma].data_inicio}: ${UI_TEXT[state.idioma].nao_definido}`;
            
            // ** BOT√ÉO INICIAR (Definir Data de In√≠cio) **
            btnConfiguracao.innerHTML = `<i data-lucide="calendar-check" class="lucide w-4 h-4 mr-1"></i><span id="textoConfiguracao">${UI_TEXT[state.idioma].btn_iniciar}</span>`;
            
             // Desabilita o bot√£o META
            if(btnMeta) btnMeta.disabled = true;
        }
    }
    if(window.lucide) window.lucide.createIcons();
  }

  // NOVO: EVENTO DO LINK "TROCAR PLANO" - Com Aviso
  document.addEventListener('click', (e) => {
      if (e.target && e.target.id === 'trocarPlanoLink' || e.target.closest('#trocarPlanoLink')) {
          e.preventDefault();
          // Se j√° existe plano, abre o modal de aviso antes de prosseguir
          if(state.planoId) {
              abrirModal('change_plan_warning');
          } else {
              // Se n√£o h√° plano, apenas navega
              showPage('paginaSelecao');
          }
      }
  });


  // ---------- IDIOMA DROPDOWN LOGIC ----------
  const idiomaToggle = document.getElementById('idiomaToggle');
  const idiomaMenu = document.getElementById('idiomaMenu');
  const currentFlag = document.getElementById('currentFlag');
  const idiomaItems = document.querySelectorAll('.idioma-item');

  function updateIdiomaDisplay(lang){
    const texts = UI_TEXT[lang];
    const flagCode = texts.flag_code;

    currentFlag.className = `flag-icon flag-icon-${flagCode}`;
    
    idiomaItems.forEach(item => {
        if(item.getAttribute('data-lang') === lang) {
            item.classList.add('bg-gray-200', 'dark:bg-gray-600');
        } else {
            item.classList.remove('bg-gray-200', 'dark:bg-gray-600');
        }
    });

    updateUITexts(lang);
  }
  
  function toggleIdiomaMenu(){
      const isHidden = idiomaMenu.classList.contains('hidden');
      if (isHidden) {
          idiomaMenu.classList.remove('hidden');
          setTimeout(() => {
              idiomaMenu.classList.remove('scale-95', 'opacity-0');
          }, 10);
      } else {
          idiomaMenu.classList.add('scale-95', 'opacity-0');
          setTimeout(() => {
              idiomaMenu.classList.add('hidden');
          }, 150);
      }
  }

  idiomaToggle.addEventListener('click', toggleIdiomaMenu);
  document.addEventListener('click', (e) => {
      const idiomaDropdown = document.getElementById('idiomaDropdown');
      const isClickInside = idiomaDropdown.contains(e.target);
      if (!isClickInside && !idiomaMenu.classList.contains('hidden')) {
          toggleIdiomaMenu();
      }
  });


  idiomaItems.forEach(item => {
      item.addEventListener('click', (e) => {
          const newLang = item.getAttribute('data-lang');
          if (newLang !== state.idioma) {
              state.idioma = newLang; 
              localStorage.setItem('bib_idioma', state.idioma);
              updateIdiomaDisplay(state.idioma);
          }
          toggleIdiomaMenu();
      });
  });

  // Fun√ß√£o centralizada de atualiza√ß√£o de texto
  function updateUITexts(lang){
    showPage(state.planoId ? 'paginaPlano' : 'paginaSelecao');

    const btnMetaText = document.getElementById('btnMetaText');
    if (btnMetaText) {
        btnMetaText.innerText = UI_TEXT[lang].meta;
    }
  }

  // Navega para o m√™s da META e destaca o dia META (Pr√≥ximo Dia Pendente)
  function goToMeta() {
      if (!state.planoId || !state.startDate) {
          return;
      }

      const nextUnreadDay = findNextUnreadDay();
      if (!nextUnreadDay) return; 

      const { month } = dayOfYearToMonthDay(nextUnreadDay);
      
      if (state.selectedMonth !== month) {
          state.selectedMonth = month;
      }
      
      renderMonths();
      renderDays(state.selectedMonth);
      
      const dayOfMonth = nextUnreadDay - monthDayToDayOfYear(month, 1) + 1;
      const targetCard = document.querySelector(`#dias > div:nth-child(${dayOfMonth})`);
      
      if (targetCard) {
          targetCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
  }


  // ---------- INITIALIZE APP ----------
  function init(){
    const today = new Date(); 
    state.planoId = localStorage.getItem('bib_plano');
    state.selectedMonth = state.selectedMonth || (today.getMonth()+1);
    
    updateIdiomaDisplay(state.idioma);
    
    const btnMeta = document.getElementById('btnMeta');
    if (btnMeta) {
        btnMeta.addEventListener('click', goToMeta);
    }
  }
  
  // Executa a inicializa√ß√£o ap√≥s o DOM carregar
  document.addEventListener('DOMContentLoaded', () => {
      // --- L√≥gica do Tema (Original) ---
      const btnTema = document.getElementById('btnTema');
      const themeStatusText = document.getElementById('themeStatusText'); 
      const root = document.documentElement;
  
      function applyTheme(isDark) {
          root.classList.toggle('dark', !!isDark);
          if (isDark) {
              localStorage.setItem('bib_theme', 'dark');
              if (themeStatusText) themeStatusText.innerText = 'üåû'; 
          } else {
              localStorage.removeItem('bib_theme');
              if (themeStatusText) themeStatusText.innerText = 'üåô';
          }
      }
  
      function toggleTheme() {
          const nowDark = root.classList.contains('dark');
          applyTheme(!nowDark);
      }
  
      // 1. Inicializa o tema na carga
      const storedDark = localStorage.getItem('bib_theme') === 'dark';
      applyTheme(storedDark);
      
      // 2. Adiciona listener ao bot√£o de tema
      if(btnTema) btnTema.addEventListener('click', toggleTheme);

      // --- Inicializa√ß√£o Principal (inclui o listener do bot√£o Meta) ---
      init();
  });
  </script>

</body>
</html>