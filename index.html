<!DOCTYPE html>
<html lang="pt" class="">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Plano de Leitura B√≠blica</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <script src="https://cdn.tailwindcss.com"></script>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/lipis/flag-icon-css@1.0/css/flag-icon.min.css"/>
  
  <script type="module" src="https://unpkg.com/lucide@0.259.0/dist/lucide.esm.js"></script>
  <script nomodule src="https://unpkg.com/lucide@0.259.0/dist/lucide.js"></script>

  <script>
    tailwind.config = {
      darkMode: 'class', // Ativa o modo escuro baseado na classe 'dark'
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', 'sans-serif'],
          },
          colors: {
            // Cores para o progresso
            'primary': {
              500: '#4f46e5', // Indigo padr√£o (Em Dia)
              600: '#4338ca', // Indigo mais escuro para hover
            },
            'progress-ok': '#4f46e5', // Indigo
            'progress-late': '#f97316', // Orange
          }
        }
      }
    }
  </script>

  <style>
    /* pequeno polimento */
    .plan-button:active, #idiomaToggle:active, #btnTema:active { transform: scale(.995); }
    /* transi√ß√£o suave para a barra de progresso */
    #progressoBar { transition: width 350ms ease; }
    
    /* Destaque ao clicar no bot√£o "Hoje" (Contorno) */
    #btnHoje:active { 
        transform: scale(.995); 
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.5); /* Contorno suave */
    }

    /* Destaque visual para o dia atual no grid de leitura */
    .today-highlight {
        border: 2px solid #4f46e5 !important; /* Cor prim√°ria */
        background-color: #eef2ff !important; /* Indigo-50 claro */
        transform: scale(1.01);
        box-shadow: 0 4px 12px rgba(79, 70, 229, 0.2);
    }
    .dark .today-highlight {
        --tw-bg-opacity: 1; 
        background-color: rgb(30 41 59 / var(--tw-bg-opacity)) !important; /* slate-800 */
        border-color: #6366f1 !important; /* Indigo-500 light */
    }
    
    /* Classe oculta */
    .hidden-page { display: none; }
  </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-screen flex flex-col font-sans">

  <header class="p-4 sm:p-6 bg-white dark:bg-gray-800 shadow-sm border-b border-gray-100 dark:border-gray-700">
    <div class="max-w-7xl mx-auto flex items-center justify-between gap-4">
      <div class="flex items-center gap-3">
        <div class="rounded-xl bg-primary-500 text-white w-10 h-10 flex items-center justify-center text-xl font-extrabold shadow-md">B</div>
        <div>
          <h1 id="tituloApp" class="text-xl font-bold">üìÖ Plano de Leitura B√≠blica</h1>
          <p id="subtituloApp" class="text-sm text-gray-600 dark:text-gray-400">Escolha um plano e comece hoje</p>
        </div>
      </div>

      <div class="flex items-center gap-2">
        <div id="idiomaDropdown" class="relative">
            <button id="idiomaToggle" class="px-3 py-2 rounded-xl bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 transition font-medium flex items-center justify-center gap-1" aria-label="Alterar idioma">
                <span id="currentFlag" class="flag-icon"></span>
            </button>

            <div id="idiomaMenu" class="absolute right-0 mt-2 w-20 bg-white dark:bg-gray-700 rounded-xl shadow-2xl py-1 z-10 hidden ring-1 ring-black ring-opacity-5 origin-top-right transition-all duration-150 transform scale-95 opacity-0">
                <button class="idioma-item w-full text-center px-4 py-2 text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-600 flex items-center justify-center" data-lang="pt">
                    <span class="flag-icon flag-icon-br"></span>
                </button>
                <button class="idioma-item w-full text-center px-4 py-2 text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-600 flex items-center justify-center" data-lang="en">
                    <span class="flag-icon flag-icon-us"></span>
                </button>
                <button class="idioma-item w-full text-center px-4 py-2 text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-600 flex items-center justify-center" data-lang="es">
                    <span class="flag-icon flag-icon-es"></span>
                </button>
            </div>
        </div>
        
        <button id="btnHoje" class="p-2 px-3 rounded-xl bg-gray-200 dark:bg-gray-700 hover:scale-105 transition flex items-center justify-center font-semibold text-sm" aria-label="Voltar para o dia de hoje">
          üìÖ <span id="btnHojeText" class="ml-1 hidden sm:inline">HOJE</span>
        </button>

        <button id="btnTema" class="p-2 px-3 rounded-xl bg-gray-200 dark:bg-gray-700 hover:scale-105 transition flex items-center justify-center font-semibold text-sm" aria-label="Alternar tema">
          <span id="themeStatusText">üåô</span> </button>
      </div>
    </div>
  </header>
  
  <main class="p-4 sm:p-6 flex-1 overflow-auto">
    
    <section id="paginaSelecao" class="pagina max-w-7xl mx-auto w-full">
      <h2 class="mt-8 mb-4 text-center text-xl font-bold text-gray-700 dark:text-gray-300">Escolha seu Plano de Leitura</h2>
      <p class="text-center text-gray-500 dark:text-gray-400 mb-8">Seu plano ser√° salvo automaticamente.</p>
      
      <div id="gridPlanos" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mx-auto mt-4">
        </div>
    </section>

    <section id="paginaPlano" class="pagina max-w-7xl mx-auto w-full hidden-page">
      
      <div class="px-1 mt-0">
        <div class="flex items-center justify-between mb-2">
          <div class="text-base font-semibold" id="textoProgresso">Progresso: 0 / 365</div>
          <a href="#" id="trocarPlanoLink" class="text-sm text-primary-500 font-medium hover:text-primary-600 transition flex items-center">
            <span id="textoPlanoAtual">Plano: Tradicional</span>
            <i data-lucide="chevron-right" class="lucide w-4 h-4 ml-1"></i>
          </a>
        </div>
        <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-3.5 overflow-hidden">
          <div id="progressoBar" class="bg-primary-500 h-3.5 rounded-full" style="width:0%"></div>
        </div>
      </div>
      
      <div class="mt-8">
        <h2 class="text-xl font-bold mb-4 px-1">Selecione o M√™s</h2>
        <div id="meses" class="flex gap-2 overflow-x-auto pb-3 px-1 border-b border-gray-200 dark:border-gray-700"></div>
      </div>

      <div id="dias" class="mt-6 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 xl:grid-cols-7 gap-4 px-1">
        </div>
    </section>

  </main>
  
  <div id="modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50 p-4 transition-opacity duration-300" style="opacity:0;" aria-modal="true" role="dialog">
    <div id="modalContent" class="bg-white dark:bg-gray-800 p-6 rounded-3xl w-full max-w-md shadow-2xl scale-95 transition-transform duration-300">
      <div class="flex justify-between items-start">
        <h3 id="modalTitulo" class="text-2xl font-extrabold text-primary-500"></h3>
        <button id="fecharModal" class="p-1 rounded-full text-gray-500 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition">
          <i data-lucide="x" class="lucide w-6 h-6"></i>
        </button>
      </div>

      <ul id="modalLeituras" class="mt-4 space-y-2 text-gray-700 dark:text-gray-200 border-t pt-4 border-gray-200 dark:border-gray-700"></ul>

      <div class="mt-6 flex gap-3">
        <button id="btnLido" class="flex-1 px-4 py-3 rounded-xl bg-primary-500 text-white font-semibold hover:bg-primary-600 transition shadow-lg shadow-primary-500/30">‚úî Marcar como lido</button>
        <button id="btnLerAgora" class="px-4 py-3 rounded-xl bg-blue-600 text-white font-semibold hover:bg-blue-700 transition shadow-lg shadow-blue-600/30">üìñ Ler agora</button>
      </div>
    </div>
  </div>

  <footer class="mt-12 py-6 border-t border-gray-200 dark:border-gray-700 text-center text-sm text-gray-600 dark:text-gray-400">
    ¬© 2025 Alex Silva ‚Äî <em>Uso livre com atribui√ß√£o</em>
  </footer>

  <script>
  
  // ---------- CONFIG / TEXTS ----------
  const UI_TEXT = {
    pt: {
      titulo: 'Plano B√≠blico',
      subtitulo: 'Acompanhe seu progresso',
      titulo_selecao: 'Plano B√≠blico',
      subtitulo_selecao: 'Seu plano ser√° salvo automaticamente.',
      link_trocar: 'Trocar Plano',
      // ... (outros textos)
      ler_agora: 'Ler agora',
      planos: [
        { id: 'tradicional', title: 'Tradicional', desc: 'G√™nesis ‚Üí Apocalipse (padr√£o)' },
        { id: 'cronologico', title: 'Cronol√≥gico', desc: 'Ordem hist√≥rica aproximada' },
        { id: 'atnt', title: 'AT + NT', desc: 'Um trecho do AT e um do NT por dia' },
        { id: 'jesus', title: 'Um Ano com Jesus', desc: 'Evangelhos ‚Üí Atos ‚Üí Cartas ‚Üí Resto' },
        { id: 'umcap', title: '1 Cap√≠tulo/Dia', desc: '1 cap√≠tulo por dia (365 sele√ß√µes)' },
        { id: 'salmos', title: 'AT+NT+Salmos', desc: 'AT + NT + Salmo/Prov√©rbio di√°rio' }
      ],
      start: 'Dia de Leitura',
      marcar: '‚úî Marcar como lido',
      fechar: 'Fechar',
      progresso: 'Progresso',
      plano: 'Plano',
      dia_leitura: 'Dia',
      lang_name: 'Portugu√™s',
      flag_code: 'br',
      hoje: 'HOJE',
      status_late: 'ATRASADO', // Novo
      status_ok: 'EM DIA',      // Novo
      btn_start: 'INICIAR PLANO', // Novo
      confirm_change: 'Tem certeza que deseja trocar de plano? Seu hist√≥rico de leitura ATUAL ser√° perdido.', // Novo
    },
    en: {
        titulo: 'Bible Plan',
        subtitulo: 'Track your progress',
        titulo_selecao: 'Bible Plan',
        subtitulo_selecao: 'Your plan will be saved automatically.',
        link_trocar: 'Change Plan',
        // ... (other texts)
        ler_agora: 'Read now',
        planos: [
          { id: 'tradicional', title: 'Traditional', desc: 'Genesis ‚Üí Revelation (standard)' },
          { id: 'cronologico', title: 'Chronological', desc: 'Approx. historical order' },
          { id: 'atnt', title: 'OT + NT', desc: 'OT + NT passage per day' },
          { id: 'jesus', title: 'One Year with Jesus', desc: 'Gospels ‚Üí Acts ‚Üí Letters ‚Üí Rest' },
          { id: 'umcap', title: '1 Chapter/Day', desc: '1 chapter per day (365 picks)' },
          { id: 'salmos', title: 'OT+NT+Psalms', desc: 'OT + NT + Psalm/Proverb daily' }
        ],
        start: 'Reading Day',
        marcar: '‚úî Mark as read',
        fechar: 'Close',
        progresso: 'Progress',
        plano: 'Plan',
        dia_leitura: 'Day',
        lang_name: 'English',
        flag_code: 'us',
        hoje: 'TODAY',
        status_late: 'BEHIND SCHEDULE', // Novo
        status_ok: 'ON TRACK',          // Novo
        btn_start: 'START PLAN',        // Novo
        confirm_change: 'Are you sure you want to change plans? Your CURRENT reading history will be lost.', // Novo
    },
    es: {
        titulo: 'Plan B√≠blico',
        subtitulo: 'Sigue tu progreso',
        titulo_selecao: 'Plan B√≠blico',
        subtitulo_selecao: 'Tu plan se guardar√° autom√°ticamente.',
        link_trocar: 'Cambiar Plan',
        // ... (other texts)
        ler_agora: 'Leer ahora',
        planos: [
          { id: 'tradicional', title: 'Tradicional', desc: 'G√©nesis ‚Üí Apocalipsis (est√°ndar)' },
          { id: 'cronologico', title: 'Cronol√≥gico', desc: 'Orden hist√≥rico aproximado' },
          { id: 'atnt', title: 'AT + NT', desc: 'Pasaje de AT y NT por d√≠a' },
          { id: 'jesus', title: 'Un A√±o con Jes√∫s', desc: 'Evangelios ‚Üí Hechos ‚Üí Cartas ‚Üí Resto' },
          { id: 'umcap', title: '1 Cap√≠tulo/D√≠a', desc: '1 cap√≠tulo por d√≠a (365 selecciones)' },
          { id: 'salmos', title: 'AT+NT+Salmos', desc: 'AT + NT + Salmo/Proverbio diario' }
        ],
        start: 'D√≠a de Lectura',
        marcar: '‚úî Marcar como le√≠do',
        fechar: 'Cerrar',
        progresso: 'Progreso',
        plano: 'Plan',
        dia_leitura: 'Day',
        lang_name: 'Espa√±ol',
        flag_code: 'es',
        hoje: 'HOY',
        status_late: 'ATRASADO', // Novo
        status_ok: 'AL D√çA',     // Novo
        btn_start: 'INICIAR PLAN', // Novo
        confirm_change: '¬øEst√° seguro de que desea cambiar de plan? Su historial de lectura ACTUAL se perder√°.', // Novo
    }
  };
  
  // (Constantes de Meses, Livros e Fun√ß√µes de Gera√ß√£o de Plano - MANTIDAS)
  const MONTHS = {
    pt: ["Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set","Out","Nov","Dez"],
    en: ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],
    es: ["Ene","Feb","Mar","Abr","Mai","Jun","Jul","Ago","Sep","Oct","Nov","Dic"]
  };
  const DAYS_PER_MONTH = [31,28,31,30,31,30,31,31,30,31,30,31];
  const BOOKS = [
    { key:'Genesis', ch:50, name:{pt:'G√™nesis', en:'Genesis', es:'G√©nesis'} },
    { key:'Exodus', ch:40, name:{pt:'√äxodo', en:'Exodus', es:'Exodus'} },
    { key:'Leviticus', ch:27, name:{pt:'Lev√≠tico', en:'Leviticus', es:'Lev√≠tico'} },
    { key:'Numbers', ch:36, name:{pt:'N√∫meros', en:'Numbers', es:'N√∫meros'} },
    { key:'Deuteronomy', ch:34, name:{pt:'Deuteron√¥mio', en:'Deuteronomy', es:'Deuteronomio'} },
    { key:'Joshua', ch:24, name:{pt:'Josu√©', en:'Joshua', es:'Josu√©'} },
    { key:'Judges', ch:21, name:{pt:'Ju√≠zes', en:'Judges', es:'Jueces'} },
    { key:'Ruth', ch:4, name:{pt:'Rute', en:'Ruth', es:'Rut'} },
    { key:'1 Samuel', ch:31, name:{pt:'1 Samuel', en:'1 Samuel', es:'1 Samuel'} },
    { key:'2 Samuel', ch:24, name:{pt:'2 Samuel', en:'2 Samuel', es:'2 Samuel'} },
    { key:'1 Kings', ch:22, name:{pt:'1 Reis', en:'1 Kings', es:'1 Reyes'} },
    { key:'2 Kings', ch:25, name:{pt:'2 Reis', en:'2 Kings', es:'2 Reyes'} },
    { key:'1 Chronicles', ch:29, name:{pt:'1 Cr√¥nicas', en:'1 Chronicles', es:'1 Cr√≥nicas'} },
    { key:'2 Chronicles', ch:36, name:{pt:'2 Cr√¥nicas', en:'2 Chronicles', es:'2 Cr√≥nicas'} },
    { key:'Ezra', ch:10, name:{pt:'Esdras', en:'Ezra', es:'Esdras'} },
    { key:'Nehemiah', ch:13, name:{pt:'Neemias', en:'Nehemiah', es:'Nehem√≠as'} },
    { key:'Esther', ch:10, name:{pt:'Ester', en:'Esther', es:'Ester'} },
    { key:'Job', ch:42, name:{pt:'J√≥', en:'Job', es:'Job'} },
    { key:'Psalms', ch:150, name:{pt:'Salmos', en:'Psalms', es:'Salmos'} },
    { key:'Proverbs', ch:31, name:{pt:'Prov√©rbios', en:'Proverbs', es:'Proverbios'} },
    { key:'Ecclesiastes', ch:12, name:{pt:'Eclesiastes', en:'Ecclesiastes', es:'Eclesiast√©s'} },
    { key:'Song of Solomon', ch:8, name:{pt:'C√¢nticos', en:'Song of Solomon', es:'Cantar de los Cantares'} },
    { key:'Isaiah', ch:66, name:{pt:'Isa√≠as', en:'Isaiah', es:'Isa√≠as'} },
    { key:'Jeremiah', ch:52, name:{pt:'Jeremias', en:'Jeremiah', es:'Jerem√≠as'} },
    { key:'Lamentations', ch:5, name:{pt:'Lamenta√ß√µes', en:'Lamentations', es:'Lamentaciones'} },
    { key:'Ezekiel', ch:48, name:{pt:'Ezequiel', en:'Ezekiel', es:'Ezequiel'} },
    { key:'Daniel', ch:12, name:{pt:'Daniel', en:'Daniel', es:'Daniel'} },
    { key:'Hosea', ch:14, name:{pt:'Os√©ias', en:'Hosea', es:'Oseas'} },
    { key:'Joel', ch:3, name:{pt:'Joel', en:'Joel', es:'Joel'} },
    { key:'Amos', ch:9, name:{pt:'Am√≥s', en:'Amos', es:'Am√≥s'} },
    { key:'Obadiah', ch:1, name:{pt:'Obadias', en:'Obadiah', es:'Abd√≠as'} },
    { key:'Jonah', ch:4, name:{pt:'Jonas', en:'Jonah', es:'Jon√°s'} },
    { key:'Micah', ch:7, name:{pt:'Miqu√©ias', en:'Micah', es:'Miqueas'} },
    { key:'Nahum', ch:3, name:{pt:'Naum', en:'Nahum', es:'Nah√∫m'} },
    { key:'Habakkuk', ch:3, name:{pt:'Habacuque', en:'Habakkuk', es:'Habacuc'} },
    { key:'Zephaniah', ch:3, name:{pt:'Sofonias', en:'Zephaniah', es:'Sofon√≠as'} },
    { key:'Haggai', ch:2, name:{pt:'Ageu', en:'Haggai', es:'Ageo'} },
    { key:'Zechariah', ch:14, name:{pt:'Zacarias', en:'Zechariah', es:'Zacar√≠as'} },
    { key:'Malachi', ch:4, name:{pt:'Malaquias', en:'Malachi', es:'Malaqu√≠as'} },
    { key:'Matthew', ch:28, name:{pt:'Mateus', en:'Matthew', es:'Mateo'} },
    { key:'Mark', ch:16, name:{pt:'Marcos', en:'Mark', es:'Marcos'} },
    { key:'Luke', ch:24, name:{pt:'Lucas', en:'Luke', es:'Lucas'} },
    { key:'John', ch:21, name:{pt:'Jo√£o', en:'John', es:'Juan'} },
    { key:'Acts', ch:28, name:{pt:'Atos', en:'Acts', es:'Hechos'} },
    { key:'Romans', ch:16, name:{pt:'Romanos', en:'Romans', es:'Romanos'} },
    { key:'1 Corinthians', ch:16, name:{pt:'1 Cor√≠ntios', en:'1 Corinthians', es:'1 Corintios'} },
    { key:'2 Corinthians', ch:13, name:{pt:'2 Cor√≠ntios', en:'2 Corinthians', es:'2 Corintios'} },
    { key:'Galatians', ch:6, name:{pt:'G√°latas', en:'Galatians', es:'G√°latas'} },
    { key:'Ephesians', ch:6, name:{pt:'Ef√©sios', en:'Ephesians', es:'Efesios'} },
    { key:'Philippians', ch:4, name:{pt:'Filipenses', en:'Philippians', es:'Filipenses'} },
    { key:'Colossians', ch:4, name:{pt:'Colossenses', en:'Colossians', es:'Colosenses'} },
    { key:'1 Thessalonians', ch:5, name:{pt:'1 Tessalonicenses', en:'1 Thessalonians', es:'1 Tesalonicenses'} },
    { key:'2 Thessalonians', ch:3, name:{pt:'2 Tessalonicenses', en:'2 Thessalonians', es:'2 Tesalonicenses'} },
    { key:'1 Timothy', ch:6, name:{pt:'1 Tim√≥teo', en:'1 Timothy', es:'1 Timoteo'} },
    { key:'2 Timothy', ch:4, name:{pt:'2 Tim√≥teo', en:'2 Timothy', es:'2 Timoteo'} },
    { key:'Titus', ch:3, name:{pt:'Tito', en:'Titus', es:'Tito'} },
    { key:'Philemon', ch:1, name:{pt:'Filemom', en:'Philemon', es:'Filem√≥n'} },
    { key:'Hebrews', ch:13, name:{pt:'Hebreus', en:'Hebrews', es:'Hebreos'} },
    { key:'James', ch:5, name:{pt:'Tiago', en:'James', es:'Santiago'} },
    { key:'1 Peter', ch:5, name:{pt:'1 Pedro', en:'1 Peter', es:'1 Pedro'} },
    { key:'2 Peter', ch:3, name:{pt:'2 Pedro', en:'2 Peter', es:'2 Pedro'} },
    { key:'1 John', ch:5, name:{pt:'1 Jo√£o', en:'1 John', es:'1 Juan'} },
    { key:'2 John', ch:1, name:{pt:'2 Jo√£o', en:'2 John', es:'2 Juan'} },
    { key:'3 John', ch:1, name:{pt:'3 Jo√£o', en:'3 John', es:'3 Juan'} },
    { key:'Jude', ch:1, name:{pt:'Judas', en:'Jude', es:'Judas'} },
    { key:'Revelation', ch:22, name:{pt:'Apocalipse', en:'Revelation', es:'Apocalipsis'} }
  ];
  const FLAT = [];
  (function buildFlat(){
    for(const b of BOOKS){
      for(let c=1;c<=b.ch;c++) FLAT.push({ bookKey: b.key, chapter: c });
    }
  })();
  function bookName(bookKey, lang){
    const b = BOOKS.find(x=>x.key===bookKey);
    return b ? (b.name[lang] || b.name.pt) : bookKey;
  }
  function formatRefObj(obj, lang){
    return `${bookName(obj.bookKey, lang)} ${obj.chapter}`;
  }
  const CHRON_ORDER_KEYS = [ 
    'Genesis','Job','Exodus','Leviticus','Numbers','Deuteronomy','Joshua','Judges','Ruth',
    '1 Samuel','2 Samuel','1 Kings','2 Kings','1 Chronicles','2 Chronicles','Ezra','Nehemiah','Esther',
    'Isaiah','Hosea','Joel','Amos','Obadiah','Jonah','Micah','Nahum','Habakkuk','Zephaniah','Zechariah','Haggai','Malachi',
    'Psalms','Proverbs','Ecclesiastes','Song of Solomon',
    'Matthew','Mark','Luke','John','Acts','Romans','1 Corinthians','2 Corinthians','Galatians','Ephesians','Philippians','Colossians','1 Thessalonians','2 Thessalonians','1 Timothy','2 Timothy','Titus','Philemon','Hebrews','James','1 Peter','2 Peter','1 John','2 John','3 John','Jude','Revelation','Daniel','Jeremiah','Lamentations','Ezekiel'
  ];
  function genTradicional(lang){
    const total = FLAT.length; const perDay = total / 365; const plan = Array.from({length:365}, ()=>[]); let idx=0;
    for(let day=0; day<365; day++){
      const take = Math.max(1, Math.round(perDay));
      for(let t=0; t<take && idx<total; t++, idx++) plan[day].push(formatRefObj(FLAT[idx], lang));
    }
    while(idx<total) plan[plan.length-1].push(formatRefObj(FLAT[idx++], lang));
    return plan;
  }
  function genCronologico(lang){
    const arr = [];
    for(const k of CHRON_ORDER_KEYS){
      const book = BOOKS.find(b=>b.key===k);
      if(!book) continue;
      for(let c=1;c<=book.ch;c++) arr.push({bookKey: book.key, chapter: c});
    }
    for(const b of BOOKS) if(!CHRON_ORDER_KEYS.includes(b.key)) for(let c=1;c<=b.ch;c++) arr.push({bookKey: b.key, chapter: c});
    const total = arr.length; const perDay = total/365; const plan = Array.from({length:365},()=>[]); let idx=0;
    for(let d=0; d<365; d++){
      const take = Math.max(1, Math.round(perDay));
      for(let t=0;t<take && idx<total;t++,idx++) plan[d].push(formatRefObj(arr[idx], lang));
    }
    while(idx<total) plan[plan.length-1].push(formatRefObj(arr[idx++] , lang));
    return plan;
  }
  function genATNT(lang){
    const mattIndex = FLAT.findIndex(c=>c.bookKey==='Matthew');
    const ot = FLAT.slice(0, mattIndex); const nt = FLAT.slice(mattIndex);
    const otPer = ot.length/365; const ntPer = nt.length/365;
    const plan = Array.from({length:365},()=>[]); let i=0,j=0;
    for(let d=0; d<365; d++){
      const takeOT = Math.max(1, Math.round(otPer)); const takeNT = Math.max(1, Math.round(ntPer));
      for(let t=0;t<takeOT && i<ot.length;t++,i++) plan[d].push(formatRefObj(ot[i], lang));
      for(let t=0;t<takeNT && j<nt.length;t++,j++) plan[d].push(formatRefObj(nt[j], lang));
    }
    while(i<ot.length) plan[plan.length-1].push(formatRefObj(ot[i++], lang));
    while(j<nt.length) plan[plan.length-1].push(formatRefObj(nt[j++], lang));
    return plan;
  }
  function genJesusYear(lang){
    const order = ['Matthew','Mark','Luke','John','Acts','Romans','1 Corinthians','2 Corinthians','Galatians','Ephesians','Philippians','Colossians','1 Thessalonians','2 Thessalonians','1 Timothy','2 Timothy','Titus','Philemon','Hebrews','James','1 Peter','2 Peter','1 John','2 John','3 John','3 John','Jude','Revelation'];
    const arr = [];
    for(const name of order){
      const book = BOOKS.find(b=>b.key===name);
      if(!book) continue;
      for(let c=1;c<=book.ch;c++) arr.push({bookKey: book.key, chapter:c});
    }
    for(const b of BOOKS) if(!order.includes(b.key)) for(let c=1;c<=b.ch;c++) arr.push({bookKey: b.key, chapter:c});
    const total = arr.length; const perDay = total/365; const plan = Array.from({length:365},()=>[]); let idx=0;
    for(let d=0; d<365; d++){
      const take = Math.max(1, Math.round(perDay));
      for(let t=0;t<take && idx<total;t++,idx++) plan[d].push(formatRefObj(arr[idx], lang));
    }
    while(idx<total) plan[plan.length-1].push(formatRefObj(arr[idx++]));
    return plan;
  }
  function genUmCapitulo(lang){
    const plan = Array.from({length:365},()=>[]);
    for(let i=0;i<365;i++){
      if(i<FLAT.length) plan[i].push(formatRefObj(FLAT[i], lang)); else plan[i].push('‚Äî');
    }
    return plan;
  }
  function genComSalmos(lang){
    const mattIndex = FLAT.findIndex(c=>c.bookKey==='Matthew');
    const ot = FLAT.slice(0, mattIndex); const nt = FLAT.slice(mattIndex);
    const psStart = FLAT.findIndex(c=>c.bookKey==='Psalms'); const provStart = FLAT.findIndex(c=>c.bookKey==='Proverbs');
    const psCount = BOOKS.find(b=>b.key==='Psalms').ch; const provCount = BOOKS.find(b=>b.key==='Proverbs').ch;
    const otPer = ot.length/365; const ntPer = nt.length/365;
    const plan = Array.from({length:365},()=>[]); let i=0,j=0,p=psStart,pr=provStart,alt=true;
    for(let d=0; d<365; d++){
      const takeOT = Math.max(1, Math.round(otPer)); const takeNT = Math.max(1, Math.round(ntPer));
      for(let t=0;t<takeOT && i<ot.length;t++,i++) plan[d].push(formatRefObj(ot[i], lang));
      for(let t=0;t<takeNT && j<nt.length;t++,j++) plan[d].push(formatRefObj(nt[j], lang));
      if(alt && p < psStart + psCount) plan[d].push(formatRefObj(FLAT[p++], lang));
      else if(!alt && pr < provStart + provCount) plan[d].push(formatRefObj(FLAT[pr++], lang));
      else if(p < psStart + psCount) plan[d].push(formatRefObj(FLAT[p++], lang));
      else if(pr < provStart + provCount) plan[d].push(formatRefObj(FLAT[pr++], lang));
      alt = !alt;
    }
    while(i<ot.length) plan[plan.length-1].push(formatRefObj(ot[i++] , lang));
    while(j<nt.length) plan[plan.length-1].push(formatRefObj(nt[j++] , lang));
    return plan;
  }

  const PLAN_GENERATORS = { tradicional: genTradicional, cronologico: genCronologico, atnt: genATNT, jesus: genJesusYear, umcap: genUmCapitulo, salmos: genComSalmos };
  const CACHE = {};
  function getPlan(id, lang){
    const key = `${id}__${lang}`;
    if(!CACHE[key]) CACHE[key] = PLAN_GENERATORS[id](lang);
    return CACHE[key];
  }

  // ---------- UI & STATE ----------
  let state = {
    // Carrega o idioma e o plano do localStorage ou usa o padr√£o 'pt'/'tradicional'
    idioma: localStorage.getItem('bib_idioma') || 'pt',
    planoId: localStorage.getItem('bib_plano') || null, 
    startDate: localStorage.getItem('bib_startDate') || null, // Carrega a data de in√≠cio
    selectedMonth: 1,
    selectedDayOfMonth: null,
  };
  
  // Calcula o dia do ano (1 a 365)
  function getDayOfYear(date) {
    const start = new Date(date.getFullYear(), 0, 0);
    const diff = date - start;
    const oneDay = 1000 * 60 * 60 * 24;
    return Math.floor(diff / oneDay);
  }

  function dayOfYearToMonthDay(n){
    let m=0; let day = n;
    while(m<12 && day > DAYS_PER_MONTH[m]){ day -= DAYS_PER_MONTH[m]; m++; }
    return { month: m+1, day: day };
  }
  function monthDayToDayOfYear(month, day){
    let s=0; for(let i=0;i<month-1;i++) s+=DAYS_PER_MONTH[i]; return s+day;
  }

  // NOVA FUN√á√ÉO: Calcula o progresso e o status de atraso
  function calculateProgressAndStatus(planoId){
    if(!planoId) return { read: 0, total: 365, requiredDay: 0, isLate: false };
    
    const plan = getPlan(planoId, state.idioma);
    const total = plan.length;
    let read = 0;
    // Percorre todos os 365 dias para contar quantos foram lidos
    for(let i=0;i<total;i++){ 
        if(localStorage.getItem(`${planoId}_day_${i+1}`)) read++; 
    }

    let requiredDay = 0;
    let isLate = false;

    if(state.startDate){
        const start = new Date(state.startDate);
        const today = new Date();
        // Zera as horas para compara√ß√£o justa (apenas a data importa)
        start.setHours(0,0,0,0);
        today.setHours(0,0,0,0);
        
        // Calcula o n√∫mero de dias decorridos (daysPassed) e adiciona 1 (o dia de hoje)
        const timeDiff = today.getTime() - start.getTime();
        // O requiredDay (dia que deveria estar) √© o (dias passados + 1)
        const daysPassed = Math.ceil(timeDiff / (1000 * 3600 * 24)); 
        
        requiredDay = daysPassed > 0 ? daysPassed + 1 : 1; // Dia de leitura que deveria estar (a partir do dia 1)
        requiredDay = Math.min(requiredDay, total); // N√£o ultrapassa o total de dias do plano (365)

        // Se a contagem de dias lidos for menor que o dia requerido, est√° atrasado
        if (read < requiredDay) {
            isLate = true;
        }
    }
    
    return { read, total, requiredDay, isLate };
  }


  // Alterna a visualiza√ß√£o entre as duas "p√°ginas"
  function showPage(pageId) {
      const selecao = document.getElementById('paginaSelecao');
      const plano = document.getElementById('paginaPlano');
      const texts = UI_TEXT[state.idioma];

      if (pageId === 'paginaPlano' && state.planoId) {
          // Exibir P√°gina do Plano
          selecao.classList.add('hidden-page');
          plano.classList.remove('hidden-page');
          
          document.getElementById('tituloApp').innerText = ` ${texts.titulo}`;
          document.getElementById('subtituloApp').innerText = texts.subtitulo;
          
          renderPlanGrid(); // Necess√°rio para atualizar o status do card selecionado
          renderMonths(); 
          renderDays(state.selectedMonth); 
          updateProgressUI();

      } else {
          // Exibir P√°gina de Sele√ß√£o
          plano.classList.add('hidden-page');
          selecao.classList.remove('hidden-page');
          
          document.getElementById('tituloApp').innerText = ` ${texts.titulo_selecao}`;
          document.getElementById('subtituloApp').innerText = texts.subtitulo_selecao;

          renderPlanGrid();
      }
      if(window.lucide) window.lucide.createIcons();
  }

  // Fun√ß√£o para iniciar o plano (salva a data)
  function startPlanDate(planoId){
      state.planoId = planoId;
      localStorage.setItem('bib_plano', planoId);
      
      const today = new Date();
      today.setHours(0,0,0,0); // Zera hora para uniformidade
      state.startDate = today.toISOString().split('T')[0];
      localStorage.setItem('bib_startDate', state.startDate);
      
      showPage('paginaPlano');
  }

  // NOVA FUN√á√ÉO: Troca o plano e limpa o hist√≥rico
  function confirmChangePlan(){
      const texts = UI_TEXT[state.idioma];
      const isConfirmed = confirm(texts.confirm_change);
      
      if(isConfirmed){
          // 1. Limpa o hist√≥rico de leitura do plano ATUAL
          if(state.planoId){
              for(let i=1; i<=365; i++){
                  localStorage.removeItem(`${state.planoId}_day_${i}`);
              }
          }
          
          // 2. Limpa o plano e a data de in√≠cio
          state.planoId = null;
          state.startDate = null;
          localStorage.removeItem('bib_plano');
          localStorage.removeItem('bib_startDate');
          
          // 3. Volta para a p√°gina de sele√ß√£o
          showPage('paginaSelecao');
      }
  }


  // ---------- RENDER FUNCTIONS ----------
  function renderPlanGrid(){
    const container = document.getElementById('gridPlanos'); 
    if (!container) return; 
    
    container.innerHTML='';
    const texts = UI_TEXT[state.idioma];
    const planoTexts = texts.planos;
    const icons = ['calendar','clock','layers','heart','book-open','sun'];

    // Calcula o status do plano ATIVO (se houver)
    const activeStatus = state.planoId ? calculateProgressAndStatus(state.planoId) : null;

    planoTexts.forEach((p, idx)=>{
      const isSelected = state.planoId===p.id;
      
      let cardClasses = 'plan-button flex flex-col items-center p-4 rounded-xl shadow-lg transition-all duration-200 text-center cursor-pointer ';
      let iconColor = 'text-primary-500';
      let descColor = 'text-gray-500 dark:text-gray-400';
      let contentHtml = '';
      
      if (isSelected) {
          if (!state.startDate) {
              // 1. Plano SELECIONADO, mas N√ÉO INICIADO (Exibe bot√£o INICIAR)
              cardClasses += 'bg-white dark:bg-gray-800 ring-2 ring-primary-500 hover:shadow-xl';
              contentHtml = `
                <div class="mt-4 w-full">
                    <button class="bg-primary-500 text-white text-sm font-bold w-full py-2 rounded-lg hover:bg-primary-600 transition" onclick="startPlanDate('${p.id}')">
                        ${texts.btn_start}
                    </button>
                </div>
              `;
          } else {
              // 2. Plano SELECIONADO e INICIADO (Exibe status Atrasado/Em Dia)
              const isLate = activeStatus.isLate;
              const statusLabel = isLate ? texts.status_late : texts.status_ok;
              const bgColor = isLate ? 'bg-progress-late' : 'bg-primary-500';
              const ringColor = isLate ? 'ring-orange-500/50' : 'ring-primary-500/50';
              const hoverBgColor = isLate ? 'hover:bg-orange-600' : 'hover:bg-primary-600';
              const statusBgColor = isLate ? 'bg-orange-700/50' : 'bg-indigo-700/50';

              cardClasses = `plan-button flex flex-col items-center p-4 rounded-xl shadow-lg transition-all duration-200 text-center ${bgColor} text-white ring-4 ${ringColor} ${hoverBgColor} cursor-pointer`;
              iconColor = 'text-white';
              descColor = isLate ? 'text-orange-200' : 'text-indigo-200';
              
              contentHtml = `
                <div class="mt-2 text-xs font-bold text-white uppercase px-2 py-0.5 rounded-full ${statusBgColor}">
                    ${statusLabel}
                </div>
              `;
          }
      } else {
          // 3. Cards N√ÉO selecionados
          cardClasses += 'bg-white dark:bg-gray-800 hover:ring-2 hover:ring-primary-500';
          // Se o plano ATIVO j√° tem uma data de in√≠cio, os outros planos n√£o ativos devem ter um bot√£o de "selecionar" que dispara o alerta.
          if(state.planoId && state.startDate){
            // Se j√° tem um plano INICIADO, clicar em outro deve disparar o alerta
            contentHtml = `
                <div class="mt-4 w-full">
                    <button class="bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 text-sm font-bold w-full py-2 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition" 
                            onclick="confirmChangePlanAndSelect('${p.id}')">
                        SELECIONAR
                    </button>
                </div>
            `;
            // Remove a a√ß√£o padr√£o do card para for√ßar o uso do bot√£o
            cardClasses = cardClasses.replace('cursor-pointer', 'cursor-default');
          } else {
            // Se NENHUM plano foi iniciado ainda (ou planoId √© null e startDate √© null), clicar no card SELECIONA o plano
            contentHtml = `<div class="mt-4 h-8"></div>`; // Espa√ßo vazio para manter altura
            cardClasses = cardClasses.replace('cursor-default', 'cursor-pointer');
          }
      }

      const iconName = icons[idx] || 'book';
      const btn = document.createElement('button');
      btn.type='button';
      btn.className=cardClasses;
      btn.style.minHeight='120px';
      
      btn.innerHTML = `\
        <div class="mb-2"><i data-lucide="${iconName}" class="lucide w-8 h-8 ${iconColor}"></i></div>\
        <div class="text-base font-bold">${p.title}</div>\
        <div class="text-xs ${descColor} mt-1">${p.desc}</div>
        ${contentHtml}
      `;
      
      // Define a a√ß√£o principal do card (s√≥ funciona se n√£o houver um bot√£o dentro)
      if (isSelected) {
          btn.onclick = () => {
              // Se j√° est√° selecionado e iniciado, vai para a p√°gina do plano
              if(state.startDate) showPage('paginaPlano');
              // Se est√° selecionado mas n√£o iniciado, nada acontece (o bot√£o INICIAR est√° dentro do HTML)
          };
      } else {
          // Se n√£o est√° selecionado
          if(!state.planoId || !state.startDate){
              // Se n√£o h√° plano ATIVO, clica no card para SELECIONAR (sem iniciar)
              btn.onclick = ()=>{
                state.planoId = p.id; 
                localStorage.setItem('bib_plano', p.id);
                // Permanece na p√°gina de sele√ß√£o, agora com o card selecionado
                renderPlanGrid(); 
              };
          } else {
              // Se j√° tem plano ATIVO, a a√ß√£o √© apenas no bot√£o dentro do card (que chama confirmChangePlanAndSelect)
              btn.onclick = null; 
          }
      }

      container.appendChild(btn);
    });
    if(window.lucide) window.lucide.createIcons();
  }
  
  // Fun√ß√£o auxiliar para chamar o confirmChangePlan e selecionar o novo plano se confirmado
  window.confirmChangePlanAndSelect = (newPlanoId) => {
      const texts = UI_TEXT[state.idioma];
      const isConfirmed = confirm(texts.confirm_change);
      
      if(isConfirmed){
          // 1. Limpa o hist√≥rico de leitura do plano ATUAL
          if(state.planoId){
              for(let i=1; i<=365; i++){
                  localStorage.removeItem(`${state.planoId}_day_${i}`);
              }
          }
          
          // 2. Limpa apenas a data de in√≠cio do localStorage e do state (mant√©m o planoId do *pr√≥ximo* plano)
          state.startDate = null;
          localStorage.removeItem('bib_startDate');
          
          // 3. Define o novo plano e re-renderiza o grid (mostra o bot√£o INICIAR no novo plano)
          state.planoId = newPlanoId;
          localStorage.setItem('bib_plano', newPlanoId);
          renderPlanGrid();
          // NOTA: O usu√°rio ter√° que clicar no bot√£o INICIAR no card rec√©m-selecionado para come√ßar a contagem.
      }
  };


  function renderMonths(){
    const div = document.getElementById('meses'); 
    if (!div) return;
    
    div.innerHTML='';
    const months = MONTHS[state.idioma];
    months.forEach((m,i)=>{
      const isSelected = state.selectedMonth === i+1;
      const btn = document.createElement('button');
      btn.className = 'flex-shrink-0 px-4 py-2 rounded-full font-semibold transition ' + 
                      (isSelected ? 'bg-primary-500 text-white shadow-md' : 'bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600');
      btn.innerText = m;
      btn.onclick = ()=>{ state.selectedMonth = i+1; renderMonths(); renderDays(i+1); };
      div.appendChild(btn);
    });
    
    const currentMonthButton = document.querySelector(`#meses button:nth-child(${state.selectedMonth})`);
    if(currentMonthButton){
        currentMonthButton.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
  }

  function renderDays(month){
    const container = document.getElementById('dias'); 
    if (!container || !state.planoId) return;

    container.innerHTML='';
    const daysInMonth = DAYS_PER_MONTH[month-1];
    const startDayOfYear = monthDayToDayOfYear(month,1);
    const plan = getPlan(state.planoId, state.idioma);
    
    // Calcula o dia do ano de hoje para destaque
    const today = new Date();
    const todayMonth = today.getMonth() + 1;
    const todayDayOfMonth = today.getDate();
    
    for(let d=1; d<=daysInMonth; d++){
      const dayOfYear = startDayOfYear + d -1; const idx = dayOfYear -1; const refs = plan[idx] || [];
      const key = `${state.planoId}_day_${dayOfYear}`; const lido = localStorage.getItem(key);
      const card = document.createElement('div');
      
      // Verifica se o dia √© hoje
      const isToday = (month === todayMonth && d === todayDayOfMonth);
      
      let cardClasses = 'p-4 rounded-xl shadow-md border-t-2 cursor-pointer transition';
      
      if (isToday) {
          // Aplica o destaque se for o dia de hoje
          cardClasses += ' today-highlight'; 
      } else {
          // Classes normais para dias passados/futuros
          cardClasses += (lido ? ' border-primary-500 opacity-90' : ' border-gray-200 dark:border-gray-700 hover:shadow-lg hover:ring-1 hover:ring-primary-500') +
                         ' bg-white dark:bg-gray-800';
      }

      card.className = cardClasses;
      
      const preview = refs.slice(0,2).join(', ');
      const iconName = lido ? 'check-circle' : 'chevrons-right';
      const iconColor = lido ? 'text-primary-500' : (isToday ? 'text-primary-500' : 'text-gray-400 dark:text-gray-500');

      card.innerHTML = `\
        <div class="flex justify-between items-start">\
          <div>\
            <h3 class="text-xl font-extrabold ${isToday ? 'text-primary-600 dark:text-primary-400' : 'text-primary-500'}">${d}</h3>\
            <p class="text-xs ${isToday ? 'text-primary-400 dark:text-primary-300' : 'text-gray-500 dark:text-gray-400'} font-medium mt-0.5">${formatDateSmall(month,d)}</p>\
          </div>\
          <div class="${iconColor} flex-shrink-0"><i data-lucide="${iconName}" class="lucide w-6 h-6"></i></div>\
        </div>\
        <p class="mt-3 text-sm font-medium ${isToday ? 'text-gray-800 dark:text-gray-100' : 'text-gray-700 dark:text-gray-200'}">${preview}${refs.length>2? ' ...' : ''}</p>`;
      card.onclick = ()=> abrirModalForDay(dayOfYear);
      container.appendChild(card);
    }
    if(window.lucide) window.lucide.createIcons(); 
    updateProgressUI();
  }

  function formatDateSmall(month, day){ const months = MONTHS[state.idioma]; return `${months[month-1]} ${day}`; }

  let modalCurrentDay = null;
  const modalDiv = document.getElementById('modal');
  const modalContent = document.getElementById('modalContent');

  function abrirModalForDay(dayOfYear){
    if (!state.planoId) return;
    modalCurrentDay = dayOfYear;
    const plan = getPlan(state.planoId, state.idioma);
    const refs = plan[dayOfYear-1] || [];
    document.getElementById('modalTitulo').innerText = `${UI_TEXT[state.idioma].start} ‚Ä¢ ${UI_TEXT[state.idioma].dia_leitura} ${dayOfYear}`;
    const ul = document.getElementById('modalLeituras'); ul.innerHTML = '';
    
    refs.forEach(r=>{
      const li = document.createElement('li'); li.className='text-base flex items-center p-2 rounded-lg bg-gray-50 dark:bg-gray-700';
      const icon = document.createElement('i'); icon.setAttribute('data-lucide', 'book-open'); icon.className='lucide w-4 h-4 mr-3 text-primary-500 flex-shrink-0';
      const span = document.createElement('span'); span.innerText = r;
      li.appendChild(icon);
      li.appendChild(span);
      ul.appendChild(li);
    });
    
    document.getElementById('btnLido').innerText = UI_TEXT[state.idioma].marcar;
    document.getElementById('btnLerAgora').innerText = `üìñ ${UI_TEXT[state.idioma].ler_agora}`;
    
    modalDiv.classList.remove('hidden');
    setTimeout(()=>{
      modalDiv.style.opacity = '1';
      modalContent.classList.remove('scale-95');
    }, 10); 

    if(window.lucide) window.lucide.createIcons();
  }

  function fecharModal(){
    modalDiv.style.opacity = '0';
    modalContent.classList.add('scale-95');
    setTimeout(()=> modalDiv.classList.add('hidden'), 300); 
  }

  document.getElementById('fecharModal').addEventListener('click', fecharModal);
  
  document.getElementById('btnLido').addEventListener('click', ()=>{
    if(!modalCurrentDay || !state.planoId) return; 
    const key = `${state.planoId}_day_${modalCurrentDay}`; 
    localStorage.setItem(key,'1'); 
    fecharModal(); 
    renderDays(state.selectedMonth); 
    renderPlanGrid(); // Atualiza o grid para refletir o status de progresso/atraso
    updateProgressUI();
  });

  document.getElementById('btnLerAgora').addEventListener('click', ()=>{
    if(!modalCurrentDay || !state.planoId) return; 
    const plan = getPlan(state.planoId, state.idioma); 
    const refs = plan[modalCurrentDay-1] || [];
    if(refs.length===0) return;
    const joinForSearch = refs.map(r=> r.replace(/\s+/g,' ')).join(',');
    const version = state.idioma==='pt' ? 'NVI-PT' : state.idioma==='en' ? 'NIV' : 'NIV';
    const url = `https://www.biblegateway.com/passage/?search=${encodeURIComponent(joinForSearch)}&version=${version}`;
    window.open(url, '_blank');
  });
  
  document.getElementById('modal').addEventListener('click',(e)=>{ if(e.target.id==='modal') fecharModal(); });

  function updateProgressUI(){
    if (!state.planoId) return;
    
    const { read, total, isLate } = calculateProgressAndStatus(state.planoId);
      
    const progressoBar = document.getElementById('progressoBar');
    const textoProgresso = document.getElementById('textoProgresso');
    const textoPlanoAtual = document.getElementById('textoPlanoAtual');

    const pct = Math.round((read/total)*100);
    
    // Atualiza a barra de progresso e cor
    if (progressoBar) {
        progressoBar.style.width = pct + '%';
        if (isLate) {
            progressoBar.classList.remove('bg-progress-ok');
            progressoBar.classList.add('bg-progress-late');
        } else {
            progressoBar.classList.remove('bg-progress-late');
            progressoBar.classList.add('bg-progress-ok');
        }
    }
    
    if (textoProgresso) {
        // Exibe o status de atraso/em dia no texto de progresso
        const statusText = isLate ? ` (${UI_TEXT[state.idioma].status_late})` : ` (${UI_TEXT[state.idioma].status_ok})`;
        textoProgresso.innerText = `${UI_TEXT[state.idioma].progresso}: ${read} / ${total}${state.startDate ? statusText : ''}`;
        
        // Aplica cor ao texto de progresso se houver data de in√≠cio
        if (state.startDate) {
            if (isLate) {
                textoProgresso.classList.remove('text-primary-500', 'dark:text-gray-100');
                textoProgresso.classList.add('text-progress-late', 'dark:text-orange-400');
            } else {
                textoProgresso.classList.remove('text-progress-late', 'dark:text-orange-400');
                textoProgresso.classList.add('text-primary-500', 'dark:text-gray-100');
            }
        } else {
            // Se n√£o come√ßou, remove classes de status
            textoProgresso.classList.remove('text-progress-late', 'dark:text-orange-400', 'text-primary-500');
            textoProgresso.classList.add('text-gray-900', 'dark:text-gray-100');
        }
    }

    const planoEncontrado = UI_TEXT[state.idioma].planos.find(p=>p.id===state.planoId);
    const planName = planoEncontrado ? planoEncontrado.title : '---';
    
    // Atualiza o link de trocar plano
    if (textoPlanoAtual) textoPlanoAtual.innerText = `${UI_TEXT[state.idioma].plano}: ${planName}`;
    const trocarPlanoLink = document.getElementById('trocarPlanoLink');
    if (trocarPlanoLink) trocarPlanoLink.querySelector('span').innerText = `${UI_TEXT[state.idioma].plano}: ${planName} ‚Ä¢ ${UI_TEXT[state.idioma].link_trocar}`;
  }

  // EVENTO DO LINK "TROCAR PLANO"
  document.addEventListener('click', (e) => {
      if (e.target && e.target.id === 'trocarPlanoLink' || e.target.closest('#trocarPlanoLink')) {
          e.preventDefault();
          confirmChangePlan();
      }
  });


  // ---------- IDIOMA DROPDOWN LOGIC (MANTIDA) ----------
  const idiomaToggle = document.getElementById('idiomaToggle');
  const idiomaMenu = document.getElementById('idiomaMenu');
  const currentFlag = document.getElementById('currentFlag');
  const idiomaItems = document.querySelectorAll('.idioma-item');

  function updateIdiomaDisplay(lang){
    const texts = UI_TEXT[lang];
    const flagCode = texts.flag_code;

    // Atualiza o bot√£o principal APENAS com a bandeira
    currentFlag.className = `flag-icon flag-icon-${flagCode}`;
    
    // Altera o estado de 'selecionado' no menu
    idiomaItems.forEach(item => {
        if(item.getAttribute('data-lang') === lang) {
            item.classList.add('bg-gray-200', 'dark:bg-gray-600');
        } else {
            item.classList.remove('bg-gray-200', 'dark:bg-gray-600');
        }
    });

    updateUITexts(lang);
  }
  
  function toggleIdiomaMenu(){
      const isHidden = idiomaMenu.classList.contains('hidden');
      if (isHidden) {
          idiomaMenu.classList.remove('hidden');
          setTimeout(() => {
              idiomaMenu.classList.remove('scale-95', 'opacity-0');
          }, 10);
      } else {
          idiomaMenu.classList.add('scale-95', 'opacity-0');
          setTimeout(() => {
              idiomaMenu.classList.add('hidden');
          }, 150);
      }
  }

  idiomaToggle.addEventListener('click', toggleIdiomaMenu);
  document.addEventListener('click', (e) => {
      const idiomaDropdown = document.getElementById('idiomaDropdown');
      const isClickInside = idiomaDropdown.contains(e.target);
      if (!isClickInside && !idiomaMenu.classList.contains('hidden')) {
          toggleIdiomaMenu();
      }
  });


  idiomaItems.forEach(item => {
      item.addEventListener('click', (e) => {
          const newLang = item.getAttribute('data-lang');
          if (newLang !== state.idioma) {
              state.idioma = newLang; 
              localStorage.setItem('bib_idioma', state.idioma);
              updateIdiomaDisplay(state.idioma);
          }
          toggleIdiomaMenu();
      });
  });

  // Fun√ß√£o centralizada de atualiza√ß√£o de texto E TRADU√á√ÉO DO BOT√ÉO HOJE
  function updateUITexts(lang){
    // Redireciona para a p√°gina correta ap√≥s a mudan√ßa de idioma
    showPage(state.planoId ? 'paginaPlano' : 'paginaSelecao');

    // ATUALIZA√á√ÉO DO BOT√ÉO HOJE
    const btnHojeText = document.getElementById('btnHojeText');
    if (btnHojeText) {
        btnHojeText.innerText = UI_TEXT[lang].hoje;
    }
  }

  // NOVA FUN√á√ÉO: Navega para o m√™s atual e destaca o dia atual
  function goToToday() {
      if (!state.planoId) { return; }

      const today = new Date();
      const currentMonth = today.getMonth() + 1;
      
      if (state.selectedMonth !== currentMonth) {
          state.selectedMonth = currentMonth;
      }
      
      renderMonths();
      renderDays(state.selectedMonth);
      
      const mesesContainer = document.getElementById('meses');
      const currentMonthButton = document.querySelector(`#meses button:nth-child(${state.selectedMonth})`);
      if (mesesContainer && currentMonthButton) {
          currentMonthButton.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      }
  }


  // ---------- INITIALIZE APP ----------
  function init(){
    const today = new Date(); 
    state.planoId = localStorage.getItem('bib_plano');
    state.startDate = localStorage.getItem('bib_startDate'); // Carrega a data de in√≠cio
    state.selectedMonth = state.selectedMonth || (today.getMonth()+1);
    
    // 1. Inicializa o display do idioma, o que chama updateUITexts
    updateIdiomaDisplay(state.idioma);
    
    // 2. Adiciona o listener para o novo bot√£o Hoje
    const btnHoje = document.getElementById('btnHoje');
    if (btnHoje) {
        btnHoje.addEventListener('click', goToToday);
    }

    // CORRE√á√ÉO: Chama showPage para garantir a renderiza√ß√£o inicial
    showPage(state.planoId && state.startDate ? 'paginaPlano' : 'paginaSelecao');
  }
  
  // Executa a inicializa√ß√£o ap√≥s o DOM carregar
  document.addEventListener('DOMContentLoaded', () => {
      // --- L√≥gica do Tema (Original) ---
      const btnTema = document.getElementById('btnTema');
      const themeStatusText = document.getElementById('themeStatusText'); 
      const root = document.documentElement;
  
      function applyTheme(isDark) {
          root.classList.toggle('dark', !!isDark);
          if (isDark) {
              localStorage.setItem('bib_theme', 'dark');
              if (themeStatusText) themeStatusText.innerText = 'üåû'; 
          } else {
              localStorage.removeItem('bib_theme');
              if (themeStatusText) themeStatusText.innerText = 'üåô';
          }
      }
  
      function toggleTheme() {
          const nowDark = root.classList.contains('dark');
          applyTheme(!nowDark);
      }
  
      // 1. Inicializa o tema na carga
      const storedDark = localStorage.getItem('bib_theme') === 'dark';
      applyTheme(storedDark);
      
      // 2. Adiciona listener ao bot√£o de tema
      if(btnTema) btnTema.addEventListener('click', toggleTheme);

      // --- Inicializa√ß√£o Principal ---
      init();
  });
  </script>

</body>
</html>