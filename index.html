<!DOCTYPE html>
<html lang="pt" class="">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Plano de Leitura B√≠blica</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <script src="https://cdn.tailwindcss.com"></script>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/lipis/flag-icon-css@1.0/css/flag-icon.min.css"/>
  
  <script type="module" src="https://unpkg.com/lucide@0.259.0/dist/lucide.esm.js"></script>
  <script nomodule src="https://unpkg.com/lucide@0.259.0/dist/lucide.js"></script>

  <script>
    tailwind.config = {
      darkMode: 'class', // Ativa o modo escuro baseado na classe 'dark'
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', 'sans-serif'],
          },
          colors: {
            // Usamos Indigo como primary para consist√™ncia
            'primary': {
              500: '#4f46e5', // Indigo padr√£o
              600: '#4338ca', // Indigo mais escuro para hover
            }
          }
        }
      }
    }
  </script>

  <style>
    /* pequeno polimento */
    .plan-button:active, #idiomaToggle:active, #btnTema:active, #btnOpenSettings:active { transform: scale(.995); }
    /* transi√ß√£o suave para a barra de progresso */
    #progressoBar { transition: width 350ms ease; }
    
    /* NOVO: Estilo para o destaque ao clicar no bot√£o "Hoje" (Contorno) */
    #btnHoje:active { 
        transform: scale(.995); 
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.5); /* Contorno suave */
    }

    /* NOVO: Destaque visual para o dia 'esperado' (Em Dia) */
    .today-highlight {
        border: 4px solid #4f46e5 !important; /* Cor prim√°ria */
        background-color: #eef2ff !important; /* Indigo-50 claro */
        transform: scale(1.01);
        box-shadow: 0 4px 12px rgba(79, 70, 229, 0.2);
    }
    .dark .today-highlight {
        --tw-bg-opacity: 1; 
        background-color: rgb(30 41 59 / var(--tw-bg-opacity)) !important; /* slate-800 */
        border-color: #6366f1 !important; /* Indigo-500 light */
    }
    
    /* Destaque visual para o dia marcado como lido (Fundo cinza, solicitado) */
    .read-highlight {
        background-color: #f3f4f6 !important; /* gray-100 */
    }
    .dark .read-highlight {
        background-color: rgb(30 41 59 / var(--tw-bg-opacity)) !important; /* slate-800 */
    }

    /* NOVO: Estilo para a lista de leituras do modal (Ajuste para planos curtos) */
    .modal-scroll-area {
        max-height: 50vh; /* Limita a altura m√°xima (50% da altura da viewport) */
        overflow-y: auto; /* Adiciona barra de rolagem vertical se o conte√∫do exceder */
        padding-right: 1rem; /* Adiciona um pequeno padding para evitar que o conte√∫do toque na barra de rolagem */
    }
    
    /* Ajuste para o scroll suave no modal de configura√ß√µes */
    #settingsModalContent, #glossaryModalContent { max-height: 90vh; overflow-y: auto; }

  </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-screen flex flex-col font-sans">

  <header class="p-4 sm:p-6 bg-white dark:bg-gray-800 shadow-sm border-b border-gray-100 dark:border-gray-700">
    <div class="max-w-7xl mx-auto flex items-center justify-between gap-4">
      <div class="flex items-center gap-3">
        <div class="rounded-xl bg-primary-500 text-white w-10 h-10 flex items-center justify-center text-xl font-extrabold shadow-md">B</div>
        <div>
          <h1 id="tituloApp" class="text-xl font-bold">üìÖ Plano de Leitura B√≠blica</h1>
          <p id="subtituloApp" class="text-sm text-gray-600 dark:text-gray-400">Escolha um plano e comece hoje</p>
        </div>
      </div>

      <div class="flex items-center gap-2">
        <div id="idiomaDropdown" class="relative">
            <button id="idiomaToggle" class="px-3 py-2 rounded-xl bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 transition font-medium flex items-center justify-center gap-1" aria-label="Alterar idioma">
                <span id="currentFlag" class="flag-icon"></span>
            </button>

            <div id="idiomaMenu" class="absolute right-0 mt-2 w-20 bg-white dark:bg-gray-700 rounded-xl shadow-2xl py-1 z-10 hidden ring-1 ring-black ring-opacity-5 origin-top-right transition-all duration-150 transform scale-95 opacity-0">
                <button class="idioma-item w-full text-center px-4 py-2 text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-600 flex items-center justify-center" data-lang="pt">
                    <span class="flag-icon flag-icon-br"></span>
                </button>
                <button class="idioma-item w-full text-center px-4 py-2 text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-600 flex items-center justify-center" data-lang="en">
                    <span class="flag-icon flag-icon-us"></span>
                </button>
                <button class="idioma-item w-full text-center px-4 py-2 text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-600 flex items-center justify-center" data-lang="es">
                    <span class="flag-icon flag-icon-es"></span>
                </button>
            </div>
        </div>
        
        <button id="btnHoje" class="p-2 px-3 rounded-xl bg-gray-200 dark:bg-gray-700 hover:scale-105 transition flex items-center justify-center font-semibold text-sm" aria-label="Voltar para o dia de hoje">
          üìÖ <span id="btnHojeText" class="ml-1 hidden sm:inline">HOJE</span>
        </button>

        <button id="btnOpenSettings" class="p-2 rounded-xl bg-gray-200 dark:bg-gray-700 hover:scale-105 transition flex items-center justify-center font-semibold text-sm" aria-label="Abrir Configura√ß√µes">
            ‚öôÔ∏è
        </button>

        <button id="btnTema" class="p-2 px-3 rounded-xl bg-gray-200 dark:bg-gray-700 hover:scale-105 transition flex items-center justify-center font-semibold text-sm" aria-label="Alternar tema">
          <span id="themeStatusText">üåô</span> </button>
      </div>
    </div>
  </header>
  
  <main class="p-4 sm:p-6 flex-1 overflow-auto">
    
    <div class="max-w-7xl mx-auto flex gap-4 text-sm font-medium border-b border-gray-200 dark:border-gray-700 pb-4 mb-4 px-1">
        <a id="linkPrivacidade" href="#" class="text-gray-600 dark:text-gray-400 hover:text-primary-500 transition">Privacidade (LGPD)</a>
        <button id="btnAbrirGlossario" class="text-gray-600 dark:text-gray-400 hover:text-primary-500 transition">Gloss√°rio / Ajuda</button>
    </div>
    
    <section id="paginaSelecao" class="pagina max-w-7xl mx-auto w-full">
      <div id="gridPlanos" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mx-auto mt-4">
        </div>
    </section>

    <section id="paginaPlano" class="pagina max-w-7xl mx-auto w-full hidden-page">
      
      <div class="px-1 mt-0">
        <div class="flex items-center justify-between mb-2">
          <div class="text-base font-semibold" id="textoProgresso">Progresso: 0 / 365</div>
          
          <div id="planInfoDisplay" class="text-sm font-medium flex flex-col items-end p-1">
            <span id="textoPlanoAtual" class="text-gray-800 dark:text-gray-100 flex items-center">Plano: Tradicional</span>
            <span id="textoDataInicio" class="text-xs text-gray-500 dark:text-gray-400 font-medium mt-0.5"></span>
          </div>

        </div>
        <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-3.5 overflow-hidden">
          <div id="progressoBar" class="bg-primary-500 h-3.5 rounded-full" style="width:0%"></div>
        </div>
      </div>
      
      <div class="mt-8">
        <h2 class="text-xl font-bold mb-4 px-1">Selecione o M√™s</h2>
        <div id="meses" class="flex gap-2 overflow-x-auto pb-3 px-1 border-b border-gray-200 dark:border-gray-700"></div>
      </div>

      <div id="dias" class="mt-6 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 xl:grid-cols-7 gap-4 px-1">
        </div>
    </section>

  </main>
  
  <div id="modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50 p-4 transition-opacity duration-300" style="opacity:0;" aria-modal="true" role="dialog">
    <div id="modalContent" class="bg-white dark:bg-gray-800 p-6 rounded-3xl w-full max-w-md shadow-2xl scale-95 transition-transform duration-300">
      <div class="flex justify-between items-start">
        <h3 id="modalTitulo" class="text-2xl font-extrabold text-primary-500"></h3>
        <button id="fecharModal" class="p-1 rounded-full text-gray-500 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition">
          <i data-lucide="x" class="lucide w-6 h-6"></i>
        </button>
      </div>

      <ul id="modalLeituras" class="modal-scroll-area mt-4 space-y-2 text-gray-700 dark:text-gray-200 border-t pt-4 border-gray-200 dark:border-gray-700"></ul>

      <div class="mt-6 flex gap-3">
        <button id="btnLido" class="flex-1 px-4 py-3 rounded-xl bg-primary-500 text-white font-semibold hover:bg-primary-600 transition shadow-lg shadow-primary-500/30">‚úî Marcar como lido</button>
        <button id="btnLerAgora" class="px-4 py-3 rounded-xl bg-blue-600 text-white font-semibold hover:bg-blue-700 transition shadow-lg shadow-blue-600/30">üìñ Ler agora</button>
      </div>
    </div>
  </div>

  <div id="settingsModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50 p-4 transition-opacity duration-300" style="opacity:0;" aria-modal="true" role="dialog">
    <div id="settingsModalContent" class="bg-white dark:bg-gray-800 p-6 rounded-3xl w-full max-w-md shadow-2xl scale-95 transition-transform duration-300">
        <div class="flex justify-between items-start mb-4">
            <h3 class="text-2xl font-extrabold text-primary-500" id="settingsModalTitle">Configura√ß√µes</h3>
            <button id="fecharSettingsModal" class="p-1 rounded-full text-gray-500 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition">
                <i data-lucide="x" class="lucide w-6 h-6"></i>
            </button>
        </div>
        
        <div class="space-y-6">
            <div>
                <label for="planDurationSelect" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Dura√ß√£o do Plano:</label>
                <select id="planDurationSelect" class="mt-1 block w-full pl-3 pr-10 py-3 text-base border-gray-300 focus:outline-none focus:ring-primary-500 focus:border-primary-500 sm:text-sm rounded-xl bg-gray-100 dark:bg-gray-700 dark:border-gray-600">
                    </select>
                <p id="durationWarning" class="mt-2 text-xs text-gray-500 dark:text-gray-400">Alterar a dura√ß√£o do plano for√ßar√° o rec√°lculo e o progresso pode ser perdido.</p>
            </div>

            <div class="flex flex-col sm:flex-row gap-3">
                <button id="btnTrocarPlano" class="flex-1 px-4 py-3 rounded-xl bg-primary-500 text-white font-semibold hover:bg-primary-600 transition shadow-lg shadow-primary-500/30">
                    Trocar Plano
                </button>
                <button id="btnResetarProgresso" class="flex-1 px-4 py-3 rounded-xl bg-red-500 text-white font-semibold hover:bg-red-600 transition shadow-lg shadow-red-500/30">
                    Resetar Progresso
                </button>
            </div>

            <div class="pt-4 border-t border-gray-200 dark:border-gray-700">
                <h4 class="text-base font-bold mb-3" id="backupRestoreTitle">Backup e Restaura√ß√£o</h4>
                <div class="flex flex-col sm:flex-row gap-3">
                    <button id="btnExport" class="flex-1 px-4 py-3 rounded-xl bg-gray-600 text-white font-semibold hover:bg-gray-700 transition">
                        Exportar Progresso (JSON)
                    </button>
                    <button id="btnImport" class="flex-1 px-4 py-3 rounded-xl bg-gray-600 text-white font-semibold hover:bg-gray-700 transition">
                        Importar Progresso
                    </button>
                </div>
            </div>
        </div>
    </div>
  </div>
  
<div id="confirmChangePlanModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50 p-4 transition-opacity duration-300" style="opacity:0;" aria-modal="true" role="dialog">
  <div id="confirmChangePlanContent" class="bg-white dark:bg-gray-800 p-6 rounded-3xl w-full max-w-sm shadow-2xl scale-95 transition-transform duration-300">
    <div class="text-center">
      <i data-lucide="alert-triangle" class="lucide w-10 h-10 text-red-500 mx-auto mb-4"></i>
      <h3 id="confirmTitle" class="text-xl font-extrabold text-gray-900 dark:text-gray-100 mb-2">Aten√ß√£o!</h3>
      <p id="confirmMessage" class="text-gray-600 dark:text-gray-400 mb-6">Trocar de plano ir√° **apagar todo o seu progresso atual** (dias marcados e data de in√≠cio). Deseja continuar?</p>
      
      <div class="flex gap-3">
        <button id="btnCancelChangePlan" class="flex-1 px-4 py-3 rounded-xl bg-gray-300 dark:bg-gray-700 text-gray-700 dark:text-gray-300 font-semibold hover:bg-gray-400 dark:hover:bg-gray-600 transition">
          Cancelar
        </button>
        <button id="btnConfirmChangePlan" class="flex-1 px-4 py-3 rounded-xl bg-red-500 text-white font-semibold hover:bg-red-600 transition shadow-lg shadow-red-500/30">
          Sim, Apagar Hist√≥rico
        </button>
      </div>
    </div>
  </div>
</div>

<div id="glossaryModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50 p-4 transition-opacity duration-300" style="opacity:0;" aria-modal="true" role="dialog">
    <div id="glossaryModalContent" class="bg-white dark:bg-gray-800 p-6 rounded-3xl w-full max-w-lg shadow-2xl scale-95 transition-transform duration-300 max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-start mb-4">
            <h3 class="text-2xl font-extrabold text-primary-500" id="glossaryModalTitle">Gloss√°rio / Ajuda</h3>
            <button id="fecharGlossaryModal" class="p-1 rounded-full text-gray-500 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition">
                <i data-lucide="x" class="lucide w-6 h-6"></i>
            </button>
        </div>
        
        <div class="space-y-4 text-gray-700 dark:text-gray-300">
            <h4 class="text-lg font-bold text-primary-500">Funcionalidades Principais</h4>
            <ul class="space-y-3">
                <li class="flex items-start">
                    <span class="mr-3 mt-1 flex-shrink-0"><i data-lucide="calendar" class="lucide w-5 h-5 text-primary-500"></i></span>
                    <p><strong>Plano Ativo (C√≠rculo Azul)</strong>: Indica o plano de leitura que est√° em uso no momento.</p>
                </li>
                <li class="flex items-start">
                    <span class="mr-3 mt-1 flex-shrink-0">üìÖ</span>
                    <p><strong>Bot√£o HOJE</strong>: Redireciona rapidamente a visualiza√ß√£o para o m√™s e dia da leitura que deveria ser feita hoje.</p>
                </li>
                <li class="flex items-start">
                    <span class="mr-3 mt-1 flex-shrink-0">‚öôÔ∏è</span>
                    <p><strong>Configura√ß√µes</strong>: Permite alterar a dura√ß√£o do plano (1 ano, 6 meses, 3 meses), resetar o progresso ou trocar de plano.</p>
                </li>
                <li class="flex items-start">
                    <span class="mr-3 mt-1 flex-shrink-0">üìñ</span>
                    <p><strong>Bot√£o "Ler agora"</strong>: Abre os vers√≠culos de leitura em uma nova aba no Bible Gateway, na vers√£o (NVI-PT/NIV) correspondente ao idioma da aplica√ß√£o.</p>
                </li>
            </ul>
            
            <h4 class="text-lg font-bold text-primary-500 pt-4 border-t border-gray-200 dark:border-gray-700">√çcones nos Dias de Leitura</h4>
            <ul class="space-y-3">
                <li class="flex items-start">
                    <span class="mr-3 mt-1 flex-shrink-0"><i data-lucide="check-circle" class="lucide w-5 h-5 text-red-500"></i></span>
                    <p><strong>Dia Conclu√≠do</strong>: O dia foi marcado como lido (fundo cinza claro e √≠cone vermelho).</p>
                </li>
                <li class="flex items-start">
                    <span class="mr-3 mt-1 flex-shrink-0"><i data-lucide="chevrons-right" class="lucide w-5 h-5 text-gray-400"></i></span>
                    <p><strong>Dia N√£o Lido (Pendente)</strong>: Leitura ainda n√£o marcada como lida.</p>
                </li>
                <li class="flex items-start">
                    <span class="mr-3 mt-1 flex-shrink-0"><i data-lucide="star" class="lucide w-5 h-5 text-primary-500 fill-primary-500/50"></i></span>
                    <p><strong>Dia Atual/Em Dia (Borda Azul Grossa)</strong>: Marca o dia de leitura esperado (o dia que voc√™ est√° hoje no plano).</p>
                </li>
                <li class="flex items-start">
                    <span class="mr-3 mt-1 flex-shrink-0">üìä</span>
                    <p><strong>Status de Acompanhamento</strong>: Textos como "Atrasado (X dias)" ou "Adiantado (Y dias)" aparecem se houver uma data de in√≠cio definida, indicando sua posi√ß√£o em rela√ß√£o ao progresso esperado.</p>
                </li>
            </ul>
        </div>
    </div>
</div>

  <footer class="mt-12 py-6 border-t border-gray-200 dark:border-gray-700 text-center text-sm text-gray-600 dark:text-gray-400">
    <p class="italic">¬© 2025 Alex Silva. Uso livre com atribui√ß√£o.</p>
  </footer>

  <script>
  
  // ---------- CONFIG / TEXTS ----------
  // NOVO: DURA√á√ïES V√ÅLIDAS EM DIAS (REMOVIDO '30')
  const DURATIONS = [365, 180, 90]; 
  
  const UI_TEXT = {
    pt: {
      titulo: 'Plano B√≠blico',
      subtitulo: 'Acompanhe seu progresso',
      titulo_selecao: 'Plano B√≠blico',
      subtitulo_selecao: 'Selecione seu plano.',
      link_trocar: 'Trocar Plano',
      ler_agora: 'Ler agora',
      planos: [
        { id: 'tradicional', title: 'Tradicional', desc: 'G√™nesis ‚Üí Apocalipse (padr√£o)' },
        { id: 'cronologico', title: 'Cronol√≥gico', desc: 'Ordem hist√≥rica aproximada' },
        { id: 'atnt', title: 'AT + NT', desc: 'Um trecho do AT e um do NT por dia' },
        { id: 'jesus', title: 'Um Ano com Jesus', desc: 'Evangelhos ‚Üí Atos ‚Üí Cartas ‚Üí Resto' },
        { id: 'umcap', title: '1 Cap√≠tulo/Dia', desc: '1 cap√≠tulo por dia (365 sele√ß√µes)' },
        { id: 'salmos', title: 'AT+NT+Salmos', desc: 'AT + NT + Salmo/Prov√©rbio di√°rio' }
      ],
      start: 'Dia de Leitura',
      marcar: '‚úî Marcar como lido',
      fechar: 'Fechar',
      progresso: 'Progresso',
      plano: 'Plano',
      dia_leitura: 'Dia',
      lang_name: 'Portugu√™s',
      flag_code: 'br',
      hoje: 'HOJE',
      lido: 'Leitura Conclu√≠da',
      nao_lido: 'Marcar como lido',
      
      // TRADU√á√ÉO: Textos para Atraso/Adiantamento
      delayed: 'Atrasado',
      ahead: 'Adiantado',
      days_behind: ' dias',
      days_ahead: ' dias',
      
      // NOVO: Textos para Configura√ß√µes
      settings: 'Configura√ß√µes',
      duration_label: 'Dura√ß√£o do Plano:',
      duration_options: { 365: '1 Ano (365 Dias)', 180: '6 Meses (180 Dias)', 90: '3 Meses (90 Dias)' },
      reset_progress: 'Resetar Progresso',
      backup_restore: 'Backup e Restaura√ß√£o',
      export_progress: 'Exportar Progresso (JSON)',
      import_progress: 'Importar Progresso',
      alert_reset: 'Tem certeza de que deseja resetar todo o seu progresso no plano atual?',
      alert_import_success: 'Progresso importado com sucesso! Recarregando...',
      alert_import_error: 'Erro ao importar. O arquivo pode estar corrompido ou em formato inv√°lido.',
      alert_duration_change: 'Aten√ß√£o: Alterar a dura√ß√£o recalcula o plano. O progresso marcado APENAS para os dias existentes no NOVO plano ser√° mantido.',
      start_date_label: 'In√≠cio',
      // Textos para o Modal Customizado
      alert_title: 'Aten√ß√£o!', 
      alert_change_plan: 'Aten√ß√£o! Trocar de plano ir√° APAGAR todo o seu progresso atual (dias marcados e data de in√≠cio). Deseja continuar?',
      alert_change_plan_html: 'Trocar de plano ir√° **apagar todo o seu progresso atual** (dias marcados e data de in√≠cio). Deseja continuar?', 
      cancel: 'Cancelar', 
      confirm_erase: 'Sim, Apagar Hist√≥rico', 
      // NOVO: Textos para Links Adicionais
      privacy_link: 'Privacidade (LGPD)',
      glossary_link: 'Gloss√°rio / Ajuda',
    },
    en: {
        titulo: 'Bible Plan',
        subtitulo: 'Track your progress',
        titulo_selecao: 'Bible Plan',
        subtitulo_selecao: 'Select your plan.',
        link_trocar: 'Change Plan',
        ler_agora: 'Read now',
        planos: [
          { id: 'tradicional', title: 'Traditional', desc: 'Genesis ‚Üí Revelation (standard)' },
          { id: 'cronologico', title: 'Chronological', desc: 'Approx. historical order' },
          { id: 'atnt', title: 'OT + NT', desc: 'OT + NT passage per day' },
          { id: 'jesus', title: 'One Year with Jesus', desc: 'Gospels ‚Üí Acts ‚Üí Letters ‚Üí Rest' },
          { id: 'umcap', title: '1 Chapter/Day', desc: '1 chapter per day (365 picks)' },
          { id: 'salmos', title: 'OT+NT+Psalms', desc: 'OT + NT + Psalm/Proverb daily' }
        ],
        start: 'Reading Day',
        marcar: '‚úî Mark as read',
        fechar: 'Close',
        progresso: 'Progress',
        plano: 'Plan',
        dia_leitura: 'Day',
        lang_name: 'English',
        flag_code: 'us',
        hoje: 'TODAY',
        lido: 'Reading Completed',
        nao_lido: 'Mark as read',
        
        // TRADU√á√ÉO: Textos para Atraso/Adiantamento
        delayed: 'Behind',
        ahead: 'Ahead',
        days_behind: ' days',
        days_ahead: ' days',
        
        // NOVO: Textos para Configura√ß√µes
        settings: 'Settings',
        duration_label: 'Plan Duration:',
        duration_options: { 365: '1 Year (365 Days)', 180: '6 Months (180 Days)', 90: '3 Months (90 Days)' },
        reset_progress: 'Reset Progress',
        backup_restore: 'Backup & Restore',
        export_progress: 'Export Progress (JSON)',
        import_progress: 'Import Progress',
        alert_reset: 'Are you sure you want to reset all your progress for the current plan?',
        alert_import_success: 'Progress successfully imported! Reloading...',
        alert_import_error: 'Import error. The file may be corrupted or in an invalid format.',
        alert_duration_change: 'Warning: Changing the duration recalculates the plan. Progress marked ONLY for existing days in the NEW plan will be kept.',
        start_date_label: 'Start Date',
        // Textos para o Modal Customizado
        alert_title: 'Warning!',
        alert_change_plan: 'Warning! Changing plans will ERASE all your current progress (marked days and start date). Do you wish to continue?',
        alert_change_plan_html: 'Warning! Changing plans will **ERASE all your current progress** (marked days and start date). Do you wish to continue?',
        cancel: 'Cancel',
        confirm_erase: 'Yes, Erase History',
        // NOVO: Textos para Links Adicionais
        privacy_link: 'Privacy (LGPD)',
        glossary_link: 'Glossary / Help',
    },
    es: {
        titulo: 'Plan B√≠blico',
        subtitulo: 'Sigue tu progreso',
        titulo_selecao: 'Plan B√≠blico',
        subtitulo_selecao: 'Selecciona tu plan.',
        link_trocar: 'Cambiar Plan',
        ler_agora: 'Leer ahora',
        planos: [
          { id: 'tradicional', title: 'Tradicional', desc: 'G√©nesis ‚Üí Apocalipsis (est√°ndar)' },
          { id: 'cronologico', title: 'Cronol√≥gico', desc: 'Orden hist√≥rico aproximado' },
          { id: 'atnt', title: 'AT + NT', desc: 'Pasaje de AT y NT por d√≠a' },
          { id: 'jesus', title: 'Un A√±o con Jes√∫s', desc: 'Gospels ‚Üí Acts ‚Üí Letters ‚Üí Rest' },
          { id: 'umcap', title: '1 Cap√≠tulo/D√≠a', desc: '1 cap√≠tulo por d√≠a (365 selecciones)' },
          { id: 'salmos', title: 'AT+NT+Salmos', desc: 'AT + NT + Salmo/Proverbio diario' }
        ],
        start: 'D√≠a de Lectura',
        marcar: '‚úî Marcar como le√≠do',
        fechar: 'Cerrar',
        progresso: 'Progreso',
        plano: 'Plan',
        dia_leitura: 'Day',
        lang_name: 'Espa√±ol',
        flag_code: 'es',
        hoje: 'HOY',
        lido: 'Lectura Completada',
        nao_lido: 'Marcar como le√≠do',

        // TRADU√á√ÉO: Textos para Atraso/Adiantamento
        delayed: 'Atrasado',
        ahead: 'Adelantado',
        days_behind: ' d√≠as',
        days_ahead: ' d√≠as',
        
        // NOVO: Textos para Configura√ß√µes
        settings: 'Ajustes',
        duration_label: 'Duraci√≥n del Plan:',
        duration_options: { 365: '1 A√±o (365 D√≠as)', 180: '6 Meses (180 D√≠as)', 90: '3 Meses (90 D√≠as)' },
        reset_progress: 'Restablecer Progreso',
        backup_restore: 'Copia de Seguridad y Restauraci√≥n',
        export_progress: 'Exportar Progreso (JSON)',
        import_progress: 'Importar Progreso',
        alert_reset: '¬øEst√°s seguro de que deseas restablecer todo tu progreso para el plan actual?',
        alert_import_success: 'Progreso importado con √©xito. Recargando...',
        alert_import_error: 'Error al importar. El archivo puede estar corrupto o en formato no v√°lido.',
        alert_duration_change: 'Advertencia: Cambiar la duraci√≥n recalcula el plan. El progreso marcado S√ìLO para los d√≠as existentes en el NUEVO plan se mantendr√°.',
        start_date_label: 'Fecha de Inicio',
        // Textos para o Modal Customizado
        alert_title: '¬°Advertencia!',
        alert_change_plan: '¬°Advertencia! Cambiar de plan BORRAR√Å todo su progreso actual (d√≠as marcados y fecha de inicio). ¬øDesea continuar?',
        alert_change_plan_html: '¬°Advertencia! Cambiar de plan **BORRAR√Å todo su progreso actual** (d√≠as marcados y fecha de inicio). ¬øDesea continuar?',
        cancel: 'Cancelar',
        confirm_erase: 'S√≠, Borrar Historial',
        // NOVO: Textos para Links Adicionais
        privacy_link: 'Privacidad (LGPD)',
        glossary_link: 'Glosario / Ayuda',
    }
  };
  
  // (Constantes de Meses, Livros e Ordem Cronol√≥gica - MANTIDAS)
  const MONTHS = {
    pt: ["Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set","Out","Nov","Dez"],
    en: ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],
    es: ["Ene","Feb","Mar","Abr","Mai","Jun","Jul","Ago","Sep","Oct","Nov","Dic"]
  };
  const DAYS_PER_MONTH = [31,28,31,30,31,30,31,31,30,31,30,31];
  const BOOKS = [
    { key:'Genesis', ch:50, name:{pt:'G√™nesis', en:'Genesis', es:'G√©nesis'} },
    { key:'Exodus', ch:40, name:{pt:'√äxodo', en:'Exodus', es:'√âxodo'} },
    { key:'Leviticus', ch:27, name:{pt:'Lev√≠tico', en:'Leviticus', es:'Leviticus'} },
    { key:'Numbers', ch:36, name:{pt:'N√∫meros', en:'Numbers', es:'N√∫meros'} },
    { key:'Deuteronomy', ch:34, name:{pt:'Deuteron√¥mio', en:'Deuteronomy', es:'Deuteronomio'} },
    { key:'Joshua', ch:24, name:{pt:'Josu√©', en:'Joshua', es:'Josu√©'} },
    { key:'Judges', ch:21, name:{pt:'Ju√≠zes', en:'Judges', es:'Jueces'} },
    { key:'Ruth', ch:4, name:{pt:'Rute', en:'Ruth', es:'Rut'} },
    { key:'1 Samuel', ch:31, name:{pt:'1 Samuel', en:'1 Samuel', es:'1 Samuel'} },
    { key:'2 Samuel', ch:24, name:{pt:'2 Samuel', en:'2 Samuel', es:'2 Samuel'} },
    { key:'1 Kings', ch:22, name:{pt:'1 Reis', en:'1 Kings', es:'1 Reyes'} },
    { key:'2 Kings', ch:25, name:{pt:'2 Reis', en:'2 Kings', es:'2 Reyes'} },
    { key:'1 Chronicles', ch:29, name:{pt:'1 Cr√¥nicas', en:'1 Chronicles', es:'1 Cr√≥nicas'} },
    { key:'2 Chronicles', ch:36, name:{pt:'2 Cr√¥nicas', en:'2 Chronicles', es:'2 Cr√≥nicas'} },
    { key:'Ezra', ch:10, name:{pt:'Esdras', en:'Ezra', es:'Esdras'} },
    { key:'Nehemiah', ch:13, name:{pt:'Neemias', en:'Nehemiah', es:'Nehem√≠as'} },
    { key:'Esther', ch:10, name:{pt:'Ester', en:'Esther', es:'Ester'} },
    { key:'Job', ch:42, name:{pt:'J√≥', en:'Job', es:'Job'} },
    { key:'Psalms', ch:150, name:{pt:'Salmos', en:'Psalms', es:'Salmos'} },
    { key:'Proverbs', ch:31, name:{pt:'Prov√©rbios', en:'Proverbs', es:'Proverbios'} },
    { key:'Ecclesiastes', ch:12, name:{pt:'Eclesiastes', en:'Ecclesiastes', es:'Eclesiast√©s'} },
    { key:'Song of Solomon', ch:8, name:{pt:'C√¢nticos', en:'Song of Solomon', es:'Cantar de los Cantares'} },
    { key:'Isaiah', ch:66, name:{pt:'Isa√≠as', en:'Isaiah', es:'Isa√≠as'} },
    { key:'Jeremiah', ch:52, name:{pt:'Jeremias', en:'Jeremiah', es:'Jerem√≠as'} },
    { key:'Lamentations', ch:5, name:{pt:'Lamenta√ß√µes', en:'Lamentations', es:'Lamentaciones'} },
    { key:'Ezekiel', ch:48, name:{pt:'Ezequiel', en:'Ezekiel', es:'Ezequiel'} },
    { key:'Daniel', ch:12, name:{pt:'Daniel', en:'Daniel', es:'Daniel'} },
    { key:'Hosea', ch:14, name:{pt:'Os√©ias', en:'Hosea', es:'Oseas'} },
    { key:'Joel', ch:3, name:{pt:'Joel', en:'Joel', es:'Joel'} },
    { key:'Amos', ch:9, name:{pt:'Am√≥s', en:'Amos', es:'Am√≥s'} },
    { key:'Obadiah', ch:1, name:{pt:'Obadias', en:'Obadiah', es:'Abd√≠as'} },
    { key:'Jonah', ch:4, name:{pt:'Jonas', en:'Jonah', es:'Jon√°s'} },
    { key:'Micah', ch:7, name:{pt:'Miqu√©ias', en:'Micah', es:'Miqueas'} },
    { key:'Nahum', ch:3, name:{pt:'Naum', en:'Nahum', es:'Nah√∫m'} },
    { key:'Habakkuk', ch:3, name:{pt:'Habacuque', en:'Habakkuk', es:'Habacuc'} },
    { key:'Zephaniah', ch:3, name:{pt:'Sofonias', en:'Zephaniah', es:'Sofon√≠as'} },
    { key:'Haggai', ch:2, name:{pt:'Ageu', en:'Haggai', es:'Ageo'} },
    { key:'Zechariah', ch:14, name:{pt:'Zacarias', en:'Zechariah', es:'Zacar√≠as'} },
    { key:'Malachi', ch:4, name:{pt:'Malaquias', en:'Malachi', es:'Malaqu√≠as'} },
    { key:'Matthew', ch:28, name:{pt:'Mateus', en:'Matthew', es:'Mateo'} },
    { key:'Mark', ch:16, name:{pt:'Marcos', en:'Mark', es:'Marcos'} },
    { key:'Luke', ch:24, name:{pt:'Lucas', en:'Luke', es:'Lucas'} },
    { key:'John', ch:21, name:{pt:'Jo√£o', en:'John', es:'Juan'} },
    { key:'Acts', ch:28, name:{pt:'Atos', en:'Acts', es:'Hechos'} },
    { key:'Romans', ch:16, name:{pt:'Romanos', en:'Romans', es:'Romanos'} },
    { key:'1 Corinthians', ch:16, name:{pt:'1 Cor√≠ntios', en:'1 Corinthians', es:'1 Corintios'} },
    { key:'2 Corinthians', ch:13, name:{pt:'2 Cor√≠ntios', en:'2 Corinthians', es:'2 Corintios'} },
    { key:'Galatians', ch:6, name:{pt:'G√°latas', en:'Galatians', es:'G√°latas'} },
    { key:'Ephesians', ch:6, name:{pt:'Ef√©sios', en:'Ephesians', es:'Efesios'} },
    { key:'Philippians', ch:4, name:{pt:'Filipenses', en:'Philippians', es:'Filipenses'} },
    { key:'Colossians', ch:4, name:{pt:'Colossenses', en:'Colossians', es:'Colosenses'} },
    { key:'1 Thessalonians', ch:5, name:{pt:'1 Tessalonicenses', en:'1 Thessalonians', es:'1 Tesalonicenses'} },
    { key:'2 Thessalonians', ch:3, name:{pt:'2 Tessalonicenses', en:'2 Thessalonians', es:'2 Tesalonicenses'} },
    { key:'1 Timothy', ch:6, name:{pt:'1 Tim√≥teo', en:'1 Timothy', es:'1 Timoteo'} },
    { key:'2 Timothy', ch:4, name:{pt:'2 Tim√≥teo', en:'2 Timothy', es:'2 Timoteo'} },
    { key:'Titus', ch:3, name:{pt:'Tito', en:'Titus', es:'Tito'} },
    { key:'Philemon', ch:1, name:{pt:'Filemom', en:'Philemon', es:'Filem√≥n'} },
    { key:'Hebrews', ch:13, name:{pt:'Hebreus', en:'Hebrews', es:'Hebreos'} },
    { key:'James', ch:5, name:{pt:'Tiago', en:'James', es:'Santiago'} },
    { key:'1 Peter', ch:5, name:{pt:'1 Pedro', en:'1 Peter', es:'1 Pedro'} },
    { key:'2 Peter', ch:3, name:{pt:'2 Pedro', en:'2 Peter', es:'2 Pedro'} },
    { key:'1 John', ch:5, name:{pt:'1 Jo√£o', en:'1 John', es:'1 Juan'} },
    { key:'2 John', ch:1, name:{pt:'2 Jo√£o', en:'2 John', es:'2 Juan'} },
    { key:'3 John', ch:1, name:{pt:'3 Jo√£o', en:'3 John', es:'3 Juan'} },
    { key:'Jude', ch:1, name:{pt:'Judas', en:'Jude', es:'Judas'} },
    { key:'Revelation', ch:22, name:{pt:'Apocalipse', en:'Revelation', es:'Apocalipsis'} }
  ];
  const FLAT = [];
  (function buildFlat(){
    for(const b of BOOKS){
      for(let c=1;c<=b.ch;c++) FLAT.push({ bookKey: b.key, chapter: c });
    }
  })();
  function bookName(bookKey, lang){
    const b = BOOKS.find(x=>x.key===bookKey);
    return b ? (b.name[lang] || b.name.pt) : bookKey;
  }
  function formatRefObj(obj, lang){
    return `${bookName(obj.bookKey, lang)} ${obj.chapter}`;
  }
  const CHRON_ORDER_KEYS = [ 
    'Genesis','Job','Exodus','Leviticus','Numbers','Deuteronomy','Joshua','Judges','Ruth',
    '1 Samuel','2 Samuel','1 Kings','2 Kings','1 Chronicles','2 Chronicles','Ezra','Nehemiah','Esther',
    'Isaiah','Hosea','Joel','Amos','Obadiah','Jonah','Micah','Nahum','Habakkuk','Zephaniah','Zechariah','Haggai','Malachi',
    'Psalms','Proverbs','Ecclesiastes','Song of Solomon',
    'Matthew','Mark','Luke','John','Acts','Romans','1 Corinthians','2 Corinthians','Galatians','Ephesians','Philippians','Colossians','1 Thessalonians','2 Thessalonians','1 Timothy','2 Timothy','Titus','Philemon','Hebrews','James','1 Peter','2 Peter','1 John','2 John','3 John','3 John','Jude','Revelation','Daniel','Jeremiah','Lamentations','Ezekiel'
  ];
  
  // FUN√á√ïES DE GERA√á√ÉO DE PLANO (AGORA USAM DURATION)
  function genTradicional(lang, duration){
    const total = FLAT.length; const perDay = total / duration; const plan = Array.from({length:duration}, ()=>[]); let idx=0;
    for(let day=0; day<duration; day++){
      const take = Math.max(1, Math.round(perDay));
      for(let t=0; t<take && idx<total; t++, idx++) plan[day].push(formatRefObj(FLAT[idx], lang));
    }
    while(idx<total) plan[plan.length-1].push(formatRefObj(FLAT[idx++], lang));
    return plan;
  }
  function genCronologico(lang, duration){
    const arr = [];
    for(const k of CHRON_ORDER_KEYS){
      const book = BOOKS.find(b=>b.key===k);
      if(!book) continue;
      for(let c=1;c<=book.ch;c++) arr.push({bookKey: book.key, chapter: c});
    }
    for(const b of BOOKS) if(!CHRON_ORDER_KEYS.includes(b.key)) for(let c=1;c<=b.ch;c++) arr.push({bookKey: b.key, chapter: c});
    const total = arr.length; const perDay = total/duration; const plan = Array.from({length:duration},()=>[]); let idx=0;
    for(let d=0; d<duration; d++){
      const take = Math.max(1, Math.round(perDay));
      for(let t=0;t<take && idx<total;t++,idx++) plan[d].push(formatRefObj(arr[idx], lang));
    }
    while(idx<total) plan[plan.length-1].push(formatRefObj(arr[idx++] , lang));
    return plan;
  }
  function genATNT(lang, duration){
    const mattIndex = FLAT.findIndex(c=>c.bookKey==='Matthew');
    const ot = FLAT.slice(0, mattIndex); const nt = FLAT.slice(mattIndex);
    const otPer = ot.length/duration; const ntPer = nt.length/duration;
    const plan = Array.from({length:duration},()=>[]); let i=0,j=0;
    for(let d=0; d<duration; d++){
      const takeOT = Math.max(1, Math.round(otPer)); const takeNT = Math.max(1, Math.round(ntPer));
      for(let t=0;t<takeOT && i<ot.length;t++,i++) plan[d].push(formatRefObj(ot[i], lang));
      for(let t=0;t<takeNT && j<nt.length;t++,j++) plan[d].push(formatRefObj(nt[j], lang));
    }
    while(i<ot.length) plan[plan.length-1].push(formatRefObj(ot[i++], lang));
    while(j<nt.length) plan[plan.length-1].push(formatRefObj(nt[j++], lang));
    return plan;
  }
  function genJesusYear(lang, duration){
    const order = ['Matthew','Mark','Luke','John','Acts','Romans','1 Corinthians','2 Corinthians','Galatians','Ephesians','Philippians','Colossians','1 Thessalonians','2 Thessalonians','1 Timothy','2 Timothy','Titus','Philemon','Hebrews','James','1 Peter','2 Peter','1 John','2 John','3 John','3 John','Jude','Revelation'];
    const arr = [];
    for(const name of order){
      const book = BOOKS.find(b=>b.key===name);
      if(!book) continue;
      for(let c=1;c<=book.ch;c++) arr.push({bookKey: book.key, chapter:c});
    }
    for(const b of BOOKS) if(!order.includes(b.key)) for(let c=1;c<=b.ch;c++) arr.push({bookKey: b.key, chapter:c});
    const total = arr.length; const perDay = total/duration; const plan = Array.from({length:duration},()=>[]); let idx=0;
    for(let d=0; d<duration; d++){
      const take = Math.max(1, Math.round(perDay));
      for(let t=0;t<take && idx<total;t++,idx++) plan[d].push(formatRefObj(arr[idx], lang));
    }
    while(idx<total) plan[plan.length-1].push(formatRefObj(arr[idx++]));
    return plan;
  }
  function genUmCapitulo(lang, duration){
    const plan = Array.from({length:duration},()=>[]);
    for(let i=0;i<duration;i++){
      if(i<FLAT.length) plan[i].push(formatRefObj(FLAT[i], lang)); else plan[i].push('‚Äî');
    }
    return plan;
  }
  function genComSalmos(lang, duration){
    const mattIndex = FLAT.findIndex(c=>c.bookKey==='Matthew');
    const ot = FLAT.slice(0, mattIndex); const nt = FLAT.slice(mattIndex);
    const psStart = FLAT.findIndex(c=>c.bookKey==='Psalms'); const provStart = FLAT.findIndex(c=>c.bookKey==='Proverbs');
    const psCount = BOOKS.find(b=>b.key==='Psalms').ch; const provCount = BOOKS.find(b=>b.key==='Proverbs').ch;
    const otPer = ot.length/duration; const ntPer = nt.length/duration;
    const plan = Array.from({length:duration},()=>[]); let i=0,j=0,p=psStart,pr=provStart,alt=true;
    for(let d=0; d<duration; d++){
      const takeOT = Math.max(1, Math.round(otPer)); const takeNT = Math.max(1, Math.round(ntPer));
      for(let t=0;t<takeOT && i<ot.length;t++,i++) plan[d].push(formatRefObj(ot[i], lang));
      for(let t=0;t<takeNT && j<nt.length;t++,j++) plan[d].push(formatRefObj(nt[j], lang));
      if(alt && p < psStart + psCount) plan[d].push(formatRefObj(FLAT[p++], lang));
      else if(!alt && pr < provStart + provCount) plan[d].push(formatRefObj(FLAT[pr++], lang));
      else if(p < psStart + psCount) plan[d].push(formatRefObj(FLAT[p++], lang));
      else if(pr < provStart + provCount) plan[d].push(formatRefObj(FLAT[pr++], lang));
      alt = !alt;
    }
    while(i<ot.length) plan[plan.length-1].push(formatRefObj(ot[i++] , lang));
    while(j<nt.length) plan[plan.length-1].push(formatRefObj(nt[j++] , lang));
    return plan;
  }

  const PLAN_GENERATORS = { tradicional: genTradicional, cronologico: genCronologico, atnt: genATNT, jesus: genJesusYear, umcap: genUmCapitulo, salmos: genComSalmos };
  let CACHE = {};
  
  // getPlan usa a dura√ß√£o do estado
  function getPlan(id, lang){
    const duration = state.planDuration;
    const key = `${id}__${lang}__${duration}`;
    if(!CACHE[key]) CACHE[key] = PLAN_GENERATORS[id](lang, duration);
    return CACHE[key];
  }

  // ---------- UI & STATE ----------
  let state = {
    // Carrega o idioma e o plano do localStorage ou usa o padr√£o 'pt'/'tradicional'
    idioma: localStorage.getItem('bib_idioma') || 'pt',
    planoId: localStorage.getItem('bib_plano') || null, 
    // Dura√ß√£o do plano (padr√£o 365)
    planDuration: parseInt(localStorage.getItem('bib_duration')) || 365,
    // Data de in√≠cio do plano (Formato: YYYY-MM-DD)
    planStartDate: localStorage.getItem('bib_start_date') || null,
    selectedMonth: 1,
    selectedDayOfMonth: null,
  };
  
  // Calcula o dia do ano (1 a 365)
  function getDayOfYear(date) {
    const start = new Date(date.getFullYear(), 0, 0);
    const diff = date - start;
    const oneDay = 1000 * 60 * 60 * 24;
    return Math.floor(diff / oneDay);
  }

  function dayOfYearToMonthDay(n){
    let m=0; let day = n;
    while(m<12 && day > DAYS_PER_MONTH[m]){ day -= DAYS_PER_MONTH[m]; m++; }
    return { month: m+1, day: day };
  }
  function monthDayToDayOfYear(month, day){
    let s=0; for(let i=0;i<month-1;i++) s+=DAYS_PER_MONTH[i]; return s+day;
  }

  // Alterna a visualiza√ß√£o entre as duas "p√°ginas"
  function showPage(pageId) {
      const selecao = document.getElementById('paginaSelecao');
      const plano = document.getElementById('paginaPlano');
      const texts = UI_TEXT[state.idioma];

      if (pageId === 'paginaPlano' && state.planoId) {
          // Exibir P√°gina do Plano
          selecao.classList.add('hidden'); // Usa 'hidden' para ocultar
          plano.classList.remove('hidden'); // Usa 'hidden' para mostrar
          
          document.getElementById('tituloApp').innerText = ` ${texts.titulo}`;
          document.getElementById('subtituloApp').innerText = texts.subtitulo;
          
          renderPlanGrid();
          renderMonths(); 
          renderDays(state.selectedMonth); 
          updateProgressUI();

      } else {
          // Exibir P√°gina de Sele√ß√£o
          plano.classList.add('hidden');
          selecao.classList.remove('hidden');
          
          // ATUALIZA√á√ÉO DO HEADER (SEM REDUND√ÇNCIA NO BODY)
          document.getElementById('tituloApp').innerText = ` ${texts.titulo_selecao}`;
          document.getElementById('subtituloApp').innerText = texts.subtitulo_selecao;

          renderPlanGrid();
      }
      if(window.lucide) window.lucide.createIcons();
  }

  // ---------- RENDER FUNCTIONS ----------
  function renderPlanGrid(){
    const container = document.getElementById('gridPlanos'); 
    if (!container) return; 
    
    container.innerHTML='';
    const texts = UI_TEXT[state.idioma].planos;
    const icons = ['calendar','clock','layers','heart','book-open','sun'];
    texts.forEach((p, idx)=>{
      const card = document.createElement('div'); // O card √© um div, n√£o um bot√£o principal
      const isSelected = state.planoId===p.id;
      // Usando flex-col justify-between para o bot√£o ficar no final
      card.className='plan-card flex flex-col justify-between p-4 rounded-xl shadow-lg transition-all duration-200 text-center ' +
                    (isSelected ? 'bg-primary-500 text-white ring-4 ring-primary-500/50' : 'bg-white dark:bg-gray-800 hover:ring-2 hover:ring-primary-500');
      card.style.minHeight='180px'; 

      const iconColor = isSelected ? 'text-white' : 'text-primary-500';
      const descColor = isSelected ? 'text-indigo-200' : 'text-gray-500 dark:text-gray-400';
      const iconName = icons[idx] || 'book';
      
      card.innerHTML = `
        <div>
            <div class="mb-2"><i data-lucide="${iconName}" class="lucide w-8 h-8 ${iconColor}"></i></div>
            <div class="text-base font-bold">${p.title}</div>
            <div class="text-xs ${descColor} mt-1">${p.desc}</div>
        </div>
        <button id="btnStartPlan_${p.id}" data-plan-id="${p.id}" class="mt-4 px-4 py-2 rounded-xl font-semibold transition text-sm ${
            isSelected 
                ? 'bg-white text-primary-500 cursor-default opacity-80' 
                : 'bg-primary-500 text-white hover:bg-primary-600'
        }" ${isSelected ? 'disabled' : ''}>
            ${isSelected ? 'Plano Ativo' : 'Iniciar Plano'}
        </button>
        `;
      
      container.appendChild(card);
      
      // Adiciona o listener APENAS ao bot√£o "Iniciar Plano"
      if(!isSelected){
        document.getElementById(`btnStartPlan_${p.id}`).onclick = (e)=>{
          e.stopPropagation(); // Previne clique no card, embora o card n√£o tenha listener principal
          state.planoId = p.id;
          localStorage.setItem('bib_plano', p.id); 
          
          // Define a data de in√≠cio como hoje ao iniciar o plano (Change 1)
          const today = new Date();
          const y = today.getFullYear();
          const m = String(today.getMonth() + 1).padStart(2, '0');
          const d = String(today.getDate()).padStart(2, '0');
          state.planStartDate = `${y}-${m}-${d}`;
          localStorage.setItem('bib_start_date', state.planStartDate);

          showPage('paginaPlano');
        };
      }
    });
    if(window.lucide) window.lucide.createIcons();
  }

  function renderMonths(){
    const div = document.getElementById('meses'); 
    if (!div) return;
    
    div.innerHTML='';
    const months = MONTHS[state.idioma];
    
    // Calcula quantos meses s√£o necess√°rios para a dura√ß√£o atual (arredondando para cima)
    const requiredMonths = Math.ceil(state.planDuration / 31); // 90 dias = 3 meses, 365 dias = 12 meses

    for (let i = 0; i < 12; i++) {
        // Se a dura√ß√£o for menor que 12 meses, s√≥ renderiza os meses necess√°rios
        if (state.planDuration < 365 && i >= requiredMonths) continue;

        const m = months[i];
        const monthIndex = i + 1; // 1 a 12
        const isSelected = state.selectedMonth === monthIndex;
        const btn = document.createElement('button');
        btn.className = 'flex-shrink-0 px-4 py-2 rounded-full font-semibold transition ' + 
                        (isSelected ? 'bg-primary-500 text-white shadow-md' : 'bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600');
        btn.innerText = m;
        btn.onclick = ()=>{ state.selectedMonth = monthIndex; renderMonths(); renderDays(monthIndex); };
        div.appendChild(btn);
    }
    
    const currentMonthButton = document.querySelector(`#meses button:nth-child(${state.selectedMonth})`);
    if(currentMonthButton){
        currentMonthButton.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
  }

  function renderDays(month){
    const container = document.getElementById('dias'); 
    if (!container || !state.planoId) return;

    container.innerHTML='';
    const daysInMonth = DAYS_PER_MONTH[month-1];
    const startDayOfYear = monthDayToDayOfYear(month,1);
    const plan = getPlan(state.planoId, state.idioma);
    
    // NOVO: L√≥gica de Data e Acompanhamento
    let dayFromStart = null;
    if (state.planStartDate) {
        const startDate = new Date(state.planStartDate);
        const today = new Date();
        // Zera o tempo para contagem de dias exata
        startDate.setHours(0, 0, 0, 0);
        today.setHours(0, 0, 0, 0);
        // Dias decorridos desde o in√≠cio (1-indexado)
        dayFromStart = Math.floor((today - startDate) / (1000 * 60 * 60 * 24)) + 1;
    }
    
    for(let d=1; d<=daysInMonth; d++){
      const dayOfYear = startDayOfYear + d -1; 
      const idx = dayOfYear -1; 
      
      const refs = plan[idx] || ['‚Äî']; 
      
      const key = `${state.planoId}_day_${dayOfYear}`; 
      const lido = localStorage.getItem(key);
      const card = document.createElement('div');
      
      const dayBeingRendered = dayOfYear; // Dia do plano sendo renderizado (1 a Dura√ß√£o)
      const isExpectedDay = state.planStartDate && dayBeingRendered === dayFromStart; 
      
      let cardClasses = 'p-4 rounded-xl shadow-md border-t-4 cursor-pointer transition';
      
      // Se o dia do ano for maior que a dura√ß√£o do plano, n√£o mostra leituras
      const isOutsidePlanDuration = dayOfYear > state.planDuration;
      const hasReadings = idx < state.planDuration && refs.some(r => r !== '‚Äî');

      if (isOutsidePlanDuration) {
          cardClasses += ' border-gray-100 dark:border-gray-800 bg-gray-50 dark:bg-gray-900 cursor-default opacity-70';
      } else if (isExpectedDay && hasReadings) { // Destaque para o dia 'Em Dia'
          cardClasses += ' today-highlight border-primary-500'; 
      } else {
          // Se LIDO, usa Borda Vermelha (ajustado de primary-500) e fundo cinza (read-highlight)
          cardClasses += (lido ? ' border-red-500 opacity-90 read-highlight' : ' border-gray-200 dark:border-gray-700 hover:shadow-lg hover:ring-1 hover:ring-primary-500') +
                         ' bg-white dark:bg-gray-800';
      }

      card.className = cardClasses;
      
      const preview = hasReadings ? refs.slice(0,2).join(', ') : '‚Äî';
      const iconName = lido ? 'check-circle' : (isOutsidePlanDuration ? 'minus' : 'chevrons-right');
      const iconColor = lido ? 'text-red-500' : (isExpectedDay ? 'text-primary-500' : (isOutsidePlanDuration ? 'text-gray-400' : 'text-gray-400 dark:text-gray-500')); 
      const textColor = isExpectedDay ? 'text-gray-800 dark:text-gray-100' : (isOutsidePlanDuration ? 'text-gray-400 dark:text-gray-500' : 'text-gray-700 dark:text-gray-200');

      let statusHtml = '';
      if (lido) {
        // Leitura Conclu√≠da
        statusHtml = `<p class="text-xs font-bold text-red-500 mt-2">${UI_TEXT[state.idioma].lido}</p>`;
      } else if (state.planStartDate && hasReadings) {
        // Alerta de Atraso/Adiantado (TRADUZIDO)
        const texts = UI_TEXT[state.idioma]; // Objeto de textos para tradu√ß√£o
        
        if (dayBeingRendered < dayFromStart) {
            const diff = dayFromStart - dayBeingRendered;
            // Atrasado: Texto vermelho
            statusHtml = `<p class="text-xs font-bold text-red-500 mt-2">${texts.delayed} ${diff}${texts.days_behind}</p>`;
        } else if (dayBeingRendered > dayFromStart) {
            const diff = dayBeingRendered - dayFromStart;
            // Adiantado: Texto verde
            statusHtml = `<p class="text-xs font-bold text-green-500 mt-2">${texts.ahead} ${diff}${texts.days_ahead}</p>`;
        }
      }

      card.innerHTML = `\
        <div class="flex justify-between items-start">\
          <div>\
            <h3 class="text-xl font-extrabold ${isExpectedDay ? 'text-primary-600 dark:text-primary-400' : 'text-primary-500'}">${d}</h3>\
            <p class="text-xs ${isExpectedDay ? 'text-primary-400 dark:text-primary-300' : 'text-gray-500 dark:text-gray-400'} font-medium mt-0.5">${formatDateSmall(month,d)}</p>\
          </div>\
          <div class="${iconColor} flex-shrink-0"><i data-lucide="${iconName}" class="lucide w-6 h-6"></i></div>\
        </div>\
        ${statusHtml}
        <p class="mt-3 text-sm font-medium ${textColor}">${preview}${refs.length>2 && hasReadings ? ' ...' : ''}</p>`;
      
      // O modal s√≥ deve abrir se houverem leituras programadas para aquele dia ou se estiver dentro da dura√ß√£o.
      if (dayOfYear <= state.planDuration) {
          card.onclick = ()=> abrirModalForDay(dayOfYear);
      } else {
          // Desabilita o cursor e clica se estiver fora do plano
          card.style.cursor = 'default';
          card.classList.remove('hover:shadow-lg', 'hover:ring-1', 'hover:ring-primary-500');
          if (!isOutsidePlanDuration) { // Adicionado para evitar erro, mas n√£o deve acontecer
             card.innerHTML = `\
                <div class="flex justify-between items-start">\
                  <div>\
                    <h3 class="text-xl font-extrabold text-gray-400">${d}</h3>\
                    <p class="text-xs text-gray-500 dark:text-gray-400 font-medium mt-0.5">${formatDateSmall(month,d)}</p>\
                  </div>\
                  <div class="text-gray-400 flex-shrink-0"><i data-lucide="minus" class="lucide w-6 h-6"></i></div>\
                </div>\
                <p class="mt-3 text-sm font-medium text-gray-400">Fora do plano de ${state.planDuration} dias.</p>`;
          }
      }
      
      container.appendChild(card);
    }
    if(window.lucide) window.lucide.createIcons();
    updateProgressUI();
  }

  function formatDateSmall(month, day){ const months = MONTHS[state.idioma]; return `${months[month-1]} ${day}`; }

  let modalCurrentDay = null;
  const modalDiv = document.getElementById('modal');
  const modalContent = document.getElementById('modalContent');

  function abrirModalForDay(dayOfYear){
    if (!state.planoId) return;
    modalCurrentDay = dayOfYear;
    const plan = getPlan(state.planoId, state.idioma);
    const refs = plan[dayOfYear-1] || [];
    const key = `${state.planoId}_day_${dayOfYear}`;
    const lido = localStorage.getItem(key);
    
    const hasReadings = refs.some(r => r !== '‚Äî');

    document.getElementById('modalTitulo').innerText = `${UI_TEXT[state.idioma].start} ‚Ä¢ ${UI_TEXT[state.idioma].dia_leitura} ${dayOfYear}`;
    const ul = document.getElementById('modalLeituras'); ul.innerHTML = '';
    
    if (hasReadings) {
        refs.forEach(r=>{
          const li = document.createElement('li'); li.className='text-base flex items-center p-2 rounded-lg bg-gray-50 dark:bg-gray-700';
          const icon = document.createElement('i'); icon.setAttribute('data-lucide', 'book-open'); icon.className='lucide w-4 h-4 mr-3 text-primary-500 flex-shrink-0';
          const span = document.createElement('span'); span.innerText = r;
          li.appendChild(icon);
          li.appendChild(span);
          ul.appendChild(li);
        });
        
        // Ativa os bot√µes
        document.getElementById('btnLido').disabled = false;
        document.getElementById('btnLido').classList.remove('opacity-50', 'cursor-not-allowed');
        document.getElementById('btnLerAgora').disabled = false;
        document.getElementById('btnLerAgora').classList.remove('opacity-50', 'cursor-not-allowed');
    } else {
        ul.innerHTML = '<li class="text-base text-center p-2 rounded-lg bg-gray-50 dark:bg-gray-700">Nenhuma leitura programada para este dia.</li>';
        // Desativa os bot√µes
        document.getElementById('btnLido').disabled = true;
        document.getElementById('btnLido').classList.add('opacity-50', 'cursor-not-allowed');
        document.getElementById('btnLerAgora').disabled = true;
        document.getElementById('btnLerAgora').classList.add('opacity-50', 'cursor-not-allowed');
    }
    
    // Atualiza o texto e estilo do bot√£o "Lido"
    const btnLido = document.getElementById('btnLido');
    if (lido) {
        btnLido.innerText = UI_TEXT[state.idioma].lido;
        btnLido.classList.add('bg-green-500', 'hover:bg-green-600', 'shadow-green-500/30');
        btnLido.classList.remove('bg-primary-500', 'hover:bg-primary-600', 'shadow-primary-500/30');
    } else {
        btnLido.innerText = UI_TEXT[state.idioma].nao_lido;
        btnLido.classList.add('bg-primary-500', 'hover:bg-primary-600', 'shadow-primary-500/30');
        btnLido.classList.remove('bg-green-500', 'hover:bg-green-600', 'shadow-green-500/30');
    }
    
    document.getElementById('btnLerAgora').innerText = `üìñ ${UI_TEXT[state.idioma].ler_agora}`;
    
    modalDiv.classList.remove('hidden');
    setTimeout(()=>{
      modalDiv.style.opacity = '1';
      modalContent.classList.remove('scale-95');
    }, 10); 

    if(window.lucide) window.lucide.createIcons();
  }

  function fecharModal(){
    modalDiv.style.opacity = '0';
    modalContent.classList.add('scale-95');
    setTimeout(()=> modalDiv.classList.add('hidden'), 300); 
  }

  document.getElementById('fecharModal').addEventListener('click', fecharModal);
  
  document.getElementById('btnLido').addEventListener('click', ()=>{
    if(!modalCurrentDay || document.getElementById('btnLido').disabled) return; 
    const key = `${state.planoId}_day_${modalCurrentDay}`; 
    const lido = localStorage.getItem(key);

    if (lido) {
        localStorage.removeItem(key); // Desmarca como lido
    } else {
        localStorage.setItem(key,'1'); // Marca como lido
    }
    
    fecharModal(); 
    renderDays(state.selectedMonth); 
    updateProgressUI();
  });

  document.getElementById('btnLerAgora').addEventListener('click', ()=>{
    if(!modalCurrentDay || !state.planoId || document.getElementById('btnLerAgora').disabled) return; 
    const plan = getPlan(state.planoId, state.idioma); 
    const refs = plan[modalCurrentDay-1] || [];
    if(refs.length===0 || refs.some(r=>r==='‚Äî')) return;
    const joinForSearch = refs.map(r=> r.replace(/\s+/g,' ')).join(',');
    const version = state.idioma==='pt' ? 'NVI-PT' : state.idioma==='en' ? 'NIV' : 'NIV';
    const url = `https://www.biblegateway.com/passage/?search=${encodeURIComponent(joinForSearch)}&version=${version}`;
    window.open(url, '_blank');
  });
  
  document.getElementById('modal').addEventListener('click',(e)=>{ if(e.target.id==='modal') fecharModal(); });

  function updateProgressUI(){
    if (!state.planoId) return;
      
    // Usa a dura√ß√£o do estado (que √© o tamanho do plano)
    const total = state.planDuration;
    let read=0;
    for(let i=0;i<total;i++){ 
        if(localStorage.getItem(`${state.planoId}_day_${i+1}`)) read++; 
    }
    const pct = Math.round((read/total)*100);
    
    const progressoBar = document.getElementById('progressoBar');
    const textoProgresso = document.getElementById('textoProgresso');
    const textoPlanoAtual = document.getElementById('textoPlanoAtual');
    const textoDataInicio = document.getElementById('textoDataInicio'); // Elemento da data

    if (progressoBar) progressoBar.style.width = pct + '%';
    // O total √© baseado na DURA√á√ÉO
    if (textoProgresso) textoProgresso.innerText = `${UI_TEXT[state.idioma].progresso}: ${read} / ${total}`;
    
    const planoEncontrado = UI_TEXT[state.idioma].planos.find(p=>p.id===state.planoId);
    const planName = planoEncontrado ? planoEncontrado.title : '---';
    
    // Atualiza o texto do display est√°tico
    if (textoPlanoAtual) textoPlanoAtual.innerHTML = `${UI_TEXT[state.idioma].plano}: ${planName} (${total}d)`;

    // Atualiza a data de in√≠cio
    if (textoDataInicio && state.planStartDate) {
        // Formata YYYY-MM-DD para o formato local (ex: DD/MM/YYYY)
        const dateParts = state.planStartDate.split('-');
        const texts = UI_TEXT[state.idioma];
        
        // Usa o formato PT/BR (DD/MM/YYYY) se o idioma for PT, sen√£o usa EN/US (MM/DD/YYYY)
        const formattedDate = state.idioma === 'pt' 
            ? `${dateParts[2]}/${dateParts[1]}/${dateParts[0]}` 
            : `${dateParts[1]}/${dateParts[2]}/${dateParts[0]}`;

        textoDataInicio.innerText = `${texts.start_date_label}: ${formattedDate}`;
    } else if (textoDataInicio) {
        textoDataInicio.innerText = '';
    }
  }


  // ---------- IDIOMA DROPDOWN LOGIC ----------
  const idiomaToggle = document.getElementById('idiomaToggle');
  const idiomaMenu = document.getElementById('idiomaMenu');
  const currentFlag = document.getElementById('currentFlag');
  const idiomaItems = document.querySelectorAll('.idioma-item');

  function updateIdiomaDisplay(lang){
    const texts = UI_TEXT[lang];
    const flagCode = texts.flag_code;

    // Atualiza o bot√£o principal APENAS com a bandeira
    currentFlag.className = `flag-icon flag-icon-${flagCode}`;
    
    // Altera o estado de 'selecionado' no menu
    idiomaItems.forEach(item => {
        if(item.getAttribute('data-lang') === lang) {
            item.classList.add('bg-gray-200', 'dark:bg-gray-600');
        } else {
            item.classList.remove('bg-gray-200', 'dark:bg-gray-600');
        }
    });

    updateUITexts(lang);
  }
  
  function toggleIdiomaMenu(){
      const isHidden = idiomaMenu.classList.contains('hidden');
      if (isHidden) {
          idiomaMenu.classList.remove('hidden');
          setTimeout(() => {
              idiomaMenu.classList.remove('scale-95', 'opacity-0');
          }, 10);
      } else {
          idiomaMenu.classList.add('scale-95', 'opacity-0');
          setTimeout(() => {
              idiomaMenu.classList.add('hidden');
          }, 150);
      }
  }

  idiomaToggle.addEventListener('click', toggleIdiomaMenu);
  document.addEventListener('click', (e) => {
      const idiomaDropdown = document.getElementById('idiomaDropdown');
      const isClickInside = idiomaDropdown.contains(e.target);
      if (!isClickInside && !idiomaMenu.classList.contains('hidden')) {
          toggleIdiomaMenu();
      }
  });


  idiomaItems.forEach(item => {
      item.addEventListener('click', (e) => {
          const newLang = item.getAttribute('data-lang');
          if (newLang !== state.idioma) {
              state.idioma = newLang; 
              localStorage.setItem('bib_idioma', state.idioma);
              CACHE = {}; // Limpa o cache para recarregar os planos com os nomes no novo idioma
              updateIdiomaDisplay(state.idioma);
          }
          toggleIdiomaMenu();
      });
  });

  // Fun√ß√£o centralizada de atualiza√ß√£o de texto E TRADU√á√ÉO DO BOT√ÉO HOJE
  function updateUITexts(lang){
    const texts = UI_TEXT[lang];
      
    // Redireciona para a p√°gina correta ap√≥s a mudan√ßa de idioma
    showPage(state.planoId ? 'paginaPlano' : 'paginaSelecao');

    // ATUALIZA√á√ÉO DO BOT√ÉO HOJE
    const btnHojeText = document.getElementById('btnHojeText');
    if (btnHojeText) {
        btnHojeText.innerText = texts.hoje;
    }
    
    // ATUALIZA√á√ÉO DOS NOVOS LINKS DE AJUDA
    const linkPrivacidade = document.getElementById('linkPrivacidade');
    const btnAbrirGlossario = document.getElementById('btnAbrirGlossario');
    if (linkPrivacidade) linkPrivacidade.innerText = texts.privacy_link;
    if (btnAbrirGlossario) btnAbrirGlossario.innerText = texts.glossary_link;

    // ATUALIZA√á√ÉO DO NOVO MODAL DE CONFIRMA√á√ÉO
    const modal = document.getElementById('confirmChangePlanModal');
    if (modal && !modal.classList.contains('hidden')) { // Se o modal estiver aberto, atualiza o texto imediatamente
        document.getElementById('confirmTitle').innerText = texts.alert_title || 'Aten√ß√£o!';
        document.getElementById('confirmMessage').innerHTML = texts.alert_change_plan_html;
        document.getElementById('btnCancelChangePlan').innerText = texts.cancel;
        document.getElementById('btnConfirmChangePlan').innerText = texts.confirm_erase;
    }
  }

  // NOVA FUN√á√ÉO: Navega para o m√™s atual e destaca o dia atual
  function goToToday() {
      if (!state.planoId) return;

      const today = new Date();
      const currentMonth = today.getMonth() + 1; 
      
      if (state.selectedMonth !== currentMonth) {
          state.selectedMonth = currentMonth;
      }
      
      renderMonths();
      renderDays(state.selectedMonth);
      
      const mesesContainer = document.getElementById('meses');
      const currentMonthButton = document.querySelector(`#meses button:nth-child(${state.selectedMonth})`);
      if (mesesContainer && currentMonthButton) {
          currentMonthButton.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      }
  }
  
  function clearPlanStorage(){
      // Limpa as chaves de configura√ß√£o do plano
      localStorage.removeItem('bib_plano');
      localStorage.removeItem('bib_duration');
      localStorage.removeItem('bib_start_date');

      // Limpa todas as chaves de progresso do plano anterior (mais seguro que usar o ID)
      const keysToRemove = [];
      for(let i=0; i<localStorage.length; i++){
          const key = localStorage.key(i);
          if(key.includes('_day_')){
              keysToRemove.push(key);
          }
      }
      keysToRemove.forEach(key => localStorage.removeItem(key));
      
      // Reseta o estado
      state.planoId = null;
      state.planDuration = 365;
      state.planStartDate = null;
      CACHE = {};
  }


  // NOVO: L√ìGICA DO MODAL DE CONFIGURA√á√ïES
  const settingsModal = document.getElementById('settingsModal');
  const planDurationSelect = document.getElementById('planDurationSelect');

  function openSettingsModal(){
      const texts = UI_TEXT[state.idioma];

      // Atualiza textos do modal
      document.getElementById('settingsModalTitle').innerText = texts.settings;
      document.querySelector('label[for="planDurationSelect"]').innerText = texts.duration_label;
      document.getElementById('btnTrocarPlano').innerText = texts.link_trocar;
      document.getElementById('btnResetarProgresso').innerText = texts.reset_progress;
      document.getElementById('backupRestoreTitle').innerText = texts.backup_restore;
      document.getElementById('btnExport').innerText = texts.export_progress;
      document.getElementById('btnImport').innerText = texts.import_progress;
      document.getElementById('durationWarning').innerText = texts.alert_duration_change;


      // Preenche o seletor de dura√ß√£o
      planDurationSelect.innerHTML = DURATIONS.map(d => 
          `<option value="${d}">${texts.duration_options[d] || d + ' Days'}</option>`
      ).join('');
      // Seleciona o valor atual
      planDurationSelect.value = state.planDuration.toString();

      settingsModal.classList.remove('hidden');
      setTimeout(() => {
          settingsModal.style.opacity = '1';
          document.getElementById('settingsModalContent').classList.remove('scale-95');
      }, 10);
      if(window.lucide) window.lucide.createIcons();
  }

  function closeSettingsModal(){
      settingsModal.style.opacity = '0';
      document.getElementById('settingsModalContent').classList.add('scale-95');
      setTimeout(() => settingsModal.classList.add('hidden'), 300);
  }
  
  // NOVO: L√ìGICA DO MODAL DE GLOSS√ÅRIO
  const glossaryModal = document.getElementById('glossaryModal');
  
  function openGlossaryModal(){
      const texts = UI_TEXT[state.idioma];

      // Atualiza o t√≠tulo do modal
      document.getElementById('glossaryModalTitle').innerText = texts.glossary_link; 

      glossaryModal.classList.remove('hidden');
      setTimeout(() => {
          glossaryModal.style.opacity = '1';
          document.getElementById('glossaryModalContent').classList.remove('scale-95');
      }, 10);
      if(window.lucide) window.lucide.createIcons();
  }

  function closeGlossaryModal(){
      glossaryModal.style.opacity = '0';
      document.getElementById('glossaryModalContent').classList.add('scale-95');
      setTimeout(() => glossaryModal.classList.add('hidden'), 300);
  }

  // Handler: Dura√ß√£o do Plano
  planDurationSelect.addEventListener('change', (e) => {
      const newDuration = parseInt(e.target.value);
      if (newDuration !== state.planDuration) {
          state.planDuration = newDuration;
          localStorage.setItem('bib_duration', newDuration);
          CACHE = {}; // Invalida o cache para gerar o novo plano
          closeSettingsModal();
          showPage('paginaPlano'); // Re-renderiza o plano com a nova dura√ß√£o
      }
  });

  // --- Fun√ß√µes do Novo Modal de Confirma√ß√£o (Estiloso) ---
  const confirmChangePlanModal = document.getElementById('confirmChangePlanModal');
  const confirmChangePlanContent = document.getElementById('confirmChangePlanContent');

  function openConfirmChangePlanModal() {
      const texts = UI_TEXT[state.idioma];

      document.getElementById('confirmTitle').innerText = texts.alert_title || 'Aten√ß√£o!';
      document.getElementById('confirmMessage').innerHTML = texts.alert_change_plan_html; 
      document.getElementById('btnCancelChangePlan').innerText = texts.cancel;
      document.getElementById('btnConfirmChangePlan').innerText = texts.confirm_erase;

      confirmChangePlanModal.classList.remove('hidden');
      setTimeout(() => {
          confirmChangePlanModal.style.opacity = '1';
          confirmChangePlanContent.classList.remove('scale-95');
      }, 10);
      if(window.lucide) window.lucide.createIcons();
  }

  function closeConfirmChangePlanModal() {
      confirmChangePlanModal.style.opacity = '0';
      confirmChangePlanContent.classList.add('scale-95');
      setTimeout(() => confirmChangePlanModal.classList.add('hidden'), 300);
  }

  // Handler: Trocar Plano (MODIFICADO para abrir o modal customizado)
  document.getElementById('btnTrocarPlano').addEventListener('click', () => {
      closeSettingsModal(); // Fecha o modal de configura√ß√µes primeiro
      openConfirmChangePlanModal(); // Abre o novo modal de confirma√ß√£o
  });

  // Handler: Cancelar a troca de plano no modal customizado
  document.getElementById('btnCancelChangePlan').addEventListener('click', () => {
      closeConfirmChangePlanModal();
  });
  
  // Handler: Confirmar a troca de plano no modal customizado
  document.getElementById('btnConfirmChangePlan').addEventListener('click', () => {
      clearPlanStorage(); // ZERA O CACHE!
      closeConfirmChangePlanModal();
      showPage('paginaSelecao');
  });

  document.getElementById('confirmChangePlanModal').addEventListener('click', (e) => { 
      if(e.target.id === 'confirmChangePlanModal') closeConfirmChangePlanModal(); 
  });


  // Handler: Resetar Progresso
  document.getElementById('btnResetarProgresso').addEventListener('click', () => {
      if (confirm(UI_TEXT[state.idioma].alert_reset)) {
          const totalDays = state.planDuration;
          // Limpa apenas os itens de progresso do plano atual
          for (let i = 1; i <= totalDays; i++) {
              localStorage.removeItem(`${state.planoId}_day_${i}`);
          }
          // Opcional: limpa a data de in√≠cio se o plano for resetado
          localStorage.removeItem('bib_start_date');
          state.planStartDate = null;

          closeSettingsModal();
          showPage('paginaPlano'); // Re-renderiza a p√°gina para mostrar o progresso zerado
      }
  });


  // Handler: Exportar Progresso
  function exportProgress() {
      const data = {};
      const keys = Object.keys(localStorage);
      keys.forEach(key => {
          // Filtra apenas os dados de progresso e configura√ß√µes relevantes
          if (key.startsWith('bib_') || key.includes('_day_')) {
              data[key] = localStorage.getItem(key);
          }
      });

      const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data, null, 2));
      const downloadAnchorNode = document.createElement('a');
      downloadAnchorNode.setAttribute("href", dataStr);
      downloadAnchorNode.setAttribute("download", `bible_plan_backup_${new Date().toISOString().slice(0, 10)}.json`);
      document.body.appendChild(downloadAnchorNode);
      downloadAnchorNode.click();
      downloadAnchorNode.remove();
  }
  document.getElementById('btnExport').addEventListener('click', exportProgress);


  // Handler: Importar Progresso
  function importProgress() {
      const fileInput = document.createElement('input');
      fileInput.type = 'file';
      fileInput.accept = 'application/json';
      fileInput.style.display = 'none';

      fileInput.onchange = e => {
          const file = e.target.files[0];
          if (!file) return;

          const reader = new FileReader();
          reader.onload = function(event) {
              try {
                  const importedData = JSON.parse(event.target.result);
                  
                  // Limpa o localStorage de dados de plano e configura√ß√µes relevantes antes de importar
                  const keysToClear = Object.keys(localStorage).filter(key => key.startsWith('bib_') || key.includes('_day_'));
                  keysToClear.forEach(key => localStorage.removeItem(key));

                  // Importa os novos dados
                  for (const key in importedData) {
                      localStorage.setItem(key, importedData[key]);
                  }

                  // Atualiza o estado global com os novos dados
                  state.idioma = localStorage.getItem('bib_idioma') || 'pt';
                  state.planoId = localStorage.getItem('bib_plano') || null;
                  state.planDuration = parseInt(localStorage.getItem('bib_duration')) || 365;
                  state.planStartDate = localStorage.getItem('bib_start_date') || null;

                  closeSettingsModal();
                  alert(UI_TEXT[state.idioma].alert_import_success);
                  location.reload(); 

              } catch (error) {
                  console.error("Erro durante a importa√ß√£o:", error);
                  alert(UI_TEXT[state.idioma].alert_import_error);
              }
          };
          reader.readAsText(file);
      };

      document.body.appendChild(fileInput);
      fileInput.click();
      fileInput.remove();
  }
  document.getElementById('btnImport').addEventListener('click', importProgress);

  // ---------- INITIALIZE APP ----------
  function init(){
    const today = new Date(); 
    state.planoId = localStorage.getItem('bib_plano');
    state.selectedMonth = state.selectedMonth || (today.getMonth()+1);
    
    // 1. Inicializa o display do idioma, o que chama updateUITexts
    updateIdiomaDisplay(state.idioma);
    
    // 2. Adiciona o listener para o novo bot√£o Hoje
    const btnHoje = document.getElementById('btnHoje');
    if (btnHoje) {
        btnHoje.addEventListener('click', goToToday);
    }
    
    // 3. Adiciona o listener para o novo bot√£o Configura√ß√µes
    document.getElementById('btnOpenSettings').addEventListener('click', openSettingsModal);
    document.getElementById('settingsModal').addEventListener('click', (e) => { 
        if(e.target.id === 'settingsModal') closeSettingsModal(); 
    });
    
    // 4. Adiciona o listener para o bot√£o de Gloss√°rio
    document.getElementById('btnAbrirGlossario').addEventListener('click', openGlossaryModal);
    document.getElementById('fecharGlossaryModal').addEventListener('click', closeGlossaryModal);
    document.getElementById('glossaryModal').addEventListener('click', (e) => { 
        if(e.target.id === 'glossaryModal') closeGlossaryModal(); 
    });
    
    // 5. Adiciona o listener ao link de privacidade (Apenas um placeholder para um link real)
    document.getElementById('linkPrivacidade').addEventListener('click', (e) => {
        e.preventDefault();
        alert('Aqui voc√™ colocaria o link ou o conte√∫do da Pol√≠tica de Privacidade. O Plano B√≠blico √© 100% armazenado localmente no seu navegador e n√£o coleta dados.');
    });
  }
  
  // Executa a inicializa√ß√£o ap√≥s o DOM carregar
  document.addEventListener('DOMContentLoaded', () => {
      // --- L√≥gica do Tema (Original) ---
      const btnTema = document.getElementById('btnTema');
      const themeStatusText = document.getElementById('themeStatusText'); 
      const root = document.documentElement;
  
      function applyTheme(isDark) {
          root.classList.toggle('dark', !!isDark);
          if (isDark) {
              localStorage.setItem('bib_theme', 'dark');
              if (themeStatusText) themeStatusText.innerText = 'üåû'; 
          } else {
              localStorage.removeItem('bib_theme');
              if (themeStatusText) themeStatusText.innerText = 'üåô';
          }
      }
  
      function toggleTheme() {
          const nowDark = root.classList.contains('dark');
          applyTheme(!nowDark);
      }
  
      // 1. Inicializa o tema na carga
      const storedDark = localStorage.getItem('bib_theme') === 'dark';
      applyTheme(storedDark);
      
      // 2. Adiciona listener ao bot√£o de tema
      if(btnTema) btnTema.addEventListener('click', toggleTheme);

      // --- Inicializa√ß√£o Principal ---
      init();
  });
  </script>

</body>
</html>