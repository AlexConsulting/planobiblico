<!DOCTYPE html>
<html lang="pt" class="">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Plano de Leitura B√≠blica</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <script src="https://cdn.tailwindcss.com"></script>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/lipis/flag-icon-css@1.0/css/flag-icon.min.css"/>
  
  <script type="module" src="https://unpkg.com/lucide@0.259.0/dist/lucide.esm.js"></script>
  <script nomodule src="https://unpkg.com/lucide@0.259.0/dist/lucide.js"></script>

  <script>
    tailwind.config = {
      darkMode: 'class', // Ativa o modo escuro baseado na classe 'dark'
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', 'sans-serif'],
          },
          colors: {
            // Usamos Indigo como primary para consist√™ncia
            'primary': {
              500: '#4f46e5', // Indigo padr√£o
              600: '#4338ca', // Indigo mais escuro para hover
            }
          }
        }
      }
    }
  </script>

  <style>
    /* pequeno polimento */
    .plan-button:active, #idiomaToggle:active, #btnTema:active, #btnOpenSettings:active { transform: scale(.995); }
    /* transi√ß√£o suave para a barra de progresso */
    #progressoBar { transition: width 350ms ease; }
    
    /* NOVO: Estilo para o destaque ao clicar no bot√£o "Hoje" (Contorno) */
    #btnHoje:active { 
        transform: scale(.995); 
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.5); /* Contorno suave */
    }

    /* NOVO: Destaque visual para o dia 'esperado' (Em Dia) */
    .today-highlight {
        border: 4px solid #4f46e5 !important; /* Cor prim√°ria */
        background-color: #eef2ff !important; /* Indigo-50 claro */
        transform: scale(1.01);
        box-shadow: 0 4px 12px rgba(79, 70, 229, 0.2);
    }
    .dark .today-highlight {
        --tw-bg-opacity: 1; 
        background-color: rgb(30 41 59 / var(--tw-bg-opacity)) !important; /* slate-800 */
        border-color: #6366f1 !important; /* Indigo-500 light */
    }
    
    /* Destaque visual para o dia marcado como lido (Fundo cinza, solicitado) */
    .read-highlight {
        background-color: #f3f4f6 !important; /* gray-100 */
    }
    .dark .read-highlight {
        background-color: rgb(30 41 59 / var(--tw-bg-opacity)) !important; /* slate-800 */
    }

    /* NOVO: Estilo para a lista de leituras do modal (Ajuste para planos curtos) */
    .modal-scroll-area {
        max-height: 50vh; /* Limita a altura m√°xima (50% da altura da viewport) */
        overflow-y: auto; /* Adiciona barra de rolagem vertical se o conte√∫do exceder */
        padding-right: 1rem; /* Adiciona um pequeno padding para evitar que o conte√∫do toque na barra de rolagem */
    }
    
    /* Ajuste para o scroll suave no modal de configura√ß√µes */
    #settingsModalContent, #glossaryModalContent, #privacyModalContent { max-height: 90vh; overflow-y: auto; }

  </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-screen flex flex-col font-sans">

  <header class="p-4 sm:p-6 bg-white dark:bg-gray-800 shadow-sm border-b border-gray-100 dark:border-gray-700">
    <div class="max-w-7xl mx-auto flex items-center justify-between gap-4">
      <div class="flex items-center gap-3">
        <div class="rounded-xl bg-primary-500 text-white w-10 h-10 flex items-center justify-center text-xl font-extrabold shadow-md">B</div>
        <div>
          <h1 id="tituloApp" class="text-xl font-bold">Plano de Leitura B√≠blica</h1>
          <p id="subtituloApp" class="text-sm text-gray-600 dark:text-gray-400">Escolha um plano e comece hoje</p>
        </div>
      </div>

      <div class="flex items-center gap-2">
        <div id="idiomaDropdown" class="relative">
            <button id="idiomaToggle" class="px-3 py-2 rounded-xl bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 transition font-medium flex items-center justify-center gap-1" aria-label="Alterar idioma">
                <span id="currentFlag" class="flag-icon"></span>
            </button>

            <div id="idiomaMenu" class="absolute right-0 mt-2 w-20 bg-white dark:bg-gray-700 rounded-xl shadow-2xl py-1 z-10 hidden ring-1 ring-black ring-opacity-5 origin-top-right transition-all duration-150 transform scale-95 opacity-0">
                <button class="idioma-item w-full text-center px-4 py-2 text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-600 flex items-center justify-center" data-lang="pt">
                    <span class="flag-icon flag-icon-br"></span>
                </button>
                <button class="idioma-item w-full text-center px-4 py-2 text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-600 flex items-center justify-center" data-lang="en">
                    <span class="flag-icon flag-icon-us"></span>
                </button>
                <button class="idioma-item w-full text-center px-4 py-2 text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-600 flex items-center justify-center" data-lang="es">
                    <span class="flag-icon flag-icon-es"></span>
                </button>
            </div>
        </div>
        
        <button id="btnHoje" class="p-2 px-3 rounded-xl bg-gray-200 dark:bg-gray-700 hover:scale-105 transition flex items-center justify-center font-semibold text-sm" aria-label="Voltar para o dia de hoje">
          üìÖ <span id="btnHojeText" class="ml-1 hidden sm:inline">HOJE</span>
        </button>

        <button id="btnOpenSettings" class="p-2 rounded-xl bg-gray-200 dark:bg-gray-700 hover:scale-105 transition flex items-center justify-center font-semibold text-sm" aria-label="Abrir Configura√ß√µes">
            ‚öôÔ∏è
        </button>

        <button id="btnTema" class="p-2 px-3 rounded-xl bg-gray-200 dark:bg-gray-700 hover:scale-105 transition flex items-center justify-center font-semibold text-sm" aria-label="Alternar tema">
          <span id="themeStatusText">üåô</span> </button>
      </div>
    </div>
  </header>
  
  <main class="p-4 sm:p-6 flex-1 overflow-auto">
    
    <div class="max-w-7xl mx-auto flex gap-4 text-sm font-medium border-b border-gray-200 dark:border-gray-700 pb-4 mb-4 px-1">
        <a id="linkPrivacidade" href="#" class="text-gray-600 dark:text-gray-400 hover:text-primary-500 transition">Privacidade (LGPD)</a>
        <button id="btnAbrirGlossario" class="text-gray-600 dark:text-gray-400 hover:text-primary-500 transition">Gloss√°rio / Ajuda</button>
    </div>
    
    <section id="paginaSelecao" class="pagina max-w-7xl mx-auto w-full">
      <div id="gridPlanos" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mx-auto mt-4">
        </div>
    </section>

    <section id="paginaPlano" class="pagina max-w-7xl mx-auto w-full hidden-page">
      
      <div class="px-1 mt-0">
        <div class="flex items-center justify-between mb-2">
          <div class="text-base font-semibold" id="textoProgresso">Progresso: 0 / 365</div>
          
          <div id="planInfoDisplay" class="text-sm font-medium flex flex-col items-end p-1">
            <span id="textoPlanoAtual" class="text-gray-800 dark:text-gray-100 flex items-center">Plano: Tradicional</span>
            <span id="textoDataInicio" class="text-xs text-gray-500 dark:text-gray-400 font-medium mt-0.5"></span>
          </div>

        </div>
        <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-3.5 overflow-hidden">
          <div id="progressoBar" class="bg-primary-500 h-3.5 rounded-full" style="width:0%"></div>
        </div>
      </div>
      
      <div class="mt-8">
        <h2 class="text-xl font-bold mb-4 px-1">Selecione o M√™s</h2>
        <div id="meses" class="flex gap-2 overflow-x-auto pb-3 px-1 border-b border-gray-200 dark:border-gray-700"></div>
      </div>

      <div id="dias" class="mt-6 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 xl:grid-cols-7 gap-4 px-1">
        </div>
    </section>

  </main>
  
  <div id="modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50 p-4 transition-opacity duration-300" style="opacity:0;" aria-modal="true" role="dialog">
    <div id="modalContent" class="bg-white dark:bg-gray-800 p-6 rounded-3xl w-full max-w-md shadow-2xl scale-95 transition-transform duration-300">
      <div class="flex justify-between items-start">
        <h3 id="modalTitulo" class="text-2xl font-extrabold text-primary-500"></h3>
        <button id="fecharModal" class="p-1 rounded-full text-gray-500 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition">
          <i data-lucide="x" class="lucide w-6 h-6"></i>
        </button>
      </div>

      <ul id="modalLeituras" class="modal-scroll-area mt-4 space-y-2 text-gray-700 dark:text-gray-200 border-t pt-4 border-gray-200 dark:border-gray-700"></ul>

      <div class="mt-6 flex gap-3">
        <button id="btnLido" class="flex-1 px-4 py-3 rounded-xl bg-primary-500 text-white font-semibold hover:bg-primary-600 transition shadow-lg shadow-primary-500/30">‚úî Marcar como lido</button>
        <button id="btnLerAgora" class="px-4 py-3 rounded-xl bg-blue-600 text-white font-semibold hover:bg-blue-700 transition shadow-lg shadow-blue-600/30">üìñ Ler agora</button>
      </div>
    </div>
  </div>

  <div id="settingsModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50 p-4 transition-opacity duration-300" style="opacity:0;" aria-modal="true" role="dialog">
    <div id="settingsModalContent" class="bg-white dark:bg-gray-800 p-6 rounded-3xl w-full max-w-md shadow-2xl scale-95 transition-transform duration-300">
        <div class="flex justify-between items-start mb-4">
            <h3 class="text-2xl font-extrabold text-primary-500" id="settingsModalTitle">Configura√ß√µes</h3>
            <button id="fecharSettingsModal" class="p-1 rounded-full text-gray-500 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition">
                <i data-lucide="x" class="lucide w-6 h-6"></i>
            </button>
        </div>
        
        <div class="space-y-6">
            <div>
                <label for="planDurationSelect" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Dura√ß√£o do Plano:</label>
                <select id="planDurationSelect" class="mt-1 block w-full pl-3 pr-10 py-3 text-base border-gray-300 focus:outline-none focus:ring-primary-500 focus:border-primary-500 sm:text-sm rounded-xl bg-gray-100 dark:bg-gray-700 dark:border-gray-600">
                    </select>
                <p id="durationWarning" class="mt-2 text-xs text-gray-500 dark:text-gray-400">Alterar a dura√ß√£o do plano for√ßar√° o rec√°lculo e o progresso pode ser perdido.</p>
            </div>

            <div class="flex flex-col sm:flex-row gap-3">
                <button id="btnTrocarPlano" class="flex-1 px-4 py-3 rounded-xl bg-primary-500 text-white font-semibold hover:bg-primary-600 transition shadow-lg shadow-primary-500/30">
                    Trocar Plano
                </button>
                <button id="btnResetarProgresso" class="flex-1 px-4 py-3 rounded-xl bg-red-500 text-white font-semibold hover:bg-red-600 transition shadow-lg shadow-red-500/30">
                    Resetar Progresso
                </button>
            </div>

            <div class="pt-4 border-t border-gray-200 dark:border-gray-700">
                <h4 class="text-base font-bold mb-3" id="backupRestoreTitle">Backup e Restaura√ß√£o</h4>
                <div class="flex flex-col sm:flex-row gap-3">
                    <button id="btnExport" class="flex-1 px-4 py-3 rounded-xl bg-gray-600 text-white font-semibold hover:bg-gray-700 transition">
                        Exportar Progresso (JSON)
                    </button>
                    <button id="btnImport" class="flex-1 px-4 py-3 rounded-xl bg-gray-600 text-white font-semibold hover:bg-gray-700 transition">
                        Importar Progresso
                    </button>
                </div>
            </div>
        </div>
    </div>
  </div>
  
<div id="confirmChangePlanModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50 p-4 transition-opacity duration-300" style="opacity:0;" aria-modal="true" role="dialog">
  <div id="confirmChangePlanContent" class="bg-white dark:bg-gray-800 p-6 rounded-3xl w-full max-w-sm shadow-2xl scale-95 transition-transform duration-300">
    <div class="text-center">
      <i data-lucide="alert-triangle" class="lucide w-10 h-10 text-red-500 mx-auto mb-4"></i>
      <h3 id="confirmTitle" class="text-xl font-extrabold text-gray-900 dark:text-gray-100 mb-2">Aten√ß√£o!</h3>
      <p id="confirmMessage" class="text-gray-600 dark:text-gray-400 mb-6">Trocar de plano ir√° **apagar todo o seu progresso atual** (dias marcados e data de in√≠cio). Deseja continuar?</p>
      
      <div class="flex gap-3">
        <button id="btnCancelChangePlan" class="flex-1 px-4 py-3 rounded-xl bg-gray-300 dark:bg-gray-700 text-gray-700 dark:text-gray-300 font-semibold hover:bg-gray-400 dark:hover:bg-gray-600 transition">
          Cancelar
        </button>
        <button id="btnConfirmChangePlan" class="flex-1 px-4 py-3 rounded-xl bg-red-500 text-white font-semibold hover:bg-red-600 transition shadow-lg shadow-red-500/30">
          Sim, Apagar Hist√≥rico
        </button>
      </div>
    </div>
  </div>
</div>

<div id="privacyModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50 p-4 transition-opacity duration-300" style="opacity:0;" aria-modal="true" role="dialog">
    <div id="privacyModalContent" class="bg-white dark:bg-gray-800 p-6 rounded-3xl w-full max-w-lg shadow-2xl scale-95 transition-transform duration-300 max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-start mb-4">
            <h3 class="text-2xl font-extrabold text-primary-500" id="privacyModalTitle"></h3>
            <button id="fecharPrivacyModal" class="p-1 rounded-full text-gray-500 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition">
                <i data-lucide="x" class="lucide w-6 h-6"></i>
            </button>
        </div>
        
        <div id="privacyContentArea" class="space-y-4 text-gray-700 dark:text-gray-300">
            </div>
    </div>
</div>

<div id="glossaryModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50 p-4 transition-opacity duration-300" style="opacity:0;" aria-modal="true" role="dialog">
    <div id="glossaryModalContent" class="bg-white dark:bg-gray-800 p-6 rounded-3xl w-full max-w-lg shadow-2xl scale-95 transition-transform duration-300 max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-start mb-4">
            <h3 class="text-2xl font-extrabold text-primary-500" id="glossaryModalTitle"></h3>
            <button id="fecharGlossaryModal" class="p-1 rounded-full text-gray-500 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition">
                <i data-lucide="x" class="lucide w-6 h-6"></i>
            </button>
        </div>
        
        <div id="glossaryContentArea" class="space-y-4 text-gray-700 dark:text-gray-300">
            </div>
    </div>
</div>

  <footer class="mt-12 py-6 border-t border-gray-200 dark:border-gray-700 text-center text-sm text-gray-600 dark:text-gray-400">
    <p class="italic">¬© 2025 Alex Silva. Uso livre com atribui√ß√£o.</p>
  </footer>

  <script>
  
  // ---------- CONFIG / TEXTS ----------
  // NOVO: DURA√á√ïES V√ÅLIDAS EM DIAS (REMOVIDO '30')
  const DURATIONS = [365, 180, 90]; 
  
  const UI_TEXT = {
    pt: {
      titulo: 'Plano B√≠blico',
      subtitulo: 'Acompanhe seu progresso',
      titulo_selecao: 'Plano B√≠blico',
      subtitulo_selecao: 'Selecione seu plano.',
      link_trocar: 'Trocar Plano',
      ler_agora: 'Ler agora',
      planos: [
        { id: 'tradicional', title: 'Tradicional', desc: 'G√™nesis ‚Üí Apocalipse (padr√£o)' },
        { id: 'cronologico', title: 'Cronol√≥gico', desc: 'Ordem hist√≥rica aproximada' },
        { id: 'atnt', title: 'AT + NT', desc: 'Um trecho do AT e um do NT por dia' },
        { id: 'jesus', title: 'Um Ano com Jesus', desc: 'Evangelhos ‚Üí Atos ‚Üí Cartas ‚Üí Resto' },
        { id: 'umcap', title: '1 Cap√≠tulo/Dia', desc: '1 cap√≠tulo por dia (365 sele√ß√µes)' },
        { id: 'salmos', title: 'AT+NT+Salmos', desc: 'AT + NT + Salmo/Prov√©rbio di√°rio' }
      ],
      start: 'Dia de Leitura',
      marcar: '‚úî Marcar como lido',
      fechar: 'Fechar',
      progresso: 'Progresso',
      plano: 'Plano',
      dia_leitura: 'Dia',
      lang_name: 'Portugu√™s',
      flag_code: 'br',
      hoje: 'HOJE',
      lido: 'Leitura Conclu√≠da',
      nao_lido: 'Marcar como lido',
      
      // TRADU√á√ÉO: Textos para Atraso/Adiantamento
      delayed: 'Atrasado',
      ahead: 'Adiantado',
      days_behind: ' dias',
      days_ahead: ' dias',
      
      // NOVO: Textos para Configura√ß√µes
      settings: 'Configura√ß√µes',
      duration_label: 'Dura√ß√£o do Plano:',
      duration_options: { 365: '1 Ano (365 Dias)', 180: '6 Meses (180 Dias)', 90: '3 Meses (90 Dias)' },
      reset_progress: 'Resetar Progresso',
      backup_restore: 'Backup e Restaura√ß√£o',
      export_progress: 'Exportar Progresso (JSON)',
      import_progress: 'Importar Progresso',
      alert_reset: 'Tem certeza de que deseja resetar todo o seu progresso no plano atual?',
      alert_import_success: 'Progresso importado com sucesso! Recarregando...',
      alert_import_error: 'Erro ao importar. O arquivo pode estar corrompido ou em formato inv√°lido.',
      alert_duration_change: 'Aten√ß√£o: Alterar a dura√ß√£o recalcula o plano. O progresso marcado APENAS para os dias existentes no NOVO plano ser√° mantido.',
      start_date_label: 'In√≠cio',
      // Textos para o Modal Customizado
      alert_title: 'Aten√ß√£o!', 
      alert_change_plan: 'Aten√ß√£o! Trocar de plano ir√° APAGAR todo o seu progresso atual (dias marcados e data de in√≠cio). Deseja continuar?',
      alert_change_plan_html: 'Trocar de plano ir√° **apagar todo o seu progresso atual** (dias marcados e data de in√≠cio). Deseja continuar?', 
      cancel: 'Cancelar', 
      confirm_erase: 'Sim, Apagar Hist√≥rico', 
      
      // NOVO: Textos para Links Adicionais
      privacy_link: 'Privacidade (LGPD)',
      glossary_link: 'Gloss√°rio / Ajuda',

      // NOVO: Textos de Privacidade
      privacy_title: 'Privacidade (LGPD)',
      privacy_p1: 'Nenhum dado √© enviado, armazenado ou acessado por servidores externos ou pelo desenvolvedor. O √∫nico armazenamento ocorre localmente no seu dispositivo (se voc√™ usar a fun√ß√£o \'Exportar Progresso JSON\').',
      
      // NOVO: Textos para Bot√£o de Iniciar/Ver Plano
      start_plan_button: 'Come√ßar Plano', // NOVO
      active_plan: 'Plano Ativo', // NOVO
      view_plan: 'Ver Plano', // NOVO
      
      // NOVO: Textos do Gloss√°rio (Movidos do HTML)
      glossary_title: 'Gloss√°rio / Ajuda',
      glossary_features_title: 'Funcionalidades Principais',
      glossary_features: [
          { icon: 'calendar', text: '<strong>Plano Ativo (C√≠rculo Azul)</strong>: Indica o plano de leitura que est√° em uso no momento.' },
          { icon: 'üìÖ', text: '<strong>Bot√£o HOJE</strong>: Redireciona rapidamente a visualiza√ß√£o para o m√™s e dia da leitura que deveria ser feita hoje.' },
          { icon: '‚öôÔ∏è', text: '<strong>Configura√ß√µes</strong>: Permite alterar a dura√ß√£o do plano (1 ano, 6 meses, 3 meses), resetar o progresso ou trocar de plano.' },
          { icon: 'üìñ', text: '<strong>Bot√£o "Ler agora"</strong>: Abre os vers√≠culos de leitura em uma nova aba no Bible Gateway, na vers√£o (NVI-PT/NIV) correspondente ao idioma da aplica√ß√£o.' }
      ],
      glossary_icons_title: '√çcones nos Dias de Leitura',
      glossary_icons: [
          { icon: 'check-circle', text: '<strong>Dia Conclu√≠do</strong>: O dia foi marcado como lido (fundo cinza claro e √≠cone vermelho).' },
          { icon: 'chevrons-right', text: '<strong>Dia N√£o Lido (Pendente)</strong>: Leitura ainda n√£o marcada como lida.' },
          { icon: 'star', text: '<strong>Dia Atual/Em Dia (Borda Azul Grossa)</strong>: Marca o dia de leitura esperado (o dia que voc√™ est√° hoje no plano).' },
          { icon: 'üìä', text: '<strong>Status de Acompanhamento</strong>: Textos como "Atrasado (X dias)" ou "Adiantado (Y dias)" aparecem se houver uma data de in√≠cio definida, indicando sua posi√ß√£o em rela√ß√£o ao progresso esperado.' }
      ]
    },
    en: {
        titulo: 'Bible Plan',
        subtitulo: 'Track your progress',
        titulo_selecao: 'Bible Plan',
        subtitulo_selecao: 'Select your plan.',
        link_trocar: 'Change Plan',
        ler_agora: 'Read now',
        planos: [
          { id: 'tradicional', title: 'Traditional', desc: 'Genesis ‚Üí Revelation (standard)' },
          { id: 'cronologico', title: 'Chronological', desc: 'Approx. historical order' },
          { id: 'atnt', title: 'OT + NT', desc: 'OT + NT passage per day' },
          { id: 'jesus', title: 'One Year with Jesus', desc: 'Gospels ‚Üí Acts ‚Üí Letters ‚Üí Rest' },
          { id: 'umcap', title: '1 Chapter/Day', desc: '1 chapter per day (365 picks)' },
          { id: 'salmos', title: 'OT+NT+Psalms', desc: 'OT + NT + Psalm/Proverb daily' }
        ],
        start: 'Reading Day',
        marcar: '‚úî Mark as read',
        fechar: 'Close',
        progresso: 'Progress',
        plano: 'Plan',
        dia_leitura: 'Day',
        lang_name: 'English',
        flag_code: 'us',
        hoje: 'TODAY',
        lido: 'Reading Completed',
        nao_lido: 'Mark as read',
        
        // TRADU√á√ÉO: Textos para Atraso/Adiantamento
        delayed: 'Behind',
        ahead: 'Ahead',
        days_behind: ' days',
        days_ahead: ' days',
        
        // NOVO: Textos para Configura√ß√µes
        settings: 'Settings',
        duration_label: 'Plan Duration:',
        duration_options: { 365: '1 Year (365 Days)', 180: '6 Months (180 Days)', 90: '3 Months (90 Days)' },
        reset_progress: 'Reset Progress',
        backup_restore: 'Backup & Restore',
        export_progress: 'Export Progress (JSON)',
        import_progress: 'Import Progress',
        alert_reset: 'Are you sure you want to reset all your progress for the current plan?',
        alert_import_success: 'Progress successfully imported! Reloading...',
        alert_import_error: 'Import error. The file may be corrupted or in an invalid format.',
        alert_duration_change: 'Warning: Changing the duration recalculates the plan. Progress marked ONLY for existing days in the NEW plan will be kept.',
        start_date_label: 'Start Date',
        // Textos para o Modal Customizado
        alert_title: 'Warning!',
        alert_change_plan: 'Warning! Changing plans will ERASE all your current progress (marked days and start date). Do you wish to continue?',
        alert_change_plan_html: 'Warning! Changing plans will **ERASE all your current progress** (marked days and start date). Do you wish to continue?',
        cancel: 'Cancel',
        confirm_erase: 'Yes, Erase History',

        // NOVO: Textos para Links Adicionais
        privacy_link: 'Privacy (LGPD)',
        glossary_link: 'Glossary / Help',
        
        // NOVO: Textos de Privacidade
        privacy_title: 'Privacy (LGPD)',
        privacy_p1: 'No data is sent, stored, or accessed by external servers or the developer. The only storage occurs locally on your device (if you use the \'Export Progress JSON\' function).',

        // NOVO: Textos para Bot√£o de Iniciar/Ver Plano
        start_plan_button: 'Start Plan', // NOVO
        active_plan: 'Active Plan', // NOVO
        view_plan: 'View Plan', // NOVO

        // NOVO: Textos do Gloss√°rio (Movidos do HTML)
        glossary_title: 'Glossary / Help',
        glossary_features_title: 'Key Features',
        glossary_features: [
            { icon: 'calendar', text: '<strong>Active Plan (Blue Circle)</strong>: Indicates the reading plan currently in use.' },
            { icon: 'üìÖ', text: '<strong>TODAY Button</strong>: Quickly redirects the view to the month and day of the reading that should be done today.' },
            { icon: '‚öôÔ∏è', text: '<strong>Settings</strong>: Allows changing the plan duration (1 year, 6 months, 3 months), resetting progress, or changing the plan.' },
            { icon: 'üìñ', text: '<strong>"Read now" Button</strong>: Opens the reading verses in a new tab on Bible Gateway, in the version (NIV) corresponding to the application language.' }
        ],
        glossary_icons_title: 'Icons on Reading Days',
        glossary_icons: [
            { icon: 'check-circle', text: '<strong>Day Completed</strong>: The day has been marked as read (light gray background and red icon).' },
            { icon: 'chevrons-right', text: '<strong>Day Not Read (Pending)</strong>: Reading not yet marked as read.' },
            { icon: 'star', text: '<strong>Current/On Schedule Day (Thick Blue Border)</strong>: Marks the expected reading day (the day you are on in the plan today).' },
            { icon: 'üìä', text: '<strong>Tracking Status</strong>: Texts like "Behind (X days)" or "Ahead (Y days)" appear if a start date is defined, indicating your position relative to the expected progress.' }
        ]
    },
    es: {
        titulo: 'Plan B√≠blico',
        subtitulo: 'Sigue tu progreso',
        titulo_selecao: 'Plan B√≠blico',
        subtitulo_selecao: 'Selecciona tu plan.',
        link_trocar: 'Cambiar Plan',
        ler_agora: 'Leer ahora',
        planos: [
          { id: 'tradicional', title: 'Tradicional', desc: 'G√©nesis ‚Üí Apocalipsis (est√°ndar)' },
          { id: 'cronologico', title: 'Cronol√≥gico', desc: 'Orden hist√≥rico aproximado' },
          { id: 'atnt', title: 'AT + NT', desc: 'Pasaje de AT y NT por d√≠a' },
          { id: 'jesus', title: 'Un A√±o con Jes√∫s', desc: 'Gospels ‚Üí Acts ‚Üí Letters ‚Üí Rest' },
          { id: 'umcap', title: '1 Cap√≠tulo/D√≠a', desc: '1 cap√≠tulo por d√≠a (365 selecciones)' },
          { id: 'salmos', title: 'AT+NT+Salmos', desc: 'AT + NT + Salmo/Proverbio diario' }
        ],
        start: 'D√≠a de Lectura',
        marcar: '‚úî Marcar como le√≠do',
        fechar: 'Cerrar',
        progresso: 'Progreso',
        plano: 'Plan',
        dia_leitura: 'Day',
        lang_name: 'Espa√±ol',
        flag_code: 'es',
        hoje: 'HOY',
        lido: 'Lectura Completada',
        nao_lido: 'Marcar como le√≠do',

        // TRADU√á√ÉO: Textos para Atraso/Adiantamento
        delayed: 'Atrasado',
        ahead: 'Adelantado',
        days_behind: ' d√≠as',
        days_ahead: ' d√≠as',
        
        // NOVO: Textos para Configura√ß√µes
        settings: 'Ajustes',
        duration_label: 'Duraci√≥n del Plan:',
        duration_options: { 365: '1 A√±o (365 D√≠as)', 180: '6 Meses (180 D√≠as)', 90: '3 Meses (90 D√≠as)' },
        reset_progress: 'Restablecer Progreso',
        backup_restore: 'Copia de Seguridad y Restauraci√≥n',
        export_progress: 'Exportar Progreso (JSON)',
        import_progress: 'Importar Progreso',
        alert_reset: '¬øEst√°s seguro de que deseas restablecer todo tu progreso para el plan actual?',
        alert_import_success: 'Progreso importado con √©xito. Recargando...',
        alert_import_error: 'Error al importar. El archivo puede estar corrupto o en formato no v√°lido.',
        alert_duration_change: 'Advertencia: Cambiar la duraci√≥n recalcula el plan. El progreso marcado S√ìLO para los d√≠as existentes en el NUEVO plan se mantendr√°.',
        start_date_label: 'Fecha de Inicio',
        // Textos para el Modal Customizado
        alert_title: '¬°Advertencia!',
        alert_change_plan: '¬°Advertencia! Cambiar de plan BORRAR√Å todo su progreso actual (d√≠as marcados y fecha de inicio). ¬øDesea continuar?',
        alert_change_plan_html: '¬°Advertencia! Cambiar de plan **BORRAR√Å todo su progreso actual** (d√≠as marcados y fecha de inicio). ¬øDesea continuar?',
        cancel: 'Cancelar',
        confirm_erase: 'S√≠, Borrar Historial',
        
        // NOVO: Textos para Links Adicionais
        privacy_link: 'Privacidad (LGPD)',
        glossary_link: 'Glosario / Ayuda',

        // NOVO: Textos de Privacidade
        privacy_title: 'Privacidad (LGPD)',
        privacy_p1: 'Ning√∫n dato es enviado, almacenado o accedido por servidores externos o por el desarrollador. El √∫nico almacenamiento ocurre localmente en su dispositivo (si usa la funci√≥n \'Exportar Progreso JSON\').',
        
        // NOVO: Textos para Bot√£o de Iniciar/Ver Plano
        start_plan_button: 'Empezar Plan', // NOVO
        active_plan: 'Plan Activo', // NOVO
        view_plan: 'Ver Plan', // NOVO

        // NOVO: Textos do Gloss√°rio (Movidos do HTML)
        glossary_title: 'Glosario / Ayuda',
        glossary_features_title: 'Caracter√≠sticas Principales',
        glossary_features: [
            { icon: 'calendar', text: '<strong>Plan Activo (C√≠rculo Azul)</strong>: Indica el plan de lectura que est√° en uso actualmente.' },
            { icon: 'üìÖ', text: '<strong>Bot√≥n HOY</strong>: Redirige r√°pidamente la vista al mes y d√≠a de la lectura que deber√≠a hacerse hoy.' },
            { icon: '‚öôÔ∏è', text: '<strong>Ajustes</strong>: Permite cambiar la duraci√≥n del plan (1 a√±o, 6 meses, 3 meses), restablecer el progreso o cambiar de plan.' },
            { icon: 'üìñ', text: '<strong>"Leer ahora" Bot√≥n</strong>: Abre los vers√≠culos de lectura en una nueva pesta√±a en Bible Gateway, en la versi√≥n (NVI-ES/NIV) correspondiente al idioma de la aplicaci√≥n.' }
        ],
        glossary_icons_title: 'Iconos en los D√≠as de Lectura',
        glossary_icons: [
            { icon: 'check-circle', text: '<strong>D√≠a Completado</strong>: El d√≠a ha sido marcado como le√≠do (fondo gris claro e icono rojo).' },
            { icon: 'chevrons-right', text: '<strong>D√≠a No Le√≠do (Pendiente)</strong>: Lectura a√∫n no marcada como le√≠da.' },
            { icon: 'star', text: '<strong>D√≠a Actual/Al D√≠a (Borde Azul Grueso)</strong>: Marca el d√≠a de lectura esperado (el d√≠a en que se encuentra hoy en el plan).' },
            { icon: 'üìä', text: '<strong>Estado de Seguimiento</strong>: Textos como "Atrasado (X d√≠as)" ou "Adelantado (Y d√≠as)" aparecem si hay una fecha de inicio definida, indicando su posici√≥n relativa al progreso esperado.' }
        ]
    }
  };
  
  // (Constantes de Meses, Livros e Ordem Cronol√≥gica - MANTIDAS)
  const MONTHS = {
    pt: ["Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set","Out","Nov","Dez"],
    en: ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],
    es: ["Ene","Feb","Mar","Abr","Mai","Jun","Jul","Ago","Sep","Oct","Nov","Dic"]
  };
  const DAYS_PER_MONTH = [31,28,31,30,31,30,31,31,30,31,30,31];
  const BOOKS = [
    { key:'Genesis', ch:50, name:{pt:'G√™nesis', en:'Genesis', es:'G√©nesis'} },
    { key:'Exodus', ch:40, name:{pt:'√äxodo', en:'Exodus', es:'√âxodo'} },
    { key:'Leviticus', ch:27, name:{pt:'Lev√≠tico', en:'Leviticus', es:'Leviticus'} },
    { key:'Numbers', ch:36, name:{pt:'N√∫meros', en:'Numbers', es:'N√∫meros'} },
    { key:'Deuteronomy', ch:34, name:{pt:'Deuteron√¥mio', en:'Deuteronomy', es:'Deuteronomio'} },
    { key:'Joshua', ch:24, name:{pt:'Josu√©', en:'Joshua', es:'Josu√©'} },
    { key:'Judges', ch:21, name:{pt:'Ju√≠zes', en:'Judges', es:'Jueces'} },
    { key:'Ruth', ch:4, name:{pt:'Rute', en:'Ruth', es:'Rut'} },
    { key:'1 Samuel', ch:31, name:{pt:'1 Samuel', en:'1 Samuel', es:'1 Samuel'} },
    { key:'2 Samuel', ch:24, name:{pt:'2 Samuel', en:'2 Samuel', es:'2 Samuel'} },
    { key:'1 Kings', ch:22, name:{pt:'1 Reis', en:'1 Kings', es:'1 Reyes'} },
    { key:'2 Kings', ch:25, name:{pt:'2 Reis', en:'2 Kings', es:'2 Reyes'} },
    { key:'1 Chronicles', ch:29, name:{pt:'1 Cr√¥nicas', en:'1 Chronicles', es:'1 Cr√≥nicas'} },
    { key:'2 Chronicles', ch:36, name:{pt:'2 Cr√¥nicas', en:'2 Chronicles', es:'2 Cr√≥nicas'} },
    { key:'Ezra', ch:10, name:{pt:'Esdras', en:'Ezra', es:'Esdras'} },
    { key:'Nehemiah', ch:13, name:{pt:'Neemias', en:'Nehemiah', es:'Nehem√≠as'} },
    { key:'Esther', ch:10, name:{pt:'Ester', en:'Esther', es:'Ester'} },
    { key:'Job', ch:42, name:{pt:'J√≥', en:'Job', es:'Job'} },
    { key:'Psalms', ch:150, name:{pt:'Salmos', en:'Psalms', es:'Salmos'} },
    { key:'Proverbs', ch:31, name:{pt:'Prov√©rbios', en:'Proverbs', es:'Proverbios'} },
    { key:'Ecclesiastes', ch:12, name:{pt:'Eclesiastes', en:'Ecclesiastes', es:'Eclesiast√©s'} },
    { key:'Song of Solomon', ch:8, name:{pt:'C√¢nticos', en:'Song of Solomon', es:'Cantar de los Cantares'} },
    { key:'Isaiah', ch:66, name:{pt:'Isa√≠as', en:'Isaiah', es:'Isa√≠as'} },
    { key:'Jeremiah', ch:52, name:{pt:'Jeremias', en:'Jeremiah', es:'Jerem√≠as'} },
    { key:'Lamentations', ch:5, name:{pt:'Lamenta√ß√µes', en:'Lamentations', es:'Lamentaciones'} },
    { key:'Ezekiel', ch:48, name:{pt:'Ezequiel', en:'Ezekiel', es:'Ezequiel'} },
    { key:'Daniel', ch:12, name:{pt:'Daniel', en:'Daniel', es:'Daniel'} },
    { key:'Hosea', ch:14, name:{pt:'Os√©ias', en:'Hosea', es:'Oseas'} },
    { key:'Joel', ch:3, name:{pt:'Joel', en:'Joel', es:'Joel'} },
    { key:'Amos', ch:9, name:{pt:'Am√≥s', en:'Amos', es:'Am√≥s'} },
    { key:'Obadiah', ch:1, name:{pt:'Obadias', en:'Obadiah', es:'Abd√≠as'} },
    { key:'Jonah', ch:4, name:{pt:'Jonas', en:'Jonah', es:'Jon√°s'} },
    { key:'Micah', ch:7, name:{pt:'Miqu√©ias', en:'Micah', es:'Miqueas'} },
    { key:'Nahum', ch:3, name:{pt:'Naum', en:'Nahum', es:'Nah√∫m'} },
    { key:'Habakkuk', ch:3, name:{pt:'Habacuque', en:'Habakkuk', es:'Habacuc'} },
    { key:'Zephaniah', ch:3, name:{pt:'Sofonias', en:'Zephaniah', es:'Sofon√≠as'} },
    { key:'Haggai', ch:2, name:{pt:'Ageu', en:'Haggai', es:'Hageo'} },
    { key:'Zechariah', ch:14, name:{pt:'Zacarias', en:'Zechariah', es:'Zacar√≠as'} },
    { key:'Malachi', ch:4, name:{pt:'Malaquias', en:'Malachi', es:'Malaqu√≠as'} },
    { key:'Matthew', ch:28, name:{pt:'Mateus', en:'Matthew', es:'Mateo'} },
    { key:'Mark', ch:16, name:{pt:'Marcos', en:'Mark', es:'Marcos'} },
    { key:'Luke', ch:24, name:{pt:'Lucas', en:'Luke', es:'Lucas'} },
    { key:'John', ch:21, name:{pt:'Jo√£o', en:'John', es:'Juan'} },
    { key:'Acts', ch:28, name:{pt:'Atos', en:'Acts', es:'Hechos'} },
    { key:'Romans', ch:16, name:{pt:'Romanos', en:'Romans', es:'Romanos'} },
    { key:'1 Corinthians', ch:16, name:{pt:'1 Cor√≠ntios', en:'1 Corinthians', es:'1 Corintios'} },
    { key:'2 Corinthians', ch:13, name:{pt:'2 Cor√≠ntios', en:'2 Corinthians', es:'2 Corintios'} },
    { key:'Galatians', ch:6, name:{pt:'G√°latas', en:'Galatians', es:'G√°latas'} },
    { key:'Ephesians', ch:6, name:{pt:'Ef√©sios', en:'Ephesians', es:'Efesios'} },
    { key:'Philippians', ch:4, name:{pt:'Filipenses', en:'Philippians', es:'Filipenses'} },
    { key:'Colossians', ch:4, name:{pt:'Colossenses', en:'Colossians', es:'Colosenses'} },
    { key:'1 Thessalonians', ch:5, name:{pt:'1 Tessalonicenses', en:'1 Thessalonians', es:'1 Tesalonicenses'} },
    { key:'2 Thessalonians', ch:3, name:{pt:'2 Tessalonicenses', en:'2 Thessalonians', es:'2 Tesalonicenses'} },
    { key:'1 Timothy', ch:6, name:{pt:'1 Tim√≥teo', en:'1 Timothy', es:'1 Timoteo'} },
    { key:'2 Timothy', ch:4, name:{pt:'2 Tim√≥teo', en:'2 Timothy', es:'2 Timoteo'} },
    { key:'Titus', ch:3, name:{pt:'Tito', en:'Titus', es:'Tito'} },
    { key:'Philemon', ch:1, name:{pt:'Filemom', en:'Philemon', es:'Filem√≥n'} },
    { key:'Hebrews', ch:13, name:{pt:'Hebreus', en:'Hebrews', es:'Hebreos'} },
    { key:'James', ch:5, name:{pt:'Tiago', en:'James', es:'Santiago'} },
    { key:'1 Peter', ch:5, name:{pt:'1 Pedro', en:'1 Peter', es:'1 Pedro'} },
    { key:'2 Peter', ch:3, name:{pt:'2 Pedro', en:'2 Peter', es:'2 Pedro'} },
    { key:'1 John', ch:5, name:{pt:'1 Jo√£o', en:'1 John', es:'1 Juan'} },
    { key:'2 John', ch:1, name:{pt:'2 Jo√£o', en:'2 John', es:'2 Juan'} },
    { key:'3 John', ch:1, name:{pt:'3 Jo√£o', en:'3 John', es:'3 Juan'} },
    { key:'Jude', ch:1, name:{pt:'Judas', en:'Jude', es:'Judas'} },
    { key:'Revelation', ch:22, name:{pt:'Apocalipse', en:'Revelation', es:'Apocalipsis'} }
  ];

  const FLAT = [];
  (function buildFlat(){
    for(const b of BOOKS){
      for(let c=1;c<=b.ch;c++) FLAT.push({ bookKey: b.key, chapter: c });
    }
  })();

  function bookName(bookKey, lang){
    const b = BOOKS.find(x=>x.key===bookKey);
    return b ? (b.name[lang] || b.name.pt) : bookKey;
  }
  
  function formatRefObj(obj, lang){
    return `${bookName(obj.bookKey, lang)} ${obj.chapter}`;
  }

  const CHRON_ORDER_KEYS = [
    'Genesis','Job','Exodus','Leviticus','Numbers','Deuteronomy','Joshua','Judges','Ruth',
    '1 Samuel','2 Samuel','Psalms','Proverbs','Ecclesiastes','Song of Solomon',
    '1 Kings','2 Kings','1 Chronicles','2 Chronicles','Obadiah','Joel','Jonah','Amos','Hosea',
    'Isaiah','Micah','Nahum','Zephaniah','Habakkuk','Jeremiah','Lamentations','Ezekiel','Daniel',
    'Ezra','Nehemiah','Esther','Haggai','Zechariah','Malachi',
    'Matthew','Mark','Luke','John','Acts','Romans','1 Corinthians','2 Corinthians','Galatians',
    'Ephesians','Philippians','Colossians','1 Thessalonians','2 Thessalonians','1 Timothy','2 Timothy',
    'Titus','Philemon','Hebrews','James','1 Peter','2 Peter','1 John','2 John','3 John','Jude','Revelation'
  ];

  const OT_BOOKS = [
    'Genesis', 'Exodus', 'Leviticus', 'Numbers', 'Deuteronomy', 'Joshua', 'Judges', 'Ruth',
    '1 Samuel', '2 Samuel', '1 Kings', '2 Kings', '1 Chronicles', '2 Chronicles', 'Ezra',
    'Nehemiah', 'Esther', 'Job', 'Psalms', 'Proverbs', 'Ecclesiastes', 'Song of Solomon',
    'Isaiah', 'Jeremiah', 'Lamentations', 'Ezekiel', 'Daniel', 'Hosea', 'Joel', 'Amos',
    'Obadiah', 'Jonah', 'Micah', 'Nahum', 'Habakkuk', 'Zephaniah', 'Haggai', 'Zechariah', 'Malachi'
  ];
  const NT_BOOKS = [
    'Matthew', 'Mark', 'Luke', 'John', 'Acts', 'Romans', '1 Corinthians', '2 Corinthians',
    'Galatians', 'Ephesians', 'Philippians', 'Colossians', '1 Thessalonians', '2 Thessalonians',
    '1 Timothy', '2 Timothy', 'Titus', 'Philemon', 'Hebrews', 'James', '1 Peter', '2 Peter',
    '1 John', '2 John', '3 John', 'Jude', 'Revelation'
  ];

  // ---------- STATE / LOCAL STORAGE ----------
  const state = {
    idioma: localStorage.getItem('bib_idioma') || 'pt',
    planoId: localStorage.getItem('bib_plano') || null,
    planDuration: parseInt(localStorage.getItem('bib_duration')) || 365, // NOVO: Dura√ß√£o do plano (365, 180, 90)
    selectedMonth: new Date().getMonth() + 1, // 1 a 12
    planStartDate: localStorage.getItem('bib_start_date') || null,
    pendingPlanoId: null // Mantido para o modal de confirma√ß√£o
  };

  let CACHE = {};

  // ---------- PLAN GENERATION LOGIC ----------
  // (Fun√ß√µes de Gera√ß√£o de Plano - MANTIDAS)
  
  function getPlan(planId, lang){
    const cacheKey = `${planId}_${lang}_${state.planDuration}`;
    if(CACHE[cacheKey]) return CACHE[cacheKey];
    
    let plan = [];
    const duration = state.planDuration;

    switch(planId){
      case 'tradicional': plan = genTraditional(lang, duration); break;
      case 'cronologico': plan = genChronological(lang, duration); break;
      case 'atnt': plan = genOTNT(lang, duration); break;
      case 'jesus': plan = genJesusYear(lang, duration); break;
      case 'umcap': plan = genUmCapitulo(lang, duration); break;
      case 'salmos': plan = genOTNTandPsalms(lang, duration); break;
      default: plan = genTraditional(lang, duration);
    }
    
    // Garantir que o plano tenha a dura√ß√£o correta (embora a l√≥gica acima deva garantir)
    if (plan.length > duration) plan = plan.slice(0, duration);
    else if (plan.length < duration) {
        // Preenche com dias vazios se for menor (caso de plano personalizado)
        while (plan.length < duration) plan.push(['‚Äî']);
    }

    CACHE[cacheKey] = plan;
    return plan;
  }
  
  function genTraditional(lang, duration){
    const total = FLAT.length;
    const perDay = total/duration;
    const plan = Array.from({length:duration},()=>[]);
    let idx=0;
    for(let d=0; d<duration; d++){
      const take = Math.max(1, Math.round(perDay * (d+1)) - idx);
      for(let t=0;t<take && idx<total;t++,idx++) plan[d].push(formatRefObj(FLAT[idx], lang));
    }
    while(idx<total) plan[plan.length-1].push(formatRefObj(FLAT[idx++], lang));
    return plan;
  }

  function genChronological(lang, duration){
    const arr = [];
    for(const key of CHRON_ORDER_KEYS){
      const book = BOOKS.find(b=>b.key===key);
      if(!book) continue;
      for(let c=1;c<=book.ch;c++) arr.push({bookKey: book.key, chapter:c});
    }
    const total = arr.length;
    const perDay = total/duration;
    const plan = Array.from({length:duration},()=>[]);
    let idx=0;
    for(let d=0; d<duration; d++){
      const take = Math.max(1, Math.round(perDay * (d+1)) - idx);
      for(let t=0;t<take && idx<total;t++,idx++) plan[d].push(formatRefObj(arr[idx], lang));
    }
    while(idx<total) plan[plan.length-1].push(formatRefObj(arr[idx++], lang));
    return plan;
  }

  function genOTNT(lang, duration){
    const ot = FLAT.filter(x=>OT_BOOKS.includes(x.bookKey));
    const nt = FLAT.filter(x=>NT_BOOKS.includes(x.bookKey));
    const otTotal = ot.length;
    const ntTotal = nt.length;
    
    const otPerDay = otTotal/duration;
    const ntPerDay = ntTotal/duration;

    const plan = Array.from({length:duration},()=>[]);
    let i=0, j=0; // √çndices para OT e NT

    for(let d=0; d<duration; d++){
        // Calcula quantos cap√≠tulos de OT e NT devem ser lidos at√© este dia
        const targetOt = Math.round(otPerDay * (d+1));
        const targetNt = Math.round(ntPerDay * (d+1));

        // Determina quantos cap√≠tulos LER hoje (usando Math.max para garantir pelo menos 1 se o √≠ndice estiver atrasado)
        const takeOT = Math.max(1, targetOt - i);
        const takeNT = Math.max(1, targetNt - j);

        // Distribui a leitura de OT
        for(let t=0; t<takeOT && i<otTotal; t++, i++) {
            plan[d].push(formatRefObj(ot[i], lang));
        }

        // Distribui a leitura de NT
        for(let t=0; t<takeNT && j<ntTotal; t++, j++) {
            plan[d].push(formatRefObj(nt[j], lang));
        }
        
        // Se o dia ficou vazio (por exemplo, um dia sem leitura calculada), assegura que ele n√£o fique vazio.
        if (plan[d].length === 0 && (i < otTotal || j < ntTotal)) {
            if (i < otTotal) plan[d].push(formatRefObj(ot[i++], lang));
            if (j < ntTotal) plan[d].push(formatRefObj(nt[j++], lang));
        }
    }
    
    // Se sobrar algo (no √∫ltimo dia devido a arredondamentos), adiciona ao √∫ltimo dia
    while(i<otTotal) plan[plan.length-1].push(formatRefObj(ot[i++], lang));
    while(j<ntTotal) plan[plan.length-1].push(formatRefObj(nt[j++], lang));

    return plan;
  }

  function genJesusYear(lang, duration){
    const order = ['Matthew','Mark','Luke','John','Acts','Romans','1 Corinthians','2 Corinthians','Galatians','Ephesians','Philippians','Colossians','1 Thessalonians','2 Thessalonians','1 Timothy','2 Timothy','Titus','Philemon','Hebrews','James','1 Peter','2 Peter','1 John','2 John','3 John','3 John','Jude','Revelation'];
    const arr = [];
    
    // 1. NT em ordem de prioridade
    for(const name of order){
      const book = BOOKS.find(b=>b.key===name);
      if(!book) continue;
      for(let c=1;c<=book.ch;c++) arr.push({bookKey: book.key, chapter:c});
    }

    // 2. O restante do AT em ordem can√¥nica (para completar 365/duration)
    for(const b of BOOKS) if(!order.includes(b.key)) for(let c=1;c<=b.ch;c++) arr.push({bookKey: b.key, chapter:c});
    
    const total = arr.length;
    const perDay = total/duration;
    const plan = Array.from({length:duration},()=>[]);
    let idx=0;
    
    for(let d=0; d<duration; d++){
      const take = Math.max(1, Math.round(perDay * (d+1)) - idx);
      for(let t=0;t<take && idx<total;t++,idx++) plan[d].push(formatRefObj(arr[idx], lang));
    }
    
    while(idx<total) plan[plan.length-1].push(formatRefObj(arr[idx++], lang));
    return plan;
  }

  function genUmCapitulo(lang, duration){
    const plan = Array.from({length:duration},()=>[]);
    
    // Cria um array de 365 sele√ß√µes (uma por dia)
    const selection = FLAT.slice(0, 365);
    
    for(let i=0; i<duration; i++){
        const dayIndex = i % 365; // Repete a sele√ß√£o se duration > 365 (embora DURATIONS seja <= 365)
        if(dayIndex < selection.length) {
            plan[i].push(formatRefObj(selection[dayIndex], lang));
        } else {
            plan[i].push('‚Äî'); // N√£o deve acontecer com duration <= 365
        }
    }
    return plan;
  }
  
  function genOTNTandPsalms(lang, duration){
    const ot_all = FLAT.filter(x=>OT_BOOKS.includes(x.bookKey) && x.bookKey !== 'Psalms' && x.bookKey !== 'Proverbs');
    const nt_all = FLAT.filter(x=>NT_BOOKS.includes(x.bookKey));
    const psalms = FLAT.filter(x=>x.bookKey === 'Psalms');
    const proverbs = FLAT.filter(x=>x.bookKey === 'Proverbs');

    // Total de cap√≠tulos: OT + NT + Salmos/Prov√©rbios (365/dur)
    const otherTotal = ot_all.length + nt_all.length;
    const daysPerOther = duration;
    
    const ot_chunks = [];
    const nt_chunks = [];
    
    // Distribui o AT e NT (exceto Salmos/Prov√©rbios) em partes iguais ao longo do plano
    // Cerca de 75% AT e 25% NT
    const targetOT = Math.round((ot_all.length / otherTotal) * daysPerOther);
    const targetNT = Math.round((nt_all.length / otherTotal) * daysPerOther);

    // Ajusta para 100% se houver diferen√ßa
    let otPerDay = ot_all.length / daysPerOther;
    let ntPerDay = nt_all.length / daysPerOther;
    
    let otIdx = 0;
    let ntIdx = 0;

    const plan = Array.from({length: duration}, ()=>[]);

    for(let d=0; d<duration; d++){
        // Adiciona 1 Salmo (ou parte de) + 1 Prov√©rbio/dia se poss√≠vel
        if (d < psalms.length) plan[d].push(formatRefObj(psalms[d], lang));
        if (d < proverbs.length) plan[d].push(formatRefObj(proverbs[d], lang));

        // Adiciona OT + NT restante (usando o m√©todo de arredondamento 'smooth')
        const targetOt = Math.round(otPerDay * (d+1));
        const targetNt = Math.round(ntPerDay * (d+1));

        const takeOT = Math.max(1, targetOt - otIdx);
        const takeNT = Math.max(1, targetNt - ntIdx);

        for(let t=0; t<takeOT && otIdx < ot_all.length; t++, otIdx++) {
            plan[d].push(formatRefObj(ot_all[otIdx], lang));
        }

        for(let t=0; t<takeNT && ntIdx < nt_all.length; t++, ntIdx++) {
            plan[d].push(formatRefObj(nt_all[ntIdx], lang));
        }
        
        // Se o dia ficou vazio (devido a arredondamentos no final do plano), preenche
        if (plan[d].length === 0 && (otIdx < ot_all.length || ntIdx < nt_all.length)) {
             if (otIdx < ot_all.length) plan[d].push(formatRefObj(ot_all[otIdx++], lang));
             if (ntIdx < nt_all.length) plan[d].push(formatRefObj(nt_all[ntIdx++], lang));
        }
    }
    
    // Garante que o que sobrou v√° para o √∫ltimo dia
    while(otIdx<ot_all.length) plan[plan.length-1].push(formatRefObj(ot_all[otIdx++], lang));
    while(ntIdx<nt_all.length) plan[plan.length-1].push(formatRefObj(nt_all[ntIdx++], lang));

    return plan;
  }
  
  // Converte a refer√™ncia do livro para URL do Bible Gateway
  function getBibleGatewayUrl(refs, lang) {
    if (!refs || refs.length === 0) return '#';
    
    let languageCode = 'NIV'; // Default
    if (lang === 'pt') languageCode = 'NVI-PT';
    else if (lang === 'es') languageCode = 'NVI-ES';
    
    // Converte a refer√™ncia formatada de volta para as chaves originais dos livros
    const bookKeys = BOOKS.map(b => b.key);
    const parts = refs.map(ref => {
      // Ex: 'G√™nesis 1' -> 'Genesis 1'
      const match = bookKeys.find(key => ref.includes(bookName(key, lang)));
      if (match) {
        // Remove o nome do livro no idioma atual e insere a chave em ingl√™s
        return ref.replace(bookName(match, lang), match);
      }
      return ref;
    });

    const combinedRefs = parts.join('; ');

    return `https://www.biblegateway.com/passage/?search=${encodeURIComponent(combinedRefs)}&version=${languageCode}`;
  }


  // Calcula o dia do ano (1 a 365)
  function getDayOfYear(date) {
    const start = new Date(date.getFullYear(), 0, 0);
    const diff = date - start;
    const oneDay = 1000 * 60 * 60 * 24;
    return Math.floor(diff / oneDay);
  }

  function dayOfYearToMonthDay(n){
    let m=0;
    let day = n;
    while(m<12 && day > DAYS_PER_MONTH[m]){
      day -= DAYS_PER_MONTH[m];
      m++;
    }
    return { month: m+1, day: day };
  }
  
  function monthDayToDayOfYear(month, day){
    let s=0;
    for(let i=0;i<month-1;i++) s+=DAYS_PER_MONTH[i];
    return s+day;
  }

  // Alterna a visualiza√ß√£o entre as duas "p√°ginas"
  function showPage(pageId) {
    const selecao = document.getElementById('paginaSelecao');
    const plano = document.getElementById('paginaPlano');
    const texts = UI_TEXT[state.idioma];
    
    if (pageId === 'paginaPlano' && state.planoId) {
      // Exibir P√°gina do Plano
      selecao.classList.add('hidden'); // Usa 'hidden' para ocultar
      plano.classList.remove('hidden'); // Usa 'hidden' para mostrar
      document.getElementById('tituloApp').innerText = ` ${texts.titulo}`;
      document.getElementById('subtituloApp').innerText = texts.subtitulo;
      
      // Renderiza novamente todo o conte√∫do do plano (meses e dias)
      renderPlanGrid();
      renderMonths();
      renderDays(state.selectedMonth);
      updateProgressUI();
    } else {
      // Exibir P√°gina de Sele√ß√£o
      plano.classList.add('hidden');
      selecao.classList.remove('hidden');
      
      // ATUALIZA√á√ÉO DO HEADER (SEM REDUND√ÇNCIA NO BODY)
      document.getElementById('tituloApp').innerText = ` ${texts.titulo_selecao}`;
      document.getElementById('subtituloApp').innerText = texts.subtitulo_selecao;
      renderPlanGrid();
    }
    
    if(window.lucide) window.lucide.createIcons();
  }

  // ---------- RENDER FUNCTIONS ----------
  function renderPlanGrid(){
    const container = document.getElementById('gridPlanos');
    if (!container) return;
    container.innerHTML = '';
    const texts = UI_TEXT[state.idioma];
    
    texts.planos.forEach(plano => {
      const isSelected = plano.id === state.planoId;
      const card = document.createElement('div'); // Alterado de button para div
      
      // Classes do card
      card.className = 'plan-button flex flex-col items-start p-4 rounded-xl transition border-4 text-left shadow-lg ' + 
        (isSelected 
          ? 'bg-primary-500 text-white shadow-primary-500/50 border-primary-500' 
          : 'bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 border-gray-200 dark:border-gray-700 hover:border-primary-500');

      card.innerHTML = `
        <div class="flex-1 w-full">
            <h3 class="text-lg font-extrabold">${plano.title}</h3>
            <p class="text-sm ${isSelected ? 'text-indigo-200' : 'text-gray-500 dark:text-gray-400'} mt-1">${plano.desc}</p>
        </div>
        <div class="w-full mt-4 pt-4 border-t ${isSelected ? 'border-indigo-400' : 'border-gray-200 dark:border-gray-700'}">
            ${isSelected 
                ? `
                    <div class="text-sm font-semibold flex items-center gap-2 mb-3">
                         <i data-lucide="check-circle" class="lucide w-5 h-5 text-white fill-white/30 flex-shrink-0"></i>
                         ${texts.active_plan}
                    </div>
                    <button class="w-full px-4 py-2 rounded-xl bg-white text-primary-500 font-bold hover:bg-gray-100 transition shadow-md view-plan-button">
                        ${texts.view_plan}
                    </button>
                `
                : `
                    <button class="w-full px-4 py-2 rounded-xl bg-primary-500 text-white font-bold hover:bg-primary-600 transition shadow-md start-plan-button">
                        ${texts.start_plan_button}
                    </button>
                `
            }
        </div>
      `;
      
      // Event listener for START button
      const startButton = card.querySelector('.start-plan-button');
      if(startButton){
        startButton.onclick = () => {
            // Se houver um plano anterior ou um progresso, pede confirma√ß√£o
            if (state.planoId) {
                state.pendingPlanoId = plano.id; // Guarda o ID pendente (do novo plano)
                openConfirmChangePlanModal();
            } else {
                // Se n√£o houver plano anterior, seleciona e inicializa
                clearPlanStorage(); // Garante que progresso, data e CACHE sejam apagados
                
                state.planoId = plano.id;
                localStorage.setItem('bib_plano', state.planoId);
                
                // Define o dia de hoje como o in√≠cio do plano (Change 1)
                const today = new Date();
                const y = today.getFullYear();
                const m = String(today.getMonth() + 1).padStart(2, '0');
                const d = String(today.getDate()).padStart(2, '0');
                state.planStartDate = `${y}-${m}-${d}`;
                localStorage.setItem('bib_start_date', state.planStartDate);
                
                showPage('paginaPlano');
            }
        };
      }
      
      // Event listener for VIEW button (if selected)
      const viewButton = card.querySelector('.view-plan-button');
      if(viewButton){
        viewButton.onclick = () => {
            showPage('paginaPlano');
        };
      }

      container.appendChild(card);
    });

    if(window.lucide) window.lucide.createIcons();
  }

  function renderMonths(){
    const div = document.getElementById('meses');
    if (!div) return;
    div.innerHTML='';
    const months = MONTHS[state.idioma];
    
    // Calcula quantos meses s√£o necess√°rios para a dura√ß√£o atual (arredondando para cima)
    const requiredMonths = Math.ceil(state.planDuration / 31); // 90 dias = 3 meses, 365 dias = 12 meses

    for (let i = 0; i < 12; i++) {
        // Se a dura√ß√£o for menor que 12 meses, s√≥ renderiza os meses necess√°rios
        if (state.planDuration < 365 && i >= requiredMonths) continue;

        const m = months[i];
        const monthIndex = i + 1; // 1 a 12
        const isSelected = state.selectedMonth === monthIndex;
        
        const btn = document.createElement('button');
        btn.className = 'flex-shrink-0 px-4 py-2 rounded-full font-semibold transition ' + 
            (isSelected 
                ? 'bg-primary-500 text-white shadow-md' 
                : 'bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600');
        btn.innerText = m;
        
        btn.onclick = ()=>{
            state.selectedMonth = monthIndex;
            renderMonths();
            renderDays(monthIndex);
        };
        div.appendChild(btn);
    }

    const currentMonthButton = document.querySelector(`#meses button:nth-child(${state.selectedMonth})`);
    if(currentMonthButton){
        currentMonthButton.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
  }

  function renderDays(month){
    const container = document.getElementById('dias');
    if (!container) return;
    container.innerHTML = '';

    const daysInMonth = DAYS_PER_MONTH[month-1];
    const plan = getPlan(state.planoId, state.idioma);
    const texts = UI_TEXT[state.idioma];
    
    // Calcula o dia de hoje no plano (1 a 365)
    let dayFromStart = null;
    if (state.planStartDate) {
        const start = new Date(state.planStartDate);
        const today = new Date();
        const diffTime = Math.abs(today - start);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
        dayFromStart = diffDays + 1; // Dia 1 √© o dia de in√≠cio
    }
    
    // Calcula o offset do dia do ano
    const dayOfYearStart = monthDayToDayOfYear(month, 1);

    for (let d = 1; d <= daysInMonth; d++) {
        const dayOfYear = dayOfYearStart + d - 1; // Dia do ano (1 a 365)
        const idx = dayOfYear - 1; // √çndice do array do plano (0 a 364)
        const refs = plan[idx] || ['‚Äî'];
        const key = `${state.planoId}_day_${dayOfYear}`;
        const lido = localStorage.getItem(key);
        
        // Verifica se √© o dia esperado de leitura
        const isExpectedDay = state.planStartDate && dayOfYear === dayFromStart; 
        const isOutsidePlanDuration = dayOfYear > state.planDuration;
        const hasReadings = idx < state.planDuration && refs.some(r => r !== '‚Äî');

        const card = document.createElement('div');
        let cardClasses = 'p-3 rounded-2xl border-4 transition duration-200 cursor-pointer flex flex-col justify-between min-h-[140px]';
        
        if (isOutsidePlanDuration) {
             cardClasses += ' border-gray-100 dark:border-gray-800 bg-gray-50 dark:bg-gray-900 cursor-default opacity-70';
        } else if (isExpectedDay && hasReadings) { 
            // Destaque para o dia 'Em Dia'
            cardClasses += ' today-highlight border-primary-500';
        } else { 
            // Se LIDO, usa Borda Vermelha (ajustado de primary-500) e fundo cinza (read-highlight)
            cardClasses += (lido ? ' border-red-500 opacity-90 read-highlight' : ' border-gray-200 dark:border-gray-700 hover:shadow-lg hover:ring-1 hover:ring-primary-500') + ' bg-white dark:bg-gray-800';
        }

        card.className = cardClasses;
        
        const preview = hasReadings ? refs.slice(0,2).join(', ') : '‚Äî';
        const iconName = lido ? 'check-circle' : (isOutsidePlanDuration ? 'minus' : 'chevrons-right');
        const iconColor = lido ? 'text-red-500' : (isExpectedDay ? 'text-primary-500' : (isOutsidePlanDuration ? 'text-gray-400' : 'text-gray-400 dark:text-gray-500'));
        const textColor = isExpectedDay ? 'text-gray-800 dark:text-gray-100' : (isOutsidePlanDuration ? 'text-gray-400 dark:text-gray-500' : 'text-gray-700 dark:text-gray-200');

        let statusHtml = '';
        if (lido) {
            // Leitura Conclu√≠da
            statusHtml = `<p class="text-xs font-bold text-red-500 mt-2">${UI_TEXT[state.idioma].lido}</p>`;
        } else if (state.planStartDate && hasReadings) {
            // Alerta de Atraso/Adiantado (TRADUZIDO)
            const texts = UI_TEXT[state.idioma]; // Objeto de textos para tradu√ß√£o
            if (dayOfYear < dayFromStart) {
                const diff = dayFromStart - dayOfYear;
                // Atrasado: Texto vermelho
                statusHtml = `<p class="text-xs font-bold text-red-500 mt-2">${texts.delayed} (-${diff}${texts.days_behind})</p>`;
            } else if (dayOfYear > dayFromStart) {
                const diff = dayOfYear - dayFromStart;
                // Adiantado: Texto verde
                statusHtml = `<p class="text-xs font-bold text-green-500 mt-2">${texts.ahead} (+${diff}${texts.days_ahead})</p>`;
            }
        }

        if (idx < state.planDuration) {
            card.innerHTML = `
                <div>
                    <div class="flex items-center justify-between">
                        <div class="text-xs font-semibold uppercase ${textColor}">${formatDateSmall(month, d)}</div>
                        <i data-lucide="${lido && isExpectedDay ? 'star' : iconName}" class="lucide w-6 h-6 ${iconColor} ${lido && isExpectedDay ? 'fill-red-500/30' : ''}"></i>
                    </div>
                    <p class="mt-3 text-sm font-bold ${textColor}">${texts.dia_leitura} ${dayOfYear}</p>
                    <p class="text-xs ${textColor}">${preview}</p>
                    ${statusHtml}
                </div>
            `;
            
            // S√≥ adiciona o listener se o dia tiver leituras dentro da dura√ß√£o
            if (hasReadings && !isOutsidePlanDuration) {
                 card.onclick = () => abrirModalForDay(dayOfYear);
            } else {
                 card.style.cursor = 'default';
            }
        } else {
            // Dia fora do plano (se duration < 365)
            card.innerHTML = `
                 <div>
                    <div class="flex items-center justify-between">
                        <div class="text-xs font-semibold uppercase text-gray-400">${formatDateSmall(month, d)}</div>
                        <div class="flex-shrink-0"><i data-lucide="minus" class="lucide w-6 h-6 text-gray-400"></i></div>
                    </div>
                    <p class="mt-3 text-sm font-medium text-gray-400">Fora do plano de ${state.planDuration} dias.</p>
                 </div>`;
        }
        
        container.appendChild(card);
    }
    
    if(window.lucide) window.lucide.createIcons();
    updateProgressUI();
  }

  function formatDateSmall(month, day){
    const months = MONTHS[state.idioma];
    return `${months[month-1]} ${day}`;
  }

  let modalCurrentDay = null;
  const modalDiv = document.getElementById('modal');
  const modalContent = document.getElementById('modalContent');
  
  function abrirModalForDay(dayOfYear){
    if (!state.planoId) return;
    modalCurrentDay = dayOfYear;
    const plan = getPlan(state.planoId, state.idioma);
    const refs = plan[dayOfYear-1] || [];
    const key = `${state.planoId}_day_${dayOfYear}`;
    const lido = localStorage.getItem(key);
    const hasReadings = refs.some(r => r !== '‚Äî');

    document.getElementById('modalTitulo').innerText = `${UI_TEXT[state.idioma].start} ‚Ä¢ ${UI_TEXT[state.idioma].dia_leitura} ${dayOfYear}`;
    const ul = document.getElementById('modalLeituras');
    ul.innerHTML = '';

    const btnLido = document.getElementById('btnLido');
    const btnLerAgora = document.getElementById('btnLerAgora');
    
    // Atualiza texto do bot√£o "Marcar como lido"
    btnLido.innerText = lido ? UI_TEXT[state.idioma].nao_lido : UI_TEXT[state.idioma].marcar;
    btnLido.classList.toggle('bg-red-500', !!lido);
    btnLido.classList.toggle('hover:bg-red-600', !!lido);
    btnLido.classList.toggle('bg-primary-500', !lido);
    btnLido.classList.toggle('hover:bg-primary-600', !lido);
    btnLido.classList.toggle('shadow-lg', true);
    btnLido.classList.toggle('shadow-red-500/30', !!lido);
    btnLido.classList.toggle('shadow-primary-500/30', !lido);

    if (hasReadings) {
      refs.forEach(r=>{
        const li = document.createElement('li');
        li.className='text-base flex items-center p-2 rounded-lg bg-gray-50 dark:bg-gray-700';
        const icon = document.createElement('i');
        icon.setAttribute('data-lucide', 'book-open');
        icon.className='lucide w-4 h-4 mr-3 text-primary-500 flex-shrink-0';
        const span = document.createElement('span');
        span.innerText = r;
        li.appendChild(icon);
        li.appendChild(span);
        ul.appendChild(li);
      });

      // Ativa os bot√µes
      btnLido.disabled = false;
      btnLido.classList.remove('opacity-50', 'cursor-not-allowed');
      btnLerAgora.disabled = false;
      btnLerAgora.classList.remove('opacity-50', 'cursor-not-allowed');

    } else {
      ul.innerHTML = `<li class="text-base text-center p-2 rounded-lg bg-gray-50 dark:bg-gray-700">${UI_TEXT[state.idioma].nao_lido}</li>`;
      // Desativa os bot√µes
      btnLido.disabled = true;
      btnLido.classList.add('opacity-50', 'cursor-not-allowed');
      btnLerAgora.disabled = true;
      btnLerAgora.classList.add('opacity-50', 'cursor-not-allowed');
    }
    
    // Abre o modal
    modalDiv.classList.remove('hidden');
    setTimeout(() => {
      modalDiv.style.opacity = '1';
      modalContent.classList.remove('scale-95');
    }, 10);
    
    if(window.lucide) window.lucide.createIcons();
  }

  function fecharModal(){
    modalDiv.style.opacity = '0';
    modalContent.classList.add('scale-95');
    setTimeout(() => modalDiv.classList.add('hidden'), 300);
    modalCurrentDay = null; // Limpa o dia atual
  }
  
  // Event Listeners do Modal
  document.getElementById('fecharModal').addEventListener('click', fecharModal);
  modalDiv.addEventListener('click', (e) => {
    if(e.target.id === 'modal') fecharModal();
  });

  document.getElementById('btnLido').addEventListener('click', () => {
    if (modalCurrentDay) {
      const key = `${state.planoId}_day_${modalCurrentDay}`;
      if (localStorage.getItem(key)) {
        localStorage.removeItem(key); // Desmarcar
      } else {
        localStorage.setItem(key, 'read'); // Marcar
      }
      fecharModal();
      renderDays(state.selectedMonth); // Re-renderiza o m√™s atual
    }
  });

  document.getElementById('btnLerAgora').addEventListener('click', () => {
    if (modalCurrentDay) {
      const plan = getPlan(state.planoId, state.idioma);
      const refs = plan[modalCurrentDay-1] || [];
      const url = getBibleGatewayUrl(refs, state.idioma);
      window.open(url, '_blank');
    }
  });


  function updateProgressUI(){
    if (!state.planoId) return;

    const total = state.planDuration;
    let read = 0;
    for(let i=1; i<=total; i++){
      if(localStorage.getItem(`${state.planoId}_day_${i}`)) read++;
    }
    
    const pct = Math.round((read/total)*100);

    const progressoBar = document.getElementById('progressoBar');
    const textoProgresso = document.getElementById('textoProgresso');
    const textoPlanoAtual = document.getElementById('textoPlanoAtual');
    const textoDataInicio = document.getElementById('textoDataInicio'); // Elemento da data

    if (progressoBar) progressoBar.style.width = pct + '%'; // O total √© baseado na DURA√á√ÉO
    
    if (textoProgresso) textoProgresso.innerText = `${UI_TEXT[state.idioma].progresso}: ${read} / ${total}`;

    const planoEncontrado = UI_TEXT[state.idioma].planos.find(p=>p.id===state.planoId);
    const planName = planoEncontrado ? planoEncontrado.title : '---';

    // Atualiza o texto do display est√°tico
    if (textoPlanoAtual) textoPlanoAtual.innerHTML = `${UI_TEXT[state.idioma].plano}: ${planName} (${total}d)`;

    // Atualiza a data de in√≠cio
    if (textoDataInicio && state.planStartDate) {
        // Formata YYYY-MM-DD para o formato local (ex: DD/MM/YYYY)
        const dateParts = state.planStartDate.split('-');
        const texts = UI_TEXT[state.idioma];
        
        // Usa o formato PT/BR (DD/MM/YYYY) se o idioma for PT, sen√£o usa EN/US (MM/DD/YYYY)
        const formattedDate = state.idioma === 'pt' 
            ? `${dateParts[2]}/${dateParts[1]}/${dateParts[0]}` 
            : `${dateParts[1]}/${dateParts[2]}/${dateParts[0]}`;

        textoDataInicio.innerText = `${texts.start_date_label}: ${formattedDate}`;
    } else if (textoDataInicio) {
        textoDataInicio.innerText = '';
    }
  }

  // ---------- IDIOMA DROPDOWN LOGIC ----------
  const idiomaToggle = document.getElementById('idiomaToggle');
  const idiomaMenu = document.getElementById('idiomaMenu');
  const currentFlag = document.getElementById('currentFlag');
  const idiomaItems = document.querySelectorAll('.idioma-item');

  function updateIdiomaDisplay(lang){
    const texts = UI_TEXT[lang];
    const flagCode = texts.flag_code;
    
    // Atualiza o bot√£o principal APENAS com a bandeira
    currentFlag.className = `flag-icon flag-icon-${flagCode}`;
    
    // Altera o estado de 'selecionado' no menu
    idiomaItems.forEach(item => {
        if(item.getAttribute('data-lang') === lang) {
            item.classList.add('bg-gray-200', 'dark:bg-gray-600');
        } else {
            item.classList.remove('bg-gray-200', 'dark:bg-gray-600');
        }
    });
    
    updateUITexts(lang); // Atualiza todos os textos da UI
    
    // Re-renderiza as p√°ginas se estiverem ativas
    if(!document.getElementById('paginaSelecao').classList.contains('hidden')) {
        renderPlanGrid();
    } else if (state.planoId) {
        renderMonths();
        renderDays(state.selectedMonth);
        updateProgressUI();
    }
  }
  
  function updateUITexts(lang){
    const texts = UI_TEXT[lang];
    
    // Atualiza elementos do Header e Bot√µes Principais
    document.getElementById('tituloApp').innerText = texts.titulo;
    document.getElementById('subtituloApp').innerText = texts.subtitulo;
    document.getElementById('btnHojeText').innerText = texts.hoje;
    
    // Atualiza textos do Settings Modal
    if(document.getElementById('settingsModalTitle')) document.getElementById('settingsModalTitle').innerText = texts.settings;
    if(document.querySelector('label[for="planDurationSelect"]')) document.querySelector('label[for="planDurationSelect"]').innerText = texts.duration_label;
    if(document.getElementById('btnTrocarPlano')) document.getElementById('btnTrocarPlano').innerText = texts.link_trocar;
    if(document.getElementById('btnResetarProgresso')) document.getElementById('btnResetarProgresso').innerText = texts.reset_progress;
    if(document.getElementById('backupRestoreTitle')) document.getElementById('backupRestoreTitle').innerText = texts.backup_restore;
    if(document.getElementById('btnExport')) document.getElementById('btnExport').innerText = texts.export_progress;
    if(document.getElementById('btnImport')) document.getElementById('btnImport').innerText = texts.import_progress;
    
    // Atualiza op√ß√µes de dura√ß√£o
    const select = document.getElementById('planDurationSelect');
    if (select) {
        // Preserva o valor atual, remove, e recria as options
        const currentValue = select.value;
        select.innerHTML = '';
        DURATIONS.forEach(d => {
            const option = document.createElement('option');
            option.value = d;
            option.innerText = texts.duration_options[d];
            select.appendChild(option);
        });
        select.value = currentValue || state.planDuration; // Tenta restaurar ou usa o padr√£o
    }

    // ATUALIZA√á√ÉO DOS LINKS DE PRIVACIDADE E AJUDA
    const linkPrivacidade = document.getElementById('linkPrivacidade');
    const btnAbrirGlossario = document.getElementById('btnAbrirGlossario');
    if (linkPrivacidade) linkPrivacidade.innerText = texts.privacy_link;
    if (btnAbrirGlossario) btnAbrirGlossario.innerText = texts.glossary_link;

    // ATUALIZA√á√ÉO DO NOVO MODAL DE CONFIRMA√á√ÉO
    const confirmChangePlanModal = document.getElementById('confirmChangePlanModal');
    if (confirmChangePlanModal && !confirmChangePlanModal.classList.contains('hidden')) {
        // Se o modal estiver aberto, atualiza o texto imediatamente
        document.getElementById('confirmTitle').innerText = texts.alert_title || 'Aten√ß√£o!';
        document.getElementById('confirmMessage').innerHTML = texts.alert_change_plan_html;
        document.getElementById('btnCancelChangePlan').innerText = texts.cancel;
        document.getElementById('btnConfirmChangePlan').innerText = texts.confirm_erase;
    }
    
    // NOVO: RENDERIZA CONTE√öDO DOS MODAIS DE PRIVACIDADE E GLOSS√ÅRIO SE ESTIVEREM ABERTOS
    const privacyModal = document.getElementById('privacyModal');
    const glossaryModal = document.getElementById('glossaryModal');
    if (privacyModal && !privacyModal.classList.contains('hidden')) {
      renderPrivacyContent(texts);
    }
    if (glossaryModal && !glossaryModal.classList.contains('hidden')) {
      renderGlossaryContent(texts);
    }
  }

  // L√≥gica do Dropdown de Idiomas
  idiomaToggle.addEventListener('click', (e) => {
    e.stopPropagation();
    const isHidden = idiomaMenu.classList.contains('hidden');
    if(isHidden){
      idiomaMenu.classList.remove('hidden');
      setTimeout(() => {
          idiomaMenu.classList.remove('scale-95', 'opacity-0');
      }, 10);
    } else {
      idiomaMenu.classList.add('scale-95', 'opacity-0');
      setTimeout(() => {
          idiomaMenu.classList.add('hidden');
      }, 150);
    }
  });

  idiomaItems.forEach(item => {
    item.addEventListener('click', () => {
      const newLang = item.getAttribute('data-lang');
      if (state.idioma !== newLang) {
        state.idioma = newLang;
        localStorage.setItem('bib_idioma', newLang);
        updateIdiomaDisplay(newLang);
        fecharModal(); // Fecha o modal de leituras se estiver aberto
      }
      idiomaMenu.classList.add('scale-95', 'opacity-0');
      setTimeout(() => {
          idiomaMenu.classList.add('hidden');
      }, 150);
    });
  });

  // Fecha o menu de idiomas se clicar fora
  document.addEventListener('click', (e) => {
    if (!idiomaDropdown.contains(e.target)) {
      idiomaMenu.classList.add('scale-95', 'opacity-0');
      setTimeout(() => {
          idiomaMenu.classList.add('hidden');
      }, 150);
    }
  });


  // NOVA FUN√á√ÉO: Navega para o m√™s atual e destaca o dia atual
  function goToToday() {
    if (!state.planoId) return;
    
    const today = new Date();
    const currentMonth = today.getMonth() + 1;
    
    // Atualiza o estado do m√™s selecionado se for diferente
    if (state.selectedMonth !== currentMonth) {
      state.selectedMonth = currentMonth;
    }

    renderMonths();
    renderDays(state.selectedMonth);

    // Rola para o bot√£o do m√™s atual
    const mesesContainer = document.getElementById('meses');
    const currentMonthButton = document.querySelector(`#meses button:nth-child(${state.selectedMonth})`);
    if (mesesContainer && currentMonthButton) {
        currentMonthButton.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
    
    // Rola para o dia 'hoje' (o dia do plano esperado)
    if (state.planStartDate) {
        const start = new Date(state.planStartDate);
        const diffTime = Math.abs(today - start);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
        const dayFromStart = diffDays + 1;

        const dayToScroll = document.querySelector(`[data-day-of-year="${dayFromStart}"]`);
        if(dayToScroll) {
            dayToScroll.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }
  }

  document.getElementById('btnHoje').addEventListener('click', goToToday);


  function clearPlanStorage(){
    // Limpa as chaves de configura√ß√£o do plano
    localStorage.removeItem('bib_plano');
    localStorage.removeItem('bib_duration');
    localStorage.removeItem('bib_start_date');

    // Limpa todas as chaves de progresso do plano anterior (mais seguro que usar o ID)
    const keysToRemove = [];
    for(let i=0; i<localStorage.length; i++){
        const key = localStorage.key(i);
        if(key && key.includes('_day_')){
            keysToRemove.push(key);
        }
    }
    keysToRemove.forEach(key => localStorage.removeItem(key));

    // Reseta o estado
    state.planoId = null;
    state.planDuration = 365;
    state.planStartDate = null;
    CACHE = {}; // REQUISITO: LIMPAR CACHE
  }

  // NOVO: L√ìGICA DO MODAL DE CONFIGURA√á√ïES
  const settingsModal = document.getElementById('settingsModal');
  const planDurationSelect = document.getElementById('planDurationSelect');

  function openSettingsModal(){
    const texts = UI_TEXT[state.idioma];
    
    // Atualiza textos do modal
    document.getElementById('settingsModalTitle').innerText = texts.settings;
    document.querySelector('label[for="planDurationSelect"]').innerText = texts.duration_label;
    document.getElementById('btnTrocarPlano').innerText = texts.link_trocar;
    document.getElementById('btnResetarProgresso').innerText = texts.reset_progress;
    document.getElementById('backupRestoreTitle').innerText = texts.backup_restore;
    document.getElementById('btnExport').innerText = texts.export_progress;
    document.getElementById('btnImport').innerText = texts.import_progress;
    document.getElementById('durationWarning').innerText = texts.alert_duration_change;

    // Atualiza op√ß√µes de dura√ß√£o no select
    updateUITexts(state.idioma);

    planDurationSelect.value = state.planDuration;

    settingsModal.classList.remove('hidden');
    setTimeout(() => {
        settingsModal.style.opacity = '1';
        document.getElementById('settingsModalContent').classList.remove('scale-95');
    }, 10);
    if(window.lucide) window.lucide.createIcons();
  }

  function closeSettingsModal() {
      settingsModal.style.opacity = '0';
      document.getElementById('settingsModalContent').classList.add('scale-95');
      setTimeout(() => settingsModal.classList.add('hidden'), 300);
  }

  document.getElementById('btnOpenSettings').addEventListener('click', openSettingsModal);
  document.getElementById('fecharSettingsModal').addEventListener('click', closeSettingsModal);
  settingsModal.addEventListener('click', (e) => {
      if(e.target.id === 'settingsModal') closeSettingsModal();
  });

  // Handler para troca de dura√ß√£o (Plan Duration Select)
  planDurationSelect.addEventListener('change', (e) => {
      const newDuration = parseInt(e.target.value);
      if (newDuration !== state.planDuration) {
          // A altera√ß√£o de dura√ß√£o APENAS recalculada o plano. 
          // O progresso (keys no localStorage) √© mantido para os dias que ca√≠rem no novo range.
          state.planDuration = newDuration;
          localStorage.setItem('bib_duration', newDuration);
          CACHE = {}; // Invalida o cache para gerar o novo plano
          
          closeSettingsModal();
          showPage('paginaPlano'); // Re-renderiza o plano com a nova dura√ß√£o
      }
  });


  // --- Fun√ß√µes do Novo Modal de Confirma√ß√£o (Estiloso) ---
  const confirmChangePlanModal = document.getElementById('confirmChangePlanModal');
  const confirmChangePlanContent = document.getElementById('confirmChangePlanContent');

  function openConfirmChangePlanModal(isReset = false) {
    const texts = UI_TEXT[state.idioma];
    
    document.getElementById('confirmTitle').innerText = isReset ? texts.alert_title : texts.alert_title || 'Aten√ß√£o!';
    
    if (isReset) {
         document.getElementById('confirmMessage').innerHTML = texts.alert_reset;
         document.getElementById('btnConfirmChangePlan').innerText = texts.reset_progress;
         document.getElementById('btnConfirmChangePlan').classList.remove('bg-red-500', 'hover:bg-red-600', 'shadow-red-500/30');
         document.getElementById('btnConfirmChangePlan').classList.add('bg-orange-500', 'hover:bg-orange-600', 'shadow-orange-500/30');
    } else {
         document.getElementById('confirmMessage').innerHTML = texts.alert_change_plan_html;
         document.getElementById('btnConfirmChangePlan').innerText = texts.confirm_erase;
         document.getElementById('btnConfirmChangePlan').classList.add('bg-red-500', 'hover:bg-red-600', 'shadow-red-500/30');
         document.getElementById('btnConfirmChangePlan').classList.remove('bg-orange-500', 'hover:bg-orange-600', 'shadow-orange-500/30');
    }

    // Configura o handler de confirma√ß√£o baseado no modo
    document.getElementById('btnConfirmChangePlan').onclick = isReset 
        ? handleConfirmResetProgress 
        : handleConfirmChangePlan;

    confirmChangePlanModal.classList.remove('hidden');
    setTimeout(() => {
      confirmChangePlanModal.style.opacity = '1';
      confirmChangePlanContent.classList.remove('scale-95');
    }, 10);
    if(window.lucide) window.lucide.createIcons();
  }

  function closeConfirmChangePlanModal() {
    confirmChangePlanModal.style.opacity = '0';
    confirmChangePlanContent.classList.add('scale-95');
    setTimeout(() => confirmChangePlanModal.classList.add('hidden'), 300);
    state.pendingPlanoId = null; // Limpa o ID pendente
  }
  
  // Handlers para o modal de confirma√ß√£o
  const handleConfirmChangePlan = () => {
    // Verifica se a inten√ß√£o √© apenas trocar de plano (voltar para a sele√ß√£o)
    if (state.pendingPlanoId === 'GO_TO_SELECTION_MODE') {
        clearPlanStorage(); // Limpa tudo (incluindo progresso e CACHE)
        closeConfirmChangePlanModal();
        showPage('paginaSelecao'); // <--- FIX: Redireciona para a sele√ß√£o
    }
    // Se houver um ID pendente, √© a a√ß√£o de iniciar um NOVO plano na tela de sele√ß√£o.
    else if (state.pendingPlanoId) {
        clearPlanStorage(); // Apaga tudo, incluindo o CACHE
        
        // Define o novo plano
        state.planoId = state.pendingPlanoId;
        localStorage.setItem('bib_plano', state.planoId);
        
        // Define o dia de hoje como o in√≠cio do novo plano
        const today = new Date();
        const y = today.getFullYear();
        const m = String(today.getMonth() + 1).padStart(2, '0');
        const d = String(today.getDate()).padStart(2, '0');
        state.planStartDate = `${y}-${m}-${d}`;
        localStorage.setItem('bib_start_date', state.planStartDate);
        
        closeConfirmChangePlanModal();
        showPage('paginaPlano'); // Permanece na p√°gina do plano
    }
  };

  const handleConfirmResetProgress = () => {
      // A√ß√£o: Resetar Progresso (confirma√ß√£o)
      const totalDays = state.planDuration;
      for (let i = 1; i <= totalDays; i++) {
          localStorage.removeItem(`${state.planoId}_day_${i}`);
      }
      localStorage.removeItem('bib_start_date'); // Tamb√©m reseta a data de in√≠cio

      state.planStartDate = null;
      closeConfirmChangePlanModal();
      showPage('paginaPlano'); // Re-renderiza o plano para refletir o reset
  };
  
  // Handler: Trocar Plano (MODIFICADO para abrir o modal customizado e setar a inten√ß√£o)
  document.getElementById('btnTrocarPlano').addEventListener('click', () => {
    closeSettingsModal(); // Fecha o modal de configura√ß√µes primeiro
    state.pendingPlanoId = 'GO_TO_SELECTION_MODE'; // Sinaliza a inten√ß√£o de trocar
    openConfirmChangePlanModal(false); // Abre o novo modal de confirma√ß√£o (Trocar Plano)
  });

  // Handler: Cancelar a troca de plano no modal customizado
  document.getElementById('btnCancelChangePlan').addEventListener('click', () => {
    closeConfirmChangePlanModal();
  });

  document.getElementById('confirmChangePlanModal').addEventListener('click', (e) => {
    if(e.target.id === 'confirmChangePlanModal') closeConfirmChangePlanModal();
  });

  // Handler: Resetar Progresso
  document.getElementById('btnResetarProgresso').addEventListener('click', () => {
    closeSettingsModal();
    openConfirmChangePlanModal(true); // Abre o modal de confirma√ß√£o (Resetar)
  });


  // --- L√ìGICA DE BACKUP / RESTAURA√á√ÉO ---
  document.getElementById('btnExport').addEventListener('click', () => {
    const data = {};
    for (const key in localStorage) {
        if (key.startsWith('bib_') || key.includes('_day_')) {
            data[key] = localStorage.getItem(key);
        }
    }
    const jsonString = JSON.stringify(data, null, 2);
    const blob = new Blob([jsonString], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `plano_biblico_backup_${new Date().toISOString().slice(0,10)}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  });

  document.getElementById('btnImport').addEventListener('click', () => {
    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.accept = 'application/json';
    
    fileInput.onchange = e => {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(event) {
            try {
                const importedData = JSON.parse(event.target.result);
                
                if (!importedData || typeof importedData !== 'object') {
                     throw new Error('Formato de dados inv√°lido.');
                }

                // Limpa as chaves atuais relacionadas ao progresso
                const keysToClear = Object.keys(localStorage).filter(key => key.startsWith('bib_') || key.includes('_day_'));
                keysToClear.forEach(key => localStorage.removeItem(key));
                
                // Importa os novos dados
                for (const key in importedData) {
                    localStorage.setItem(key, importedData[key]);
                }

                // Atualiza o estado global com os novos dados
                state.idioma = localStorage.getItem('bib_idioma') || 'pt';
                state.planoId = localStorage.getItem('bib_plano') || null;
                state.planDuration = parseInt(localStorage.getItem('bib_duration')) || 365;
                state.planStartDate = localStorage.getItem('bib_start_date') || null;
                
                closeSettingsModal();
                alert(UI_TEXT[state.idioma].alert_import_success);
                location.reload();

            } catch (error) {
                console.error("Erro durante a importa√ß√£o:", error);
                alert(UI_TEXT[state.idioma].alert_import_error);
            }
        };
        reader.readAsText(file);
    };

    document.body.appendChild(fileInput);
    fileInput.click();
    fileInput.remove();
  });


  // --- L√ìGICA DO NOVO MODAL DE PRIVACIDADE ---
  const privacyModal = document.getElementById('privacyModal');
  const privacyModalContent = document.getElementById('privacyModalContent');

  function openPrivacyModal() {
      const texts = UI_TEXT[state.idioma];
      renderPrivacyContent(texts); // Renderiza o conte√∫do antes de abrir
      privacyModal.classList.remove('hidden');
      setTimeout(() => {
          privacyModal.style.opacity = '1';
          privacyModalContent.classList.remove('scale-95');
      }, 10);
      if(window.lucide) window.lucide.createIcons();
  }

  function closePrivacyModal() {
      privacyModal.style.opacity = '0';
      privacyModalContent.classList.add('scale-95');
      setTimeout(() => privacyModal.classList.add('hidden'), 300);
  }
  
  // RENDERIZA O CONTE√öDO DE PRIVACIDADE
  function renderPrivacyContent(texts) {
      document.getElementById('privacyModalTitle').innerText = texts.privacy_title;
      document.getElementById('privacyContentArea').innerHTML = `
          <p class="text-base font-medium">${texts.privacy_p1}</p>
          <p class="text-sm italic text-gray-500 dark:text-gray-400 border-t pt-4 border-gray-200 dark:border-gray-700">
              <i data-lucide="alert-triangle" class="lucide w-4 h-4 inline mr-1 text-yellow-500"></i>
              ${texts.privacy_title.replace(' (LGPD)', '')}: ${texts.privacy_p1.includes('JSON') ? 'O √∫nico momento em que h√° transfer√™ncia de dados √© quando VOC√ä usa a fun√ß√£o "Exportar Progresso JSON" para fazer um backup manual. Fora disso, nada sai do seu dispositivo.' : 'Local storage only.'}
          </p>
      `;
  }

  document.getElementById('fecharPrivacyModal').addEventListener('click', closePrivacyModal);
  privacyModal.addEventListener('click', (e) => {
      if(e.target.id === 'privacyModal') closePrivacyModal();
  });

  // Handler para o link 'Privacidade (LGPD)' (linkPrivacidade) - Substitui o alert
  document.getElementById('linkPrivacidade').addEventListener('click', (e) => {
      e.preventDefault();
      openPrivacyModal(); // Abre o novo modal
  });


  // --- L√ìGICA DO MODAL DE GLOSS√ÅRIO (MODIFICADA PARA TRADU√á√ÉO) ---
  const glossaryModal = document.getElementById('glossaryModal');
  const glossaryModalContent = document.getElementById('glossaryModalContent');
  const glossaryContentArea = document.getElementById('glossaryContentArea');

  function openGlossaryModal() {
      const texts = UI_TEXT[state.idioma];
      renderGlossaryContent(texts); // Renderiza o conte√∫do antes de abrir
      glossaryModal.classList.remove('hidden');
      setTimeout(() => {
          glossaryModal.style.opacity = '1';
          glossaryModalContent.classList.remove('scale-95');
      }, 10);
      if(window.lucide) window.lucide.createIcons();
  }

  function closeGlossaryModal() {
      glossaryModal.style.opacity = '0';
      glossaryModalContent.classList.add('scale-95');
      setTimeout(() => glossaryModal.classList.add('hidden'), 300);
  }
  
  // RENDERIZA O CONTE√öDO DO GLOSS√ÅRIO
  function renderGlossaryContent(texts) {
      document.getElementById('glossaryModalTitle').innerText = texts.glossary_title;
      
      let html = '';
      
      // Se√ß√£o Funcionalidades Principais
      html += `<h4 class="text-lg font-bold text-primary-500">${texts.glossary_features_title}</h4>
              <ul class="space-y-3">`;
      texts.glossary_features.forEach(item => {
          // Permite √≠cones lucide ou emojis
          const iconHtml = item.icon.length > 3 && item.icon.includes(' ') === false ? 
                            `<i data-lucide="${item.icon}" class="lucide w-5 h-5 text-primary-500"></i>` : 
                            `<span class="text-xl">${item.icon}</span>`;
                            
          html += `<li class="flex items-start">
                      <span class="mr-3 mt-1 flex-shrink-0">${iconHtml}</span>
                      <p>${item.text}</p>
                  </li>`;
      });
      html += `</ul>`;
      
      // Se√ß√£o √çcones nos Dias de Leitura
      html += `<h4 class="text-lg font-bold text-primary-500 pt-4 border-t border-gray-200 dark:border-gray-700">${texts.glossary_icons_title}</h4>
              <ul class="space-y-3">`;
      texts.glossary_icons.forEach(item => {
          // Permite √≠cones lucide ou emojis
          const isStar = item.icon === 'star';
          const iconHtml = item.icon.length > 3 && item.icon.includes(' ') === false ? 
                            `<i data-lucide="${item.icon}" class="lucide w-5 h-5 ${isStar ? 'text-primary-500 fill-primary-500/50' : 'text-red-500'}"></i>` : 
                            `<span class="text-xl">${item.icon}</span>`;
                            
          html += `<li class="flex items-start">
                      <span class="mr-3 mt-1 flex-shrink-0">${iconHtml}</span>
                      <p>${item.text}</p>
                  </li>`;
      });
      html += `</ul>`;

      glossaryContentArea.innerHTML = html;
  }

  document.getElementById('fecharGlossaryModal').addEventListener('click', closeGlossaryModal);
  glossaryModal.addEventListener('click', (e) => {
      if(e.target.id === 'glossaryModal') closeGlossaryModal();
  });

  // Handler para o bot√£o 'Abrir Gloss√°rio' (btnAbrirGlossario)
  document.getElementById('btnAbrirGlossario').addEventListener('click', openGlossaryModal);


  // ---------- INITIALIZATION ----------
  // Fun√ß√£o de inicializa√ß√£o
  function initialize() {
    // 1. Aplica o tema
    const root = document.documentElement;
    const themeStatusText = document.getElementById('themeStatusText'); 

    function applyTheme(isDark) {
        root.classList.toggle('dark', !!isDark);
        if (isDark) {
            localStorage.setItem('bib_theme', 'dark');
            if (themeStatusText) themeStatusText.innerText = 'üåû'; 
        } else {
            localStorage.removeItem('bib_theme');
            if (themeStatusText) themeStatusText.innerText = 'üåô';
        }
    }

    function toggleTheme() {
        const nowDark = root.classList.contains('dark');
        applyTheme(!nowDark);
    }
    
    const storedDark = localStorage.getItem('bib_theme') === 'dark';
    applyTheme(storedDark);
    
    // Adiciona listener ao bot√£o de tema
    const btnTema = document.getElementById('btnTema');
    if(btnTema) btnTema.addEventListener('click', toggleTheme);
    
    // 2. Define o idioma e atualiza a UI
    updateIdiomaDisplay(state.idioma);

    // 3. Exibe a p√°gina correta
    if (state.planoId) {
      showPage('paginaPlano');
    } else {
      showPage('paginaSelecao');
    }
  }

  // Executa a inicializa√ß√£o ap√≥s o DOM carregar
  document.addEventListener('DOMContentLoaded', initialize);

  </script>
</body>
</html>